<project_root>
  <file path="README.md">
<![CDATA[
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.

]]>
  </file>
  <file path="app/admin/page.tsx">
<![CDATA[
'use client';

import { useState } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { ArrowLeft, Send, Sparkles, UserPlus, CheckCircle2, Loader2 } from 'lucide-react';
import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, AnimatePresence } from 'framer-motion';

// âš ï¸ å¡«å…¥ä½ çš„åˆçº¦åœ°å€
const CONTRACT_ADDRESS = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 

const contractAbi = [
  {
    inputs: [{ name: "to", type: "address" }],
    name: "mint",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
] as const;

export default function AdminPage() {
  const { isConnected } = useAccount();
  const [targetAddress, setTargetAddress] = useState('');
  
  // è®°å½•æœ€è¿‘ä¸€æ¬¡ç©ºæŠ•æˆåŠŸçš„åœ°å€
  const [lastAirdrop, setLastAirdrop] = useState<string | null>(null);

  const { data: hash, writeContract, isPending } = useWriteContract();
  
  const { isLoading: isConfirming, isSuccess: isConfirmed } = 
    useWaitForTransactionReceipt({ hash });

  const handleAirdrop = (e: React.FormEvent) => {
    e.preventDefault();
    // ç®€å•çš„æ ¡éªŒ
    if (!targetAddress.startsWith('0x') || targetAddress.length !== 42) {
      alert("è¯·è¾“å…¥æ­£ç¡®çš„ä»¥å¤ªåŠåœ°å€");
      return;
    }

    writeContract({
      // ğŸ‘‡ ä¿®å¤ç‚¹ 1ï¼šå¼ºåˆ¶è½¬æ¢åˆçº¦åœ°å€ç±»å‹
      address: CONTRACT_ADDRESS as `0x${string}`, 
      abi: contractAbi,
      functionName: 'mint',
      // ğŸ‘‡ ä¿®å¤ç‚¹ 2ï¼šå¼ºåˆ¶è½¬æ¢ç›®æ ‡åœ°å€ç±»å‹
      args: [targetAddress as `0x${string}`], 
    });
  };

  // äº¤æ˜“æˆåŠŸåæ¸…ç©ºè¾“å…¥æ¡†
  if (isConfirmed && targetAddress && lastAirdrop !== targetAddress) {
    setLastAirdrop(targetAddress);
    setTargetAddress('');
  }

  return (
    <div className="min-h-screen bg-slate-950 text-white p-6 relative overflow-hidden flex flex-col items-center">
      
      {/* èƒŒæ™¯è£…é¥° */}
      <div className="absolute top-0 left-0 w-full h-[300px] bg-gradient-to-b from-blue-900/20 to-transparent pointer-events-none" />

      {/* é¡¶éƒ¨å¯¼èˆª */}
      <nav className="w-full max-w-4xl flex justify-between items-center mb-12 z-10">
        <Link href="/dashboard" className="text-slate-400 hover:text-white flex items-center gap-2 transition-colors">
          <ArrowLeft className="w-4 h-4" /> è¿”å›æ§åˆ¶å°
        </Link>
        <ConnectButton />
      </nav>

      <div className="w-full max-w-2xl z-10">
        <div className="text-center mb-10">
          <h1 className="text-4xl font-bold mb-2 flex items-center justify-center gap-3">
            <Sparkles className="text-yellow-400 fill-yellow-400" />
            é­”æ³•ç©ºæŠ•æ§åˆ¶å°
          </h1>
          <p className="text-slate-400">
            ä½œä¸ºå…¬ä¼šä¼šé•¿ï¼Œä½ å¯ä»¥ç›´æ¥å‘æ–°æˆå‘˜å‘æ”¾ Kiki NFTã€‚
          </p>
        </div>

        <Card className="bg-slate-900/80 border-slate-800 backdrop-blur-xl shadow-2xl">
          <CardHeader className="border-b border-white/5 pb-6">
            <CardTitle className="text-xl text-blue-400 flex items-center gap-2">
              <UserPlus className="w-5 h-5" /> å®šå‘å‘æ”¾ (Airdrop)
            </CardTitle>
          </CardHeader>
          <CardContent className="pt-6">
            
            <form onSubmit={handleAirdrop} className="space-y-6">
              <div className="space-y-2">
                <Label htmlFor="address" className="text-slate-300">æ¥æ”¶è€…é’±åŒ…åœ°å€ (0x...)</Label>
                <div className="relative">
                  <Input 
                    id="address" 
                    placeholder="ä¾‹å¦‚: 0x123...abc" 
                    value={targetAddress}
                    onChange={(e) => setTargetAddress(e.target.value)}
                    className="bg-black/40 border-slate-700 text-white h-12 font-mono pl-4 pr-12 focus:border-blue-500/50"
                    disabled={isPending || isConfirming}
                  />
                  <div className="absolute right-4 top-3 text-slate-500">
                    <Send className="w-5 h-5" />
                  </div>
                </div>
                <p className="text-xs text-slate-500">
                  * å¯¹æ–¹æ— éœ€æ”¯ä»˜ Gas è´¹ï¼Œè´¹ç”¨ç”±ä½ ï¼ˆä¼šé•¿ï¼‰æ‰¿æ‹…ã€‚
                </p>
              </div>

              {!isConnected ? (
                <div className="bg-slate-800/50 p-4 rounded-lg text-center text-slate-400 text-sm">
                  è¯·å…ˆè¿æ¥ç®¡ç†å‘˜é’±åŒ…
                </div>
              ) : (
                <Button 
                  type="submit" 
                  disabled={!targetAddress || isPending || isConfirming}
                  className="w-full h-12 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 font-bold text-lg"
                >
                  {isPending ? (
                    <><Loader2 className="mr-2 animate-spin" /> è¯·æ±‚ç­¾å...</>
                  ) : isConfirming ? (
                    <><Loader2 className="mr-2 animate-spin" /> æ­£åœ¨ç©ºæŠ•...</>
                  ) : (
                    <>ğŸš€ å‘é€ç©ºæŠ•</>
                  )}
                </Button>
              )}
            </form>

            <AnimatePresence>
              {isConfirmed && lastAirdrop && (
                <motion.div 
                  initial={{ opacity: 0, height: 0 }}
                  animate={{ opacity: 1, height: 'auto' }}
                  className="mt-6"
                >
                  <div className="bg-green-500/10 border border-green-500/20 rounded-xl p-4 flex items-start gap-4">
                    <div className="bg-green-500/20 p-2 rounded-full">
                      <CheckCircle2 className="w-5 h-5 text-green-400" />
                    </div>
                    <div>
                      <h4 className="font-bold text-green-400">ç©ºæŠ•å‘é€æˆåŠŸï¼</h4>
                      <p className="text-sm text-slate-400 mt-1 break-all">
                        å·²å‘ <span className="text-slate-200 font-mono">{lastAirdrop}</span> å‘é€äº† 1 æš Kiki NFTã€‚
                      </p>
                    </div>
                  </div>
                </motion.div>
              )}
            </AnimatePresence>

          </CardContent>
        </Card>
      </div>
    </div>
  );
}
]]>
  </file>
  <file path="app/api/claim-kiki/route.ts">
<![CDATA[
import { NextResponse } from 'next/server';
import { supabase } from '@/lib/supabaseClient';
import { ethers } from 'ethers';

// 1. è·å–é…ç½®
const TOKEN_CONTRACT_ADDRESS = '0x83F7A90486697B8B881319FbADaabF337fE2c60c'; // KIKI ä»£å¸åœ°å€
const ADMIN_PRIVATE_KEY = process.env.ADMIN_PRIVATE_KEY;
const RPC_URL = `https://eth-sepolia.g.alchemy.com/v2/${process.env.NEXT_PUBLIC_ALCHEMY_API_KEY}`;

const TOKEN_ABI = [
  "function mint(address to, uint256 amount) public"
];

export async function POST(request: Request) {
  try {
    // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥ç¯å¢ƒå˜é‡æ˜¯å¦è¯»å–æˆåŠŸ
    if (!ADMIN_PRIVATE_KEY) {
      console.error("âŒ ä¸¥é‡é”™è¯¯ï¼šæœåŠ¡ç«¯æœªæ£€æµ‹åˆ° ADMIN_PRIVATE_KEY");
      return NextResponse.json({ error: 'æœåŠ¡ç«¯é…ç½®é”™è¯¯ï¼šç¼ºå°‘ç®¡ç†å‘˜ç§é’¥ï¼Œè¯·æ£€æŸ¥ .env.local å¹¶é‡å¯æœåŠ¡å™¨' }, { status: 500 });
    }

    const body = await request.json();
    const { recordId, userAddress } = body;

    // ğŸ” è°ƒè¯•ï¼šæ£€æŸ¥å‰ç«¯å‚æ•°
    if (!recordId || !userAddress) {
      console.error(`âŒ å‚æ•°ç¼ºå¤± - recordId: ${recordId}, userAddress: ${userAddress}`);
      return NextResponse.json({ error: 'è¯·æ±‚å‚æ•°é”™è¯¯ï¼šç¼ºå°‘ recordId æˆ– userAddress' }, { status: 400 });
    }

    console.log(`ğŸš€ å¼€å§‹å¤„ç†æç°è¯·æ±‚: ç”¨æˆ· ${userAddress}, è®°å½•ID ${recordId}`);

    // 1. æŸ¥åº“
    const { data: record, error } = await supabase
      .from('staking')
      .select('*')
      .eq('id', recordId)
      .eq('wallet_address', userAddress)
      .eq('status', 'active')
      .single();

    if (error || !record) {
      return NextResponse.json({ error: 'æœªæ‰¾åˆ°æœ‰æ•ˆçš„è´¨æŠ¼è®°å½•æˆ–å·²é¢†å–' }, { status: 404 });
    }

    // 2. ç®—é’±
    const startTime = new Date(record.start_time).getTime();
    const now = new Date().getTime();
    const secondsElapsed = Math.floor((now - startTime) / 1000);
    const rewardAmount = secondsElapsed * 0.01;

    if (rewardAmount <= 0) {
      return NextResponse.json({ error: 'æš‚æ— æ”¶ç›Šå¯é¢†å–' }, { status: 400 });
    }

    // 3. å‘é’±
    const provider = new ethers.JsonRpcProvider(RPC_URL);
    const wallet = new ethers.Wallet(ADMIN_PRIVATE_KEY, provider);
    const contract = new ethers.Contract(TOKEN_CONTRACT_ADDRESS, TOKEN_ABI, wallet);

    // å°† 0.01 è¿™ç§å°æ•°è½¬ä¸º wei (18ä½ç²¾åº¦)
    // âš ï¸ æ³¨æ„ï¼šå¦‚æœæ•°å­—å¤ªå°ï¼ŒtoFixed å¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œè¿™é‡Œåšä¸€ä¸ªå®‰å…¨è½¬æ¢
    const amountStr = rewardAmount.toFixed(18); 
    const amountWei = ethers.parseUnits(amountStr, 18);

    console.log(`ğŸ’¸ æ­£åœ¨é“¾ä¸Šè½¬è´¦... æ•°é‡: ${amountStr}`);
    
    // å‘èµ·äº¤æ˜“
    // å¦‚æœè¿™é‡ŒæŠ¥é”™ï¼Œé€šå¸¸æ˜¯ç®¡ç†å‘˜æ²¡é’±äº†ï¼Œæˆ–è€… RPC ç½‘ç»œæ³¢åŠ¨
    const tx = await contract.mint(userAddress, amountWei);
    console.log(`âœ… äº¤æ˜“å·²å‘é€: ${tx.hash}`);
    
    await tx.wait(); // ç­‰å¾…ä¸Šé“¾

    // 4. æ”¹çŠ¶æ€
    await supabase
      .from('staking')
      .update({ status: 'finished', earned_points: Math.floor(rewardAmount) })
      .eq('id', recordId);

    return NextResponse.json({ 
      success: true, 
      txHash: tx.hash, 
      amount: rewardAmount 
    });

  } catch (error: any) {
    console.error('API å†…éƒ¨é”™è¯¯:', error);
    return NextResponse.json({ error: `å¤„ç†å¤±è´¥: ${error.message}` }, { status: 500 });
  }
}
]]>
  </file>
  <file path="app/api/claim-reward/route.ts">
<![CDATA[
import { NextResponse } from 'next/server';
import { createWalletClient, http, parseEther } from 'viem';
import { privateKeyToAccount } from 'viem/accounts';
import { sepolia } from 'viem/chains';

const TOKEN_CONTRACT_ADDRESS = '0x83F7A90486697B8B881319FbADaabF337fE2c60c';

const tokenAbi = [
  {
    inputs: [{ name: "to", type: "address" }, { name: "amount", type: "uint256" }],
    name: "mint",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
] as const;

// å¼ºåˆ¶åŠ¨æ€è¿è¡Œï¼Œé¿å… Vercel ç¼“å­˜ API ç»“æœ
export const dynamic = 'force-dynamic';
export const maxDuration = 60; // å»¶é•¿è¶…æ—¶æ—¶é—´

export async function POST(request: Request) {
  try {
    // 1. æ£€æŸ¥ç¯å¢ƒå˜é‡
    const privateKey = process.env.ADMIN_PRIVATE_KEY;
    const alchemyKey = process.env.NEXT_PUBLIC_ALCHEMY_API_KEY;

    if (!privateKey) {
      return NextResponse.json({ error: 'Config Error: Missing ADMIN_PRIVATE_KEY' }, { status: 500 });
    }
    if (!alchemyKey) {
      return NextResponse.json({ error: 'Config Error: Missing NEXT_PUBLIC_ALCHEMY_API_KEY' }, { status: 500 });
    }

    // 2. è§£æè¯·æ±‚
    let body;
    try {
      body = await request.json();
    } catch (e) {
      return NextResponse.json({ error: 'Invalid JSON' }, { status: 400 });
    }
    
    const { address, amount } = body;
    if (!address || !amount) {
      return NextResponse.json({ error: 'Missing address or amount' }, { status: 400 });
    }

    // 3. é…ç½®ä¸“ç”¨ RPC (å…³é”®ä¿®å¤ç‚¹ ğŸ› ï¸)
    // ä½¿ç”¨ä½ çš„ Alchemy Key æ‹¼æ¥å‡ºä¸“ç”¨èŠ‚ç‚¹åœ°å€ï¼Œä¸å†å’Œåˆ«äººæŒ¤å…¬å…±èŠ‚ç‚¹
    const rpcUrl = `https://eth-sepolia.g.alchemy.com/v2/${alchemyKey}`;

    const formattedKey = privateKey.startsWith('0x') ? privateKey : `0x${privateKey}`;
    const account = privateKeyToAccount(formattedKey as `0x${string}`);

    const client = createWalletClient({
      account,
      chain: sepolia,
      transport: http(rpcUrl) // âœ… ä¼ å…¥ä¸“ç”¨ URL
    });

    console.log(`[API] Minting ${amount} KIKI to ${address} via Alchemy...`);

    // 4. å‘é€äº¤æ˜“
    const amountInWei = parseEther(amount.toString());
    
    const hash = await client.writeContract({
      address: TOKEN_CONTRACT_ADDRESS,
      abi: tokenAbi,
      functionName: 'mint',
      args: [address, amountInWei],
    });

    console.log(`[API] Success: ${hash}`);
    return NextResponse.json({ success: true, txHash: hash });

  } catch (error: any) {
    console.error("[API Error]", error);
    // è¿”å›å…·ä½“é”™è¯¯ä¿¡æ¯ç»™å‰ç«¯ï¼Œæ–¹ä¾¿è°ƒè¯•
    return NextResponse.json(
      { error: error.details || error.shortMessage || error.message || 'Server Error' },
      { status: 500 }
    );
  }
}
]]>
  </file>
  <file path="app/dashboard/page.tsx">
<![CDATA[
'use client';

import { useAccount, useBalance, useBlockNumber } from 'wagmi';
import { CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { 
  Loader2, 
  Wallet, 
  ArrowLeft, 
  Rocket, 
  ShieldCheck,
  Database,
  ArrowRight,
  Wifi,
  Layers,
  Box,
  Home,
  TrendingUp, // DeFi å›¾æ ‡
  Send        // è½¬è´¦ å›¾æ ‡
} from 'lucide-react';
import Link from 'next/link';
import { motion } from 'framer-motion';
import { ConnectButton } from '@rainbow-me/rainbowkit';

// å¼•å…¥ç»„ä»¶
import { NftGallery } from '@/components/NftGallery';
import { SpotlightCard } from '@/components/ui/spotlight-card';
import TokenBalance from '@/components/TokenBalance'; 
import ActivityLog from '@/components/ActivityLog'; 

// æ»šåŠ¨è¿›åœºåŠ¨ç”»åŒ…è£…å™¨
const ScrollSection = ({ children, delay = 0 }: { children: React.ReactNode, delay?: number }) => {
  return (
    <motion.div
      initial={{ opacity: 0, y: 50, filter: 'blur(10px)' }}
      whileInView={{ opacity: 1, y: 0, filter: 'blur(0px)' }}
      viewport={{ once: true, margin: "-100px" }} 
      transition={{ duration: 0.8, ease: [0.2, 0.65, 0.3, 0.9], delay }} 
      className="w-full"
    >
      {children}
    </motion.div>
  );
};

export default function Dashboard() {
  const { isConnected, chain, address } = useAccount();
  const { data: ethBalance, isLoading: isEthLoading } = useBalance({ address });
  const { data: blockNumber } = useBlockNumber({ watch: true });

  // --- 1. æœªè¿æ¥çŠ¶æ€è§†å›¾ ---
  if (!isConnected) {
    return (
      <div className="min-h-screen bg-[#0B0C10] flex flex-col items-center justify-center text-slate-300 p-4 font-sans">
        <div className="text-center space-y-6 max-w-md">
          <div className="w-20 h-20 bg-white/5 rounded-3xl flex items-center justify-center mx-auto border border-white/10 shadow-2xl shadow-blue-900/20">
            <Wallet className="w-10 h-10 text-slate-500" />
          </div>
          <h1 className="text-4xl font-bold text-white tracking-tight">Access Dashboard</h1>
          <p className="text-slate-500 leading-relaxed text-lg">
            Connect your wallet to view your asset portfolio and interact with the Kiki Protocol ecosystem.
          </p>
          <div className="flex justify-center">
            <ConnectButton />
          </div>
          <Link href="/">
            <Button variant="link" className="text-slate-500 hover:text-white transition-colors mt-4">
              <ArrowLeft className="mr-2 h-4 w-4" /> Return to Protocol Home
            </Button>
          </Link>
        </div>
      </div>
    );
  }

  // --- 2. å·²è¿æ¥çŠ¶æ€è§†å›¾ ---
  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-blue-500/30 font-sans overflow-x-hidden">
      
      {/* èƒŒæ™¯åº•å™ª */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-20%] right-[-10%] w-[800px] h-[800px] bg-blue-900/5 rounded-full blur-[120px] mix-blend-screen animate-pulse duration-[10s]" />
        <div className="absolute bottom-[10%] left-[-10%] w-[600px] h-[600px] bg-purple-900/5 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff02_1px,transparent_1px),linear-gradient(to_bottom,#ffffff02_1px,transparent_1px)] bg-[size:60px_60px]"></div>
      </div>

      <div className="relative z-10 max-w-5xl mx-auto px-6 py-12 md:py-20">
        
        {/* --- Header (Sticky & Glassy) --- */}
        <header className="sticky top-4 z-50 flex items-center justify-between bg-[#0B0C10]/80 backdrop-blur-xl border border-white/5 p-3 rounded-2xl mb-20 shadow-2xl transition-all">
          <div className="flex items-center gap-4">
            <Link href="/" className="group">
              <div className="flex items-center justify-center w-10 h-10 rounded-xl bg-white/5 border border-white/5 group-hover:bg-white/10 group-hover:border-white/20 transition-all">
                <Home className="w-5 h-5 text-slate-400 group-hover:text-white transition-colors" />
              </div>
            </Link>
            <div className="h-6 w-px bg-white/10 hidden sm:block"></div>
            <div className="flex items-center gap-3">
              <div className="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-600/20">
                 <Box className="w-6 h-6 text-white" />
              </div>
              <div className="flex flex-col">
                 <span className="text-sm font-bold text-white leading-tight">Dashboard</span>
                 <span className="text-[10px] text-slate-500 font-mono uppercase">V2.1.0</span>
              </div>
            </div>
          </div>
          <div className="flex items-center gap-4">
             <TokenBalance />
             <div className="h-6 w-px bg-white/10 mx-2 hidden md:block"></div>
             <ConnectButton showBalance={false} accountStatus="avatar" />
          </div>
        </header>

        <div className="space-y-24">
          
          {/* --- Section 1: Network & Assets Overview --- */}
          <section className="space-y-8">
            <ScrollSection>
              <h2 className="text-3xl md:text-5xl font-bold text-white mb-8 tracking-tight">
                Network & <br /> 
                <span className="text-slate-500">Asset Overview</span>
              </h2>
            </ScrollSection>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
              {/* Network Status */}
              <ScrollSection delay={0.1}>
                <SpotlightCard className="h-full min-h-[240px]" spotlightColor="rgba(34, 197, 94, 0.15)">
                  <CardContent className="p-8 flex flex-col justify-between h-full">
                    <div className="flex justify-between items-start">
                      <div className="p-3 bg-green-500/10 rounded-xl border border-green-500/20">
                        <svg className="w-8 h-8 text-green-500" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <path d="M16 2L2 25L16 30L30 25L16 2Z" fill="currentColor" fillOpacity="0.2"/>
                          <path d="M16 2L16 30L30 25L16 2Z" fill="currentColor" fillOpacity="0.4"/>
                          <path d="M16 22L2 25L16 30L16 22Z" fill="currentColor"/>
                          <path d="M16 2V12L30 25L16 2Z" fill="currentColor" fillOpacity="0.6"/>
                        </svg>
                      </div>
                      <div className="flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/10 border border-green-500/20">
                        <span className="relative flex h-2 w-2">
                          <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                          <span className="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                        </span>
                        <span className="text-xs font-bold text-green-400 uppercase tracking-wider">Online</span>
                      </div>
                    </div>
                    <div>
                      <h3 className="text-2xl font-bold text-white mb-1">{chain?.name || 'Unknown Network'}</h3>
                      <div className="space-y-1">
                         <p className="text-sm text-slate-500 font-mono">ID: {chain?.id}</p>
                         <div className="flex items-center gap-2 text-sm text-slate-500 font-mono">
                           <Wifi className="w-4 h-4" /> 
                           Block: <span className="text-slate-300">{blockNumber?.toString() || 'Syncing...'}</span>
                         </div>
                      </div>
                    </div>
                  </CardContent>
                </SpotlightCard>
              </ScrollSection>

              {/* Wallet Assets (ETH) */}
              <ScrollSection delay={0.2}>
                <SpotlightCard className="h-full min-h-[240px]" spotlightColor="rgba(59, 130, 246, 0.15)">
                  <CardContent className="p-8 flex flex-col justify-between h-full">
                    <div className="flex items-center gap-3 mb-6">
                      <Wallet className="w-5 h-5 text-blue-500" />
                      <span className="text-xs font-mono font-bold text-slate-500 uppercase tracking-widest">Native Balance</span>
                    </div>
                    <div className="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:bg-white/10 transition-colors my-auto">
                      <div className="flex items-center gap-4">
                        <div className="w-12 h-12 bg-slate-700 rounded-full flex items-center justify-center shadow-lg">
                          <svg className="w-6 h-6 text-white" viewBox="0 0 24 24" fill="currentColor"><path d="M11.944 17.97L4.58 13.62 11.943 24l7.37-10.38-7.372 4.35h.003zM12.056 0L4.69 12.223l7.365 4.354 7.365-4.35L12.056 0z"/></svg>
                        </div>
                        <div>
                          <div className="text-white font-bold text-lg">Ethereum</div>
                          <div className="text-slate-500 text-xs font-mono">Sepolia Testnet</div>
                        </div>
                      </div>
                      <div className="text-right">
                          <div className="text-white font-bold font-mono text-xl">
                            {isEthLoading ? <Loader2 className="w-5 h-5 animate-spin" /> : parseFloat(ethBalance?.formatted || '0').toFixed(4)}
                          </div>
                          <div className="text-slate-500 text-sm font-bold">{ethBalance?.symbol}</div>
                      </div>
                    </div>
                    <div></div>
                  </CardContent>
                </SpotlightCard>
              </ScrollSection>
            </div>
          </section>

          {/* --- Section 2: Protocol Actions --- */}
          <section className="space-y-8">
            <ScrollSection>
              <div className="border-t border-white/5 pt-12">
                <h2 className="text-3xl md:text-5xl font-bold text-white mb-4 tracking-tight">
                  Protocol <span className="text-slate-500">Actions</span>
                </h2>
                <p className="text-slate-400 max-w-2xl text-lg">
                  Interact with the core smart contracts. Mint assets, earn yield, and trade liquidity.
                </p>
              </div>
            </ScrollSection>
            
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* 1. Mint */}
              <ScrollSection delay={0.1}>
                <Link href="/mint" className="block h-full group">
                  <SpotlightCard className="h-full hover:bg-blue-900/5 transition-all duration-500" spotlightColor="rgba(59, 130, 246, 0.3)">
                    <CardContent className="p-10 flex flex-col items-start justify-between h-full min-h-[300px]">
                      <div className="w-14 h-14 bg-blue-500/10 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-500">
                        <Rocket className="w-7 h-7 text-blue-400" />
                      </div>
                      <div className="space-y-2 mb-8">
                        <h3 className="text-3xl font-bold text-white">Genesis Mint</h3>
                        <p className="text-slate-400 leading-relaxed">
                           Participate in the IAO. Burn $KIKI to generate unique NFT assets.
                        </p>
                      </div>
                      <div className="mt-auto flex items-center gap-3 text-sm font-bold text-blue-400 group-hover:translate-x-2 transition-transform">
                        START MINTING <ArrowRight className="w-4 h-4" />
                      </div>
                    </CardContent>
                  </SpotlightCard>
                </Link>
              </ScrollSection>

              {/* 2. Stake */}
              <ScrollSection delay={0.2}>
                <Link href="/training" className="block h-full group">
                  <SpotlightCard className="h-full hover:bg-green-900/5 transition-all duration-500" spotlightColor="rgba(34, 197, 94, 0.3)">
                    <CardContent className="p-10 flex flex-col items-start justify-between h-full min-h-[300px]">
                      <div className="w-14 h-14 bg-green-500/10 rounded-2xl flex items-center justify-center mb-6 group-hover:scale-110 transition-transform duration-500">
                        <Database className="w-7 h-7 text-green-400" />
                      </div>
                      <div className="space-y-2 mb-8">
                        <h3 className="text-3xl font-bold text-white">Yield Farming</h3>
                        <p className="text-slate-400 leading-relaxed">
                           Stake your assets to provide liquidity and earn passive income (0.01 KIKI/s).
                        </p>
                      </div>
                      <div className="mt-auto flex items-center gap-3 text-sm font-bold text-green-400 group-hover:translate-x-2 transition-transform">
                        MANAGE STAKE <ArrowRight className="w-4 h-4" />
                      </div>
                    </CardContent>
                  </SpotlightCard>
                </Link>
              </ScrollSection>
              
              {/* --- Utilities Row: 3åˆ—å¸ƒå±€ (DeFi, Transfer, Secret) --- */}
              <div className="md:col-span-2 grid grid-cols-1 md:grid-cols-3 gap-6">
                 
                 {/* 3. DeFi Hub (æ–°å¢) */}
                 <ScrollSection delay={0.3}>
                   <Link href="/defi" className="block group h-full">
                     <SpotlightCard className="hover:bg-indigo-900/5 transition-colors h-full" spotlightColor="rgba(99, 102, 241, 0.25)">
                       <CardContent className="p-6 flex flex-col gap-4 h-full">
                         <div className="w-12 h-12 bg-indigo-500/10 rounded-xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                           <TrendingUp className="w-6 h-6 text-indigo-400" />
                         </div>
                         <div>
                           <h4 className="text-lg font-bold text-white group-hover:text-indigo-300 transition-colors">DeFi Hub</h4>
                           <p className="text-xs text-slate-500">Swap KIKI/ETH & Liquidity.</p>
                         </div>
                       </CardContent>
                     </SpotlightCard>
                   </Link>
                 </ScrollSection>

                 {/* 4. Transfer (æ¢å¤) */}
                 <ScrollSection delay={0.4}>
                   <Link href="/transfer" className="block group h-full">
                     <SpotlightCard className="hover:bg-purple-900/5 transition-colors h-full" spotlightColor="rgba(168, 85, 247, 0.25)">
                       <CardContent className="p-6 flex flex-col gap-4 h-full">
                         <div className="w-12 h-12 bg-purple-500/10 rounded-xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                           <Send className="w-6 h-6 text-purple-400" />
                         </div>
                         <div>
                           <h4 className="text-lg font-bold text-white group-hover:text-purple-300 transition-colors">Transfer</h4>
                           <p className="text-xs text-slate-500">Send assets securely.</p>
                         </div>
                       </CardContent>
                     </SpotlightCard>
                   </Link>
                 </ScrollSection>

                 {/* 5. Community (Secret) */}
                 <ScrollSection delay={0.5}>
                   <Link href="/secret" className="block group h-full">
                     <SpotlightCard className="hover:bg-yellow-900/5 transition-colors h-full" spotlightColor="rgba(234, 179, 8, 0.25)">
                       <CardContent className="p-6 flex flex-col gap-4 h-full">
                         <div className="w-12 h-12 bg-yellow-500/10 rounded-xl flex items-center justify-center shrink-0 group-hover:scale-110 transition-transform">
                           <ShieldCheck className="w-6 h-6 text-yellow-400" />
                         </div>
                         <div>
                           <h4 className="text-lg font-bold text-white group-hover:text-yellow-300 transition-colors">Community</h4>
                           <p className="text-xs text-slate-500">Governance & Chat.</p>
                         </div>
                       </CardContent>
                     </SpotlightCard>
                   </Link>
                 </ScrollSection>
              </div>

            </div>
          </section>

          {/* --- Section 3: Portfolio (Gallery) --- */}
          <section className="space-y-8">
            <ScrollSection>
               <div className="border-t border-white/5 pt-12 flex items-end justify-between mb-8">
                 <div>
                    <h2 className="text-3xl md:text-5xl font-bold text-white tracking-tight">
                      Asset <span className="text-slate-500">Portfolio</span>
                    </h2>
                 </div>
                 <div className="hidden md:flex items-center gap-2 text-xs font-mono text-slate-500 uppercase">
                    <Layers className="w-4 h-4" />
                    <span>ERC-721 Standard</span>
                 </div>
               </div>
            </ScrollSection>

            <ScrollSection delay={0.2}>
              <div className="bg-[#12141a]/30 border border-white/5 rounded-3xl p-8 min-h-[400px] backdrop-blur-sm">
                 <NftGallery />
              </div>
            </ScrollSection>
          </section>

          {/* --- Section 4: Transaction History --- */}
          <section className="space-y-8 pb-12">
            <ScrollSection>
               <div className="border-t border-white/5 pt-12 mb-8">
                  <h2 className="text-3xl md:text-5xl font-bold text-white tracking-tight">
                    Transaction <span className="text-slate-500">History</span>
                  </h2>
               </div>
            </ScrollSection>

            <ScrollSection delay={0.2}>
              <ActivityLog />
            </ScrollSection>
          </section>

          {/* --- Footer Admin Link --- */}
          <div className="flex justify-center pb-10 opacity-50 hover:opacity-100 transition-opacity">
             <Link href="/admin">
               <Button variant="link" className="text-slate-600 font-mono text-xs uppercase tracking-widest">
                 /// Admin Console Access ///
               </Button>
             </Link>
          </div>

        </div>
      </div>
    </div>
  );
}
]]>
  </file>
  <file path="app/defi/page.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract } from 'wagmi';
import { parseEther, formatEther } from 'viem';
import { Button } from '@/components/ui/button';
import { ArrowLeft, ArrowDown, Settings, Loader2, TrendingUp, RefreshCw, Plus, ArrowRightLeft, Droplets, Database, Wallet, ArrowRight } from 'lucide-react';
import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import TokenBalance from '@/components/TokenBalance';
import { motion, AnimatePresence } from 'framer-motion';

// --- æ ¸å¿ƒé…ç½® ---
const KIKI_ADDRESS = '0x83f7a90486697b8b881319fbadaabf337fe2c60c' as const;
const UNISWAP_ROUTER = '0xeE567Fe1712Faf6149d80dA1E6934E354124CfE3'.toLowerCase() as `0x${string}`;
const WETH_ADDRESS = '0xfff9976782d46cc05630d1f6ebab18b2324d6b14'.toLowerCase() as `0x${string}`;

// --- ABI å®šä¹‰ ---
const tokenAbi = [
  { inputs: [{name: "spender", type: "address"}, {name: "amount", type: "uint256"}], name: "approve", outputs: [{type: "bool"}], stateMutability: "nonpayable", type: "function" },
  { inputs: [{name: "owner", type: "address"}, {name: "spender", type: "address"}], name: "allowance", outputs: [{type: "uint256"}], stateMutability: "view", type: "function" }
] as const;

const routerAbi = [
  { inputs: [{name: "amountOutMin", type: "uint256"}, {name: "path", type: "address[]"}, {name: "to", type: "address"}, {name: "deadline", type: "uint256"}], name: "swapExactETHForTokens", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "payable", type: "function" },
  { inputs: [{name: "amountIn", type: "uint256"}, {name: "amountOutMin", type: "uint256"}, {name: "path", type: "address[]"}, {name: "to", type: "address"}, {name: "deadline", type: "uint256"}], name: "swapExactTokensForETH", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "nonpayable", type: "function" },
  { inputs: [{name: "amountIn", type: "uint256"}, {name: "path", type: "address[]"}], name: "getAmountsOut", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "view", type: "function" },
  { inputs: [{name: "token", type: "address"}, {name: "amountTokenDesired", type: "uint256"}, {name: "amountTokenMin", type: "uint256"}, {name: "amountETHMin", type: "uint256"}, {name: "to", type: "address"}, {name: "deadline", type: "uint256"}], name: "addLiquidityETH", outputs: [], stateMutability: "payable", type: "function" },
  { inputs: [], name: "factory", outputs: [{internalType: "address", name: "", type: "address"}], stateMutability: "view", type: "function" }
] as const;

const factoryAbi = [
  { inputs: [{internalType: "address", name: "tokenA", type: "address"}, {internalType: "address", name: "tokenB", type: "address"}], name: "getPair", outputs: [{internalType: "address", name: "pair", type: "address"}], stateMutability: "view", type: "function" }
] as const;

const pairAbi = [
  { inputs: [], name: "getReserves", outputs: [{internalType: "uint112", name: "_reserve0", type: "uint112"}, {internalType: "uint112", name: "_reserve1", type: "uint112"}, {internalType: "uint32", name: "_blockTimestampLast", type: "uint32"}], stateMutability: "view", type: "function" },
  { inputs: [], name: "token0", outputs: [{internalType: "address", name: "", type: "address"}], stateMutability: "view", type: "function" }
] as const;

// --- åŠ¨ç”»é…ç½® ---
const containerVariants = {
  hidden: { opacity: 0 },
  visible: { 
    opacity: 1,
    transition: { staggerChildren: 0.1 }
  }
};

const itemVariants = {
  hidden: { opacity: 0, y: 20 },
  visible: { opacity: 1, y: 0, transition: { type: "spring", stiffness: 100 } }
};

export default function DeFiPage() {
  const { address, isConnected } = useAccount();
  const [activeTab, setActiveTab] = useState<'swap' | 'pool'>('swap');
  const [mode, setMode] = useState<'buy' | 'sell'>('buy'); 
  const [inputAmount, setInputAmount] = useState('');
  const [outputAmount, setOutputAmount] = useState('0'); 
  const [requiredKiki, setRequiredKiki] = useState('0');

  // --- Logic Hooks (Same as before) ---
  const { data: allowance, refetch: refetchAllowance } = useReadContract({
    address: KIKI_ADDRESS, abi: tokenAbi, functionName: 'allowance',
    args: address ? [address, UNISWAP_ROUTER] : undefined
  });

  const { data: priceData, refetch: refetchPrice } = useReadContract({
    address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'getAmountsOut',
    args: [parseEther('1'), [WETH_ADDRESS, KIKI_ADDRESS]], 
    query: { refetchInterval: 5000 } 
  });
  const currentRate = priceData ? parseFloat(formatEther(priceData[1])) : 0;

  const { data: factoryAddress } = useReadContract({
    address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'factory',
  });
  
  const { data: pairAddress } = useReadContract({
    address: factoryAddress, abi: factoryAbi, functionName: 'getPair',
    args: factoryAddress ? [KIKI_ADDRESS, WETH_ADDRESS] : undefined,
  });

  const { data: reserves, refetch: refetchReserves } = useReadContract({
    address: pairAddress, abi: pairAbi, functionName: 'getReserves',
    query: { refetchInterval: 5000 }
  });

  const { data: token0 } = useReadContract({
    address: pairAddress, abi: pairAbi, functionName: 'token0',
  });

  let ethReserve = '0';
  let kikiReserve = '0';
  if (reserves && token0) {
    if (token0.toLowerCase() === WETH_ADDRESS.toLowerCase()) {
      ethReserve = formatEther(reserves[0]);
      kikiReserve = formatEther(reserves[1]);
    } else {
      kikiReserve = formatEther(reserves[0]);
      ethReserve = formatEther(reserves[1]);
    }
  }

  const swapPath = (mode === 'buy' ? [WETH_ADDRESS, KIKI_ADDRESS] : [KIKI_ADDRESS, WETH_ADDRESS]) as `0x${string}`[];
  const shouldFetchSwap = activeTab === 'swap' && inputAmount && !isNaN(parseFloat(inputAmount)) && parseFloat(inputAmount) > 0;
  
  const swapQueryArgs = shouldFetchSwap 
    ? [parseEther(inputAmount), swapPath] as const
    : undefined;

  const { data: amountsOut } = useReadContract({
    address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'getAmountsOut',
    args: swapQueryArgs as any,
  });

  useEffect(() => {
    if (activeTab === 'swap') {
      if (amountsOut && amountsOut[1]) setOutputAmount(formatEther(amountsOut[1]));
      else setOutputAmount('0');
    } else if (activeTab === 'pool' && inputAmount && currentRate > 0) {
      const val = parseFloat(inputAmount);
      if (!isNaN(val)) {
        const estimatedKiki = val * currentRate;
        setRequiredKiki(estimatedKiki.toFixed(2));
      }
    }
  }, [amountsOut, inputAmount, activeTab, currentRate]);

  const { data: hash, writeContract, isPending, error: writeError } = useWriteContract();
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash });

  useEffect(() => {
    if (isSuccess) {
      refetchAllowance(); refetchPrice(); refetchReserves();
      setInputAmount('');
    }
  }, [isSuccess]);

  const handleSwap = () => {
    if (!inputAmount || !address) return;
    const amountIn = parseEther(inputAmount);
    const deadline = BigInt(Math.floor(Date.now() / 1000) + 1200);
    const path = (mode === 'buy' ? [WETH_ADDRESS, KIKI_ADDRESS] : [KIKI_ADDRESS, WETH_ADDRESS]) as `0x${string}`[];

    if (mode === 'buy') {
      writeContract({
        address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'swapExactETHForTokens',
        args: [0n, path, address, deadline], value: amountIn,
      });
    } else {
      writeContract({
        address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'swapExactTokensForETH',
        args: [amountIn, 0n, path, address, deadline],
      });
    }
  };

  const handleApprove = () => {
    writeContract({ address: KIKI_ADDRESS, abi: tokenAbi, functionName: 'approve', args: [UNISWAP_ROUTER, parseEther('999999999')] });
  };

  const handleAddLiquidity = () => {
    if (!inputAmount || !requiredKiki || !address) return;
    writeContract({
      address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'addLiquidityETH',
      args: [KIKI_ADDRESS, parseEther(requiredKiki), 0n, 0n, address, BigInt(Math.floor(Date.now() / 1000) + 1200)],
      value: parseEther(inputAmount),
    });
  };

  const needsApproval = allowance !== undefined && allowance < parseEther('1000000');
  const displayPrice = currentRate > 0 ? currentRate.toLocaleString(undefined, { maximumFractionDigits: 0 }) : '---';

  return (
    <div className="min-h-screen bg-[#06070a] text-slate-200 font-sans flex flex-col items-center selection:bg-blue-500/30">
      {/* ğŸŒŒ Background Elements */}
      <div className="fixed inset-0 z-0">
        <div className="absolute top-0 left-0 w-full h-[500px] bg-gradient-to-b from-blue-900/10 to-transparent opacity-50 blur-3xl" />
        <div className="absolute top-[-20%] right-[-10%] w-[600px] h-[600px] bg-indigo-600/10 rounded-full blur-[100px]" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff03_1px,transparent_1px),linear-gradient(to_bottom,#ffffff03_1px,transparent_1px)] bg-[size:40px_40px]" />
      </div>
      
      {/* ğŸŸ¢ Header */}
      <motion.div 
        initial={{ y: -20, opacity: 0 }} 
        animate={{ y: 0, opacity: 1 }} 
        className="relative z-10 w-full max-w-7xl px-6 py-6 flex justify-between items-center"
      >
        <Link href="/dashboard" className="group flex items-center gap-2 text-xs font-mono text-slate-500 hover:text-white transition-colors uppercase tracking-wider">
          <div className="w-8 h-8 rounded-full bg-white/5 border border-white/10 flex items-center justify-center group-hover:bg-white/10 transition-all">
            <ArrowLeft className="w-4 h-4" />
          </div>
          Dashboard
        </Link>
        <div className="flex gap-4 items-center">
          <div className="hidden md:block"><TokenBalance /></div>
          <ConnectButton chainStatus="icon" showBalance={false} />
        </div>
      </motion.div>

      {/* ğŸš€ Main Content Grid */}
      <motion.div 
        variants={containerVariants}
        initial="hidden"
        animate="visible"
        className="relative z-10 w-full max-w-5xl mt-8 px-4 grid grid-cols-1 lg:grid-cols-12 gap-8 items-start"
      >
        
        {/* ğŸ“Š Left Column: Stats Panel */}
        <div className="lg:col-span-5 space-y-6 lg:sticky lg:top-24">
           <motion.div variants={itemVariants} className="text-left">
              <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-500/10 border border-blue-500/20 text-[10px] font-bold text-blue-400 mb-4 uppercase tracking-widest">
                Uniswap V2 Protocol
              </div>
              <h1 className="text-5xl font-bold text-white tracking-tight mb-3">
                DeFi <span className="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-500">Hub</span>
              </h1>
              <p className="text-slate-400 leading-relaxed text-sm">
                Swap tokens instantly or provide liquidity to earn trading fees. Powered by automated market makers.
              </p>
           </motion.div>

           <motion.div variants={itemVariants} className="group relative bg-[#0e1015]/60 backdrop-blur-xl border border-white/10 rounded-3xl p-6 overflow-hidden hover:border-white/20 transition-all duration-300">
              <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity" />
              
              <div className="relative flex justify-between items-start mb-6">
                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                  <Database className="w-5 h-5 text-blue-500" /> Pool Stats
                </h3>
                <a href={`https://sepolia.etherscan.io/address/${pairAddress}`} target="_blank" className="p-2 rounded-full hover:bg-white/5 text-slate-500 hover:text-white transition-colors">
                  <ArrowRight className="w-4 h-4 -rotate-45" />
                </a>
              </div>
              
              <div className="space-y-3">
                 {/* ETH Reserve */}
                 <div className="flex justify-between items-center p-4 bg-[#0a0b0e] border border-white/5 rounded-2xl group/item hover:border-white/10 transition-all">
                    <div className="flex items-center gap-3">
                       <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center text-lg shadow-lg">Î</div>
                       <div>
                          <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Pooled ETH</div>
                          <div className="text-white font-mono text-lg font-semibold">{parseFloat(ethReserve).toFixed(4)}</div>
                       </div>
                    </div>
                 </div>

                 {/* KIKI Reserve */}
                 <div className="flex justify-between items-center p-4 bg-[#0a0b0e] border border-white/5 rounded-2xl group/item hover:border-white/10 transition-all">
                    <div className="flex items-center gap-3">
                       <div className="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-indigo-700 flex items-center justify-center text-lg font-bold text-white shadow-lg">K</div>
                       <div>
                          <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider">Pooled KIKI</div>
                          <div className="text-white font-mono text-lg font-semibold">{parseFloat(kikiReserve).toLocaleString(undefined, {maximumFractionDigits: 0})}</div>
                       </div>
                    </div>
                 </div>
              </div>
           </motion.div>

           <motion.div variants={itemVariants} className="p-4 bg-gradient-to-r from-blue-900/20 to-indigo-900/20 rounded-2xl border border-blue-500/20 flex items-center justify-center gap-3">
              <RefreshCw className="w-4 h-4 text-blue-400 animate-[spin_10s_linear_infinite]" />
              <div className="text-xs font-mono text-blue-200">
                1 ETH â‰ˆ <span className="font-bold text-white text-base mx-1">{displayPrice}</span> KIKI
              </div>
           </motion.div>
        </div>

        {/* ğŸ›ï¸ Right Column: Interaction Card */}
        <motion.div variants={itemVariants} className="lg:col-span-7">
          <div className="bg-[#12141a]/80 backdrop-blur-2xl border border-white/10 rounded-[32px] p-2 shadow-2xl ring-1 ring-white/5">
            <div className="bg-[#0e1015] rounded-[24px] p-6 sm:p-8 space-y-6">
              
              {/* Tab Switcher */}
              <div className="flex p-1 bg-[#1a1d26] rounded-2xl border border-white/5 relative">
                 {(['swap', 'pool'] as const).map((tab) => (
                    <button
                      key={tab}
                      onClick={() => { setActiveTab(tab); setInputAmount(''); }}
                      className={`relative flex-1 flex items-center justify-center gap-2 py-3 rounded-xl text-sm font-bold z-10 transition-colors ${activeTab === tab ? 'text-white' : 'text-slate-500 hover:text-slate-300'}`}
                    >
                      {activeTab === tab && (
                        <motion.div 
                          layoutId="activeTab" 
                          className={`absolute inset-0 rounded-xl shadow-lg ${tab === 'swap' ? 'bg-blue-600' : 'bg-indigo-600'}`} 
                          transition={{ type: "spring", bounce: 0.2, duration: 0.6 }}
                        />
                      )}
                      <span className="relative z-10 flex items-center gap-2">
                         {tab === 'swap' ? <ArrowRightLeft className="w-4 h-4" /> : <Droplets className="w-4 h-4" />}
                         {tab === 'swap' ? 'Swap' : 'Add Liquidity'}
                      </span>
                    </button>
                 ))}
              </div>

              <div className="space-y-1">
                <div className="flex justify-between px-1">
                   <span className="text-xs font-bold text-slate-500 uppercase tracking-wider">{activeTab === 'swap' ? 'You Pay' : 'Deposit Amount'}</span>
                   <div className="flex items-center gap-1 text-xs text-slate-500">
                      <Wallet className="w-3 h-3" />
                      <span>Balance: ---</span>
                   </div>
                </div>
                
                {/* Input Area 1 */}
                <div className="group bg-[#1a1d26] p-5 rounded-2xl border border-white/5 hover:border-white/10 focus-within:border-blue-500/50 focus-within:ring-2 focus-within:ring-blue-500/20 transition-all duration-200">
                  <div className="flex justify-between items-center gap-4">
                    <input 
                      type="number" 
                      value={inputAmount} 
                      onChange={(e) => setInputAmount(e.target.value)} 
                      placeholder="0.0" 
                      className="bg-transparent text-4xl font-bold text-white placeholder:text-slate-700 outline-none w-full font-mono" 
                    />
                    <div className="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 shrink-0">
                       {activeTab === 'swap' && mode === 'sell' ? (
                          <>
                             <div className="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold text-white">K</div>
                             <span className="font-bold pr-1">KIKI</span>
                          </>
                       ) : (
                          <>
                             <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-black">Î</div>
                             <span className="font-bold pr-1">ETH</span>
                          </>
                       )}
                    </div>
                  </div>
                </div>
              </div>

              {/* Middle Action / Divider */}
              <div className="relative h-6 flex items-center justify-center">
                <div className="absolute w-full h-[1px] bg-white/5" />
                {activeTab === 'swap' ? (
                   <motion.button 
                     whileHover={{ scale: 1.1, rotate: 180 }}
                     whileTap={{ scale: 0.9 }}
                     onClick={() => setMode(mode === 'buy' ? 'sell' : 'buy')} 
                     className="relative bg-[#12141a] border border-white/10 p-2.5 rounded-xl text-slate-400 hover:text-white hover:border-blue-500/50 transition-colors z-10 shadow-xl"
                   >
                     <ArrowDown className="w-4 h-4" />
                   </motion.button>
                ) : (
                   <div className="relative bg-[#12141a] border border-white/10 p-2 rounded-full text-slate-500 z-10">
                     <Plus className="w-4 h-4" />
                   </div>
                )}
              </div>

              <div className="space-y-1">
                <span className="text-xs font-bold text-slate-500 uppercase tracking-wider px-1">{activeTab === 'swap' ? 'You Receive' : 'Required Asset'}</span>
                
                {/* Input Area 2 (Output) */}
                <div className="bg-[#1a1d26] p-5 rounded-2xl border border-white/5">
                   <div className="flex justify-between items-center gap-4">
                     {activeTab === 'swap' ? (
                        <input type="text" value={outputAmount ? parseFloat(outputAmount).toFixed(4) : '0'} disabled className="bg-transparent text-4xl font-bold text-slate-300 placeholder:text-slate-700 outline-none w-full font-mono cursor-not-allowed opacity-80" />
                     ) : (
                        <input type="text" value={requiredKiki} disabled className="bg-transparent text-4xl font-bold text-slate-300 placeholder:text-slate-700 outline-none w-full font-mono cursor-not-allowed opacity-80" />
                     )}
                     
                     <div className="flex items-center gap-2 bg-black/40 px-3 py-1.5 rounded-full border border-white/10 shrink-0">
                        {activeTab === 'swap' && mode === 'buy' || activeTab === 'pool' ? (
                           <>
                              <div className="w-6 h-6 rounded-full bg-blue-600 flex items-center justify-center text-[10px] font-bold text-white">K</div>
                              <span className="font-bold pr-1">KIKI</span>
                           </>
                        ) : (
                           <>
                              <div className="w-6 h-6 rounded-full bg-slate-200 flex items-center justify-center text-[10px] font-bold text-black">Î</div>
                              <span className="font-bold pr-1">ETH</span>
                           </>
                        )}
                     </div>
                   </div>
                </div>
              </div>

              {/* Main Action Button */}
              <div className="pt-2">
                {!isConnected ? (
                  <div className="w-full h-16 bg-slate-800/50 rounded-2xl flex items-center justify-center text-slate-400 font-bold border border-white/5">Connect Wallet to Trade</div>
                ) : needsApproval ? (
                  <Button onClick={handleApprove} disabled={isPending || isConfirming} className="w-full h-16 bg-yellow-600/90 hover:bg-yellow-500 text-white font-bold text-xl rounded-2xl transition-all shadow-lg shadow-yellow-900/20">
                     {isPending ? <Loader2 className="animate-spin mr-2"/> : "Approve KIKI Usage"}
                  </Button>
                ) : (
                  <motion.div whileHover={{ scale: 1.02 }} whileTap={{ scale: 0.98 }}>
                    <Button 
                      onClick={activeTab === 'swap' ? handleSwap : handleAddLiquidity} 
                      disabled={!inputAmount || parseFloat(inputAmount) <= 0 || isPending || isConfirming} 
                      className={`w-full h-16 font-bold text-xl rounded-2xl shadow-xl transition-all ${
                        activeTab === 'swap' 
                          ? 'bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 shadow-blue-900/30' 
                          : 'bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 shadow-indigo-900/30'
                      }`}
                    >
                      {isPending || isConfirming ? <Loader2 className="animate-spin mr-2"/> : (activeTab === 'swap' ? 'Swap Now' : 'Add Liquidity')}
                    </Button>
                  </motion.div>
                )}
              </div>
              
              {/* Additional Details */}
              {activeTab === 'swap' && outputAmount !== '0' && (
                <div className="flex justify-between text-xs text-slate-500 px-2 pt-2">
                  <span>Price Impact</span>
                  <span className="text-green-400">{'<'} 0.01%</span>
                </div>
              )}

            </div>
          </div>
        </motion.div>

      </motion.div>
    </div>
  );
}
]]>
  </file>
  <file path="app/gift/page.tsx">
<![CDATA[
'use client';

import { Card, CardContent } from '@/components/ui/card';
import { ArrowLeft, Gamepad2, QrCode, ExternalLink, ShieldCheck, MessageCircle } from 'lucide-react';
import Link from 'next/link';
import { motion } from 'framer-motion';

// âš ï¸ Discord é“¾æ¥
const DISCORD_LINK = "https://discord.gg/ajTnnwBppv"; 

export default function GiftPage() {
  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-purple-500/30 font-sans flex flex-col">
      
      {/* 1. èƒŒæ™¯åº•å™ª (Pro Style) */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-indigo-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-green-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>

      {/* 2. é¡¶éƒ¨å¯¼èˆª */}
      <nav className="relative z-10 w-full p-6 max-w-7xl mx-auto">
        <Link 
          href="/secret" 
          className="inline-flex items-center text-xs font-mono text-slate-500 hover:text-white transition-colors uppercase tracking-wide group"
        >
          <ArrowLeft className="mr-2 h-3 w-3 group-hover:-translate-x-1 transition-transform" /> 
          RETURN TO ACCESS GATE
        </Link>
      </nav>

      {/* 3. æ ¸å¿ƒå†…å®¹ */}
      <main className="flex-1 flex flex-col items-center justify-center p-6 relative z-10 w-full max-w-4xl mx-auto">
        
        {/* æ ‡é¢˜åŒº */}
        <div className="text-center mb-16">
          <div className="inline-flex items-center justify-center p-3 bg-white/5 rounded-2xl mb-4 border border-white/5 shadow-xl">
             <ShieldCheck className="w-8 h-8 text-indigo-400" />
          </div>
          <h1 className="text-4xl font-bold text-white tracking-tight mb-2">
            Community Hub
          </h1>
          <p className="text-slate-400 font-light text-sm max-w-md mx-auto">
            Connect with the core team and other verified holders. Access exclusive channels and support.
          </p>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-8 w-full">
          
          {/* --- 1. Discord Card --- */}
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.1 }}
            className="h-full"
          >
            <a href={DISCORD_LINK} target="_blank" rel="noreferrer" className="block h-full group">
              <Card className="h-full bg-[#12141a] border-[#5865F2]/20 hover:border-[#5865F2] hover:bg-[#5865F2]/5 transition-all duration-300 cursor-pointer relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-1 bg-[#5865F2]"></div>
                <CardContent className="p-8 flex flex-col items-center justify-center h-full text-center">
                  
                  <div className="w-16 h-16 bg-[#5865F2]/10 rounded-2xl flex items-center justify-center mb-6 border border-[#5865F2]/20 group-hover:scale-110 transition-transform duration-300">
                    <Gamepad2 className="w-8 h-8 text-[#5865F2]" />
                  </div>
                  
                  <h2 className="text-xl font-bold text-white mb-2">Discord Server</h2>
                  <p className="text-sm text-slate-400 mb-8 leading-relaxed">
                    Join the conversation, participate in governance, and get live updates.
                  </p>
                  
                  <div className="mt-auto inline-flex items-center gap-2 text-xs font-mono font-bold text-[#5865F2] uppercase tracking-wider border border-[#5865F2]/30 px-4 py-2 rounded hover:bg-[#5865F2] hover:text-white transition-colors">
                    JOIN CHANNEL <ExternalLink className="w-3 h-3" />
                  </div>
                </CardContent>
              </Card>
            </a>
          </motion.div>

          {/* --- 2. WeChat Card --- */}
          <motion.div 
            initial={{ opacity: 0, y: 20 }}
            animate={{ opacity: 1, y: 0 }}
            transition={{ delay: 0.2 }}
            className="h-full"
          >
            <Card className="h-full bg-[#12141a] border-green-500/20 hover:border-green-500 transition-all duration-300 group relative overflow-hidden">
              <div className="absolute top-0 left-0 w-full h-1 bg-green-500"></div>
              <CardContent className="p-8 flex flex-col items-center justify-center h-full text-center">
                
                <div className="flex items-center gap-2 text-green-500 font-bold mb-6 font-mono text-sm tracking-wide">
                  <MessageCircle className="w-4 h-4" /> WECHAT SUPPORT
                </div>
                
                {/* äºŒç»´ç å±•ç¤ºåŒº */}
                <div className="relative w-48 h-48 bg-white p-3 rounded-xl shadow-2xl shadow-green-900/20 mb-6 group-hover:scale-105 transition-transform duration-300">
                  <img 
                    src="/Wechat.png" 
                    alt="WeChat QR Code" 
                    className="w-full h-full object-contain"
                  />
                  {/* æ‰«æçº¿åŠ¨ç”»è£…é¥° */}
                  <div className="absolute inset-0 bg-gradient-to-b from-transparent via-green-500/10 to-transparent h-1/2 w-full animate-[scan_3s_ease-in-out_infinite] pointer-events-none"></div>
                </div>
                
                <div className="mt-auto flex flex-col gap-1">
                   <span className="text-[10px] text-slate-500 font-mono uppercase">Verification Hash</span>
                   <code className="text-sm font-mono text-green-400 bg-green-500/10 px-2 py-1 rounded border border-green-500/20">
                     KIKI-NFT-HOLDER
                   </code>
                </div>
              </CardContent>
            </Card>
          </motion.div>

        </div>

        {/* åº•éƒ¨è£…é¥°æ–‡å­— */}
        <motion.div 
           initial={{ opacity: 0 }}
           animate={{ opacity: 1 }}
           transition={{ delay: 0.5 }}
           className="mt-16 text-center"
        >
           <p className="text-[10px] text-slate-600 font-mono uppercase tracking-[0.2em]">
              Protocol Secured â€¢ Member Access Only
           </p>
        </motion.div>

      </main>
    </div>
  );
}
]]>
  </file>
  <file path="app/globals.css">
<![CDATA[
@import "tailwindcss";
@import "tw-animate-css";

@custom-variant dark (&:is(.dark *));

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
  --color-sidebar-ring: var(--sidebar-ring);
  --color-sidebar-border: var(--sidebar-border);
  --color-sidebar-accent-foreground: var(--sidebar-accent-foreground);
  --color-sidebar-accent: var(--sidebar-accent);
  --color-sidebar-primary-foreground: var(--sidebar-primary-foreground);
  --color-sidebar-primary: var(--sidebar-primary);
  --color-sidebar-foreground: var(--sidebar-foreground);
  --color-sidebar: var(--sidebar);
  --color-chart-5: var(--chart-5);
  --color-chart-4: var(--chart-4);
  --color-chart-3: var(--chart-3);
  --color-chart-2: var(--chart-2);
  --color-chart-1: var(--chart-1);
  --color-ring: var(--ring);
  --color-input: var(--input);
  --color-border: var(--border);
  --color-destructive: var(--destructive);
  --color-accent-foreground: var(--accent-foreground);
  --color-accent: var(--accent);
  --color-muted-foreground: var(--muted-foreground);
  --color-muted: var(--muted);
  --color-secondary-foreground: var(--secondary-foreground);
  --color-secondary: var(--secondary);
  --color-primary-foreground: var(--primary-foreground);
  --color-primary: var(--primary);
  --color-popover-foreground: var(--popover-foreground);
  --color-popover: var(--popover);
  --color-card-foreground: var(--card-foreground);
  --color-card: var(--card);
  --radius-sm: calc(var(--radius) - 4px);
  --radius-md: calc(var(--radius) - 2px);
  --radius-lg: var(--radius);
  --radius-xl: calc(var(--radius) + 4px);
}

:root {
  --radius: 0.625rem;
  --background: oklch(1 0 0);
  --foreground: oklch(0.129 0.042 264.695);
  --card: oklch(1 0 0);
  --card-foreground: oklch(0.129 0.042 264.695);
  --popover: oklch(1 0 0);
  --popover-foreground: oklch(0.129 0.042 264.695);
  --primary: oklch(0.208 0.042 265.755);
  --primary-foreground: oklch(0.984 0.003 247.858);
  --secondary: oklch(0.968 0.007 247.896);
  --secondary-foreground: oklch(0.208 0.042 265.755);
  --muted: oklch(0.968 0.007 247.896);
  --muted-foreground: oklch(0.554 0.046 257.417);
  --accent: oklch(0.968 0.007 247.896);
  --accent-foreground: oklch(0.208 0.042 265.755);
  --destructive: oklch(0.577 0.245 27.325);
  --border: oklch(0.929 0.013 255.508);
  --input: oklch(0.929 0.013 255.508);
  --ring: oklch(0.704 0.04 256.788);
  --chart-1: oklch(0.646 0.222 41.116);
  --chart-2: oklch(0.6 0.118 184.704);
  --chart-3: oklch(0.398 0.07 227.392);
  --chart-4: oklch(0.828 0.189 84.429);
  --chart-5: oklch(0.769 0.188 70.08);
  --sidebar: oklch(0.984 0.003 247.858);
  --sidebar-foreground: oklch(0.129 0.042 264.695);
  --sidebar-primary: oklch(0.208 0.042 265.755);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.968 0.007 247.896);
  --sidebar-accent-foreground: oklch(0.208 0.042 265.755);
  --sidebar-border: oklch(0.929 0.013 255.508);
  --sidebar-ring: oklch(0.704 0.04 256.788);
}

.dark {
  --background: oklch(0.129 0.042 264.695);
  --foreground: oklch(0.984 0.003 247.858);
  --card: oklch(0.208 0.042 265.755);
  --card-foreground: oklch(0.984 0.003 247.858);
  --popover: oklch(0.208 0.042 265.755);
  --popover-foreground: oklch(0.984 0.003 247.858);
  --primary: oklch(0.929 0.013 255.508);
  --primary-foreground: oklch(0.208 0.042 265.755);
  --secondary: oklch(0.279 0.041 260.031);
  --secondary-foreground: oklch(0.984 0.003 247.858);
  --muted: oklch(0.279 0.041 260.031);
  --muted-foreground: oklch(0.704 0.04 256.788);
  --accent: oklch(0.279 0.041 260.031);
  --accent-foreground: oklch(0.984 0.003 247.858);
  --destructive: oklch(0.704 0.191 22.216);
  --border: oklch(1 0 0 / 10%);
  --input: oklch(1 0 0 / 15%);
  --ring: oklch(0.551 0.027 264.364);
  --chart-1: oklch(0.488 0.243 264.376);
  --chart-2: oklch(0.696 0.17 162.48);
  --chart-3: oklch(0.769 0.188 70.08);
  --chart-4: oklch(0.627 0.265 303.9);
  --chart-5: oklch(0.645 0.246 16.439);
  --sidebar: oklch(0.208 0.042 265.755);
  --sidebar-foreground: oklch(0.984 0.003 247.858);
  --sidebar-primary: oklch(0.488 0.243 264.376);
  --sidebar-primary-foreground: oklch(0.984 0.003 247.858);
  --sidebar-accent: oklch(0.279 0.041 260.031);
  --sidebar-accent-foreground: oklch(0.984 0.003 247.858);
  --sidebar-border: oklch(1 0 0 / 10%);
  --sidebar-ring: oklch(0.551 0.027 264.364);
}

@layer base {
  * {
    @apply border-border outline-ring/50;
  }
  body {
    @apply bg-background text-foreground;
  }
}

/* --- æ–°å¢ï¼šæå…‰èƒŒæ™¯åŠ¨ç”» --- */
@keyframes aurora {
  0% {
    background-position: 50% 50%, 50% 50%;
  }
  100% {
    background-position: 100% 0%, 0% 100%;
  }
}

.animate-aurora {
  animation: aurora 60s linear infinite alternate;
}

@keyframes shine {
  100% {
    left: 125%;
  }
}
.group:hover .group-hover\:animate-shine {
  animation: shine 0.75s;
}
]]>
  </file>
  <file path="app/layout.tsx">
<![CDATA[
'use client';

import '@rainbow-me/rainbowkit/styles.css';
import { getDefaultConfig, RainbowKitProvider } from '@rainbow-me/rainbowkit';
import { WagmiProvider } from 'wagmi';
import { sepolia } from 'wagmi/chains';
import { QueryClientProvider, QueryClient } from "@tanstack/react-query";
import { Inter } from "next/font/google";
import "./globals.css";

const inter = Inter({ subsets: ["latin"] });

const config = getDefaultConfig({
  appName: 'My NFT Minter',
  projectId: 'YOUR_PROJECT_ID', // å¼€å‘é˜¶æ®µå¯ä»¥ä¸å¡«
  chains: [sepolia],
  ssr: true,
});

const queryClient = new QueryClient();

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <WagmiProvider config={config}>
          <QueryClientProvider client={queryClient}>
            <RainbowKitProvider>
              {children}
            </RainbowKitProvider>
          </QueryClientProvider>
        </WagmiProvider>
      </body>
    </html>
  );
}
]]>
  </file>
  <file path="app/mint/page.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract } from 'wagmi';
import Link from 'next/link';
import { Button } from '@/components/ui/button';
import { Card, CardContent } from '@/components/ui/card';
import { Progress } from '@/components/ui/progress';
import { 
  ArrowLeft, Loader2, Check, AlertCircle, ExternalLink, 
  Sparkles, LockKeyhole, Rocket, Cpu, Database, RefreshCcw 
} from 'lucide-react';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, AnimatePresence } from 'framer-motion'; 
import { parseEther, formatEther } from 'viem';
import TokenBalance from '@/components/TokenBalance';
import { logActivity } from '@/lib/logger'; // âœ… 1. å¼•å…¥ logger

const NFT_CONTRACT = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 
const TOKEN_CONTRACT = '0x83F7A90486697B8B881319FbADaabF337fE2c60c'; 
const MAX_SUPPLY = 100;
const MINT_PRICE = parseEther('20');

const nftAbi = [
  { inputs: [{ name: "to", type: "address" }], name: "mint", outputs: [], stateMutability: "nonpayable", type: "function" },
  { inputs: [], name: "totalSupply", outputs: [{ type: "uint256" }], stateMutability: "view", type: "function" },
] as const;

const tokenAbi = [
  { inputs: [{ name: "spender", type: "address" }, { name: "amount", type: "uint256" }], name: "approve", outputs: [{ type: "bool" }], stateMutability: "nonpayable", type: "function" },
  { inputs: [{ name: "owner", type: "address" }, { name: "spender", type: "address" }], name: "allowance", outputs: [{ type: "uint256" }], stateMutability: "view", type: "function" },
  { inputs: [{ name: "account", type: "address" }], name: "balanceOf", outputs: [{ type: "uint256" }], stateMutability: "view", type: "function" },
] as const;

export default function MintPage() {
  const { isConnected, chain, address } = useAccount();
  const [step, setStep] = useState<'approve' | 'mint'>('approve');
  const [lastAction, setLastAction] = useState<'approve' | 'mint' | null>(null);
  const isWrongNetwork = isConnected && chain?.id !== 11155111;

  const { data: rawSupply, refetch: refetchSupply } = useReadContract({
    address: NFT_CONTRACT as `0x${string}`, abi: nftAbi, functionName: 'totalSupply'
  });
  const currentSupply = rawSupply ? Number(rawSupply) : 0;

  const { data: balanceData, refetch: refetchBalance } = useReadContract({
    address: TOKEN_CONTRACT as `0x${string}`, abi: tokenAbi, functionName: 'balanceOf', args: address ? [address] : undefined
  });
  const kikiBalance = balanceData ? Number(formatEther(balanceData)) : 0;

  const { data: allowanceData, refetch: refetchAllowance } = useReadContract({
    address: TOKEN_CONTRACT as `0x${string}`, abi: tokenAbi, functionName: 'allowance', 
    args: address ? [address, NFT_CONTRACT as `0x${string}`] : undefined
  });
  const currentAllowance = allowanceData ? allowanceData : 0n;

  useEffect(() => {
    if (currentAllowance >= MINT_PRICE) {
      setStep('mint');
    } else {
      setStep('approve');
    }
  }, [currentAllowance]);

  const { data: hash, writeContract, isPending, reset } = useWriteContract();
  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({ hash });

  useEffect(() => {
    if (isConfirmed) {
      refetchSupply();
      refetchBalance();
      refetchAllowance();

      // âœ… 2. åªæœ‰åœ¨æ‰§è¡Œ Mint ä¸”äº¤æ˜“æˆåŠŸæ—¶è®°å½•æ—¥å¿—
      if (lastAction === 'mint' && hash) {
        logActivity({
          address: address as string,
          type: 'MINT',
          details: 'Genesis Asset Minted',
          hash
        });
      }

      if (lastAction === 'approve') {
        reset(); 
        setLastAction(null); 
      }
    }
  }, [isConfirmed, lastAction, refetchSupply, refetchBalance, refetchAllowance, reset, address, hash]);

  const handleAction = () => {
    if (isConfirmed && lastAction === 'mint') {
      reset(); 
      setLastAction(null);
      return;
    }

    if (step === 'approve') {
      setLastAction('approve'); 
      writeContract({
        address: TOKEN_CONTRACT as `0x${string}`, abi: tokenAbi, functionName: 'approve', args: [NFT_CONTRACT as `0x${string}`, MINT_PRICE],
      });
    } else {
      setLastAction('mint'); 
      writeContract({
        address: NFT_CONTRACT as `0x${string}`, abi: nftAbi, functionName: 'mint', args: [address as `0x${string}`],
      });
    }
  };

  const isInsufficientBalance = kikiBalance < 20;
  const showSuccessCard = isConfirmed && lastAction === 'mint';

  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-blue-500/30 font-sans">
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-[600px] h-[600px] bg-purple-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-blue-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>

      <div className="relative z-10 max-w-7xl mx-auto px-6 py-10">
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-20">
          <div className="flex flex-col gap-1">
            <Link href="/dashboard" className="inline-flex items-center text-xs font-mono text-slate-500 hover:text-blue-400 transition-colors mb-2 uppercase tracking-wide">
              <ArrowLeft className="mr-2 h-3 w-3" /> RETURN TO DASHBOARD
            </Link>
            <h1 className="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
              <Rocket className="w-8 h-8 text-purple-500" /> Genesis Launchpad
            </h1>
          </div>
          <div className="flex items-center gap-4 bg-[#12141a]/50 p-2 rounded-xl border border-white/5 backdrop-blur-sm">
            <TokenBalance />
            <ConnectButton />
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-16 items-start">
          <div className="relative group perspective-1000">
            <motion.div animate={{ scale: [1, 1.1, 1], opacity: [0.3, 0.6, 0.3] }} transition={{ duration: 4, repeat: Infinity, ease: "easeInOut" }} className="absolute -inset-4 bg-gradient-to-r from-purple-600 via-blue-600 to-purple-600 rounded-full blur-3xl opacity-40 group-hover:opacity-60 transition-opacity duration-500"></motion.div>
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: [0, -15, 0], rotateX: [0, 2, 0], rotateY: [0, -2, 0] }} transition={{ opacity: { duration: 0.8 }, y: { duration: 6, repeat: Infinity, ease: "easeInOut" }, rotateX: { duration: 8, repeat: Infinity, ease: "easeInOut" }, rotateY: { duration: 7, repeat: Infinity, ease: "easeInOut" } }} className="relative aspect-square rounded-2xl overflow-hidden border border-white/10 bg-[#12141a] shadow-2xl z-10">
              <img src="/kiki.png" alt="Genesis Asset" className="object-cover w-full h-full transform transition-transform duration-700 group-hover:scale-105" />
              <div className="absolute top-4 left-4"><div className="bg-black/60 backdrop-blur-md px-3 py-1 rounded text-[10px] font-mono border border-white/10 text-white flex items-center gap-2"><Database className="w-3 h-3 text-purple-400" /> IPFS HOSTED</div></div>
              <div className="absolute bottom-4 right-4"><div className="bg-black/60 backdrop-blur-md px-3 py-1 rounded-full text-xs font-bold border border-white/20 flex items-center gap-2 text-white shadow-lg"><Sparkles className="w-3 h-3 text-yellow-400 animate-pulse" /> Series 01</div></div>
            </motion.div>
          </div>

          <motion.div initial={{ opacity: 0, x: 20 }} animate={{ opacity: 1, x: 0 }} transition={{ duration: 0.6, delay: 0.2 }} className="space-y-8">
            <div>
              <div className="flex items-center gap-2 mb-2"><Cpu className="w-4 h-4 text-blue-500" /><span className="text-xs font-mono text-blue-400 tracking-widest uppercase">Initial Asset Offering</span></div>
              <h2 className="text-4xl font-bold text-white mb-4">Mint Kiki Asset</h2>
              <p className="text-slate-400 leading-relaxed font-light">{isWrongNetwork ? <span className="text-red-400 flex items-center gap-2 bg-red-500/10 px-3 py-2 rounded border border-red-500/20"><AlertCircle className="w-5 h-5" /> Switch to Sepolia Testnet.</span> : "Participate in the protocol genesis. Burn 20 $KIKI to mint a generative ERC-721 asset. Staking this asset yields passive token rewards."}</p>
            </div>
            <div className="space-y-3">
              <div className="flex justify-between text-xs font-mono text-slate-500"><span>TOTAL MINTED</span><span className="text-white">{currentSupply} / {MAX_SUPPLY}</span></div>
              <Progress value={(currentSupply / MAX_SUPPLY) * 100} className="h-2 bg-[#1e212b] text-purple-500" /> 
            </div>
            <Card className="bg-[#12141a] border-white/5 backdrop-blur-sm">
              <CardContent className="p-8 space-y-8">
                <div className="flex justify-between items-center border-b border-white/5 pb-6">
                  <span className="text-sm text-slate-500 font-mono">MINT PRICE</span>
                  <div className="flex items-center gap-3"><div className="flex flex-col items-end"><span className="text-2xl font-bold text-white tracking-tight">20 KIKI</span><span className="text-[10px] text-slate-500 font-mono uppercase">Burn Mechanism</span></div></div>
                </div>
                {!isConnected ? (
                  <Button disabled className="w-full bg-[#1e212b] text-slate-500 h-14 border border-white/5">Wallet Not Connected</Button>
                ) : (
                  <>
                    <Button 
                      size="lg" className={`w-full text-base font-bold h-14 transition-all uppercase tracking-wide ${isInsufficientBalance ? 'bg-red-900/20 text-red-400 border border-red-900/50 hover:bg-red-900/30 cursor-not-allowed' : step === 'approve' ? 'bg-blue-600 hover:bg-blue-500 text-white shadow-[0_0_20px_rgba(37,99,235,0.3)]' : showSuccessCard ? 'bg-white text-black hover:bg-slate-200' : 'bg-green-600 hover:bg-green-500 text-white shadow-[0_0_20px_rgba(22,163,74,0.3)]'}`}
                      onClick={handleAction} disabled={isPending || isConfirming || isInsufficientBalance || currentSupply >= MAX_SUPPLY}
                    >
                      {isPending || isConfirming ? <><Loader2 className="mr-2 animate-spin w-5 h-5" /> PROCESSING ON-CHAIN...</> : isInsufficientBalance ? "INSUFFICIENT BALANCE" : step === 'approve' ? <><LockKeyhole className="mr-2 w-5 h-5" /> APPROVE 20 KIKI</> : showSuccessCard ? <><RefreshCcw className="mr-2 w-5 h-5" /> MINT ANOTHER</> : <><Rocket className="mr-2 w-5 h-5" /> MINT ASSET NOW</>}
                    </Button>
                    {!showSuccessCard && <div className="text-center text-[10px] font-mono text-slate-600 uppercase">{step === 'approve' && !isInsufficientBalance && "Step 1/2: Approve token spend"}{step === 'mint' && "Step 2/2: Confirm Mint transaction"}</div>}
                  </>
                )}
                <AnimatePresence>
                  {showSuccessCard && (
                    <motion.div initial={{ opacity: 0, height: 0, marginTop: 0 }} animate={{ opacity: 1, height: 'auto', marginTop: 24 }} exit={{ opacity: 0, height: 0 }} className="overflow-hidden">
                      <div className="bg-green-500/5 p-4 rounded-xl border border-green-500/20 space-y-4">
                        <div className="flex items-center gap-3 text-green-400 font-bold border-b border-green-500/10 pb-3">
                          <div className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center"><Check className="w-5 h-5" /></div>
                          <div className="flex flex-col"><span>ASSET MINTED SUCCESSFULLY</span><span className="text-[10px] font-mono font-normal opacity-70">Transaction Confirmed</span></div>
                        </div>
                        <div className="grid grid-cols-2 gap-3">
                          <Link href="/dashboard"><div className="flex items-center justify-center gap-2 text-xs font-mono bg-blue-600/10 border border-blue-500/30 py-3 rounded hover:bg-blue-600/20 hover:text-blue-400 transition-colors text-blue-300 cursor-pointer font-bold h-full"><Database className="w-3 h-3" /> VIEW GALLERY</div></Link>
                          {hash && <a href={`https://sepolia.etherscan.io/tx/${hash}`} target="_blank" rel="noreferrer" className="flex items-center justify-center gap-2 text-xs font-mono bg-[#0B0C10] border border-white/10 py-3 rounded hover:border-white/30 transition-colors text-slate-400 h-full"><ExternalLink className="w-3 h-3" /> ETHERSCAN</a>}
                        </div>
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </CardContent>
            </Card>
          </motion.div>
        </div>
      </div>
    </div>
  );
}
]]>
  </file>
  <file path="app/page.tsx">
<![CDATA[
'use client';

import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, Variants } from 'framer-motion';
import { 
  ArrowRight, Github, 
  Database, Cpu, Activity, Box 
} from 'lucide-react';
import { Button } from '@/components/ui/button';
import { CardContent } from '@/components/ui/card';

// --- å¼•å…¥æ ¸å¿ƒä¸šåŠ¡ç»„ä»¶ ---
import MessageWall from '@/components/MessageWall'; 
import Leaderboard from '@/components/Leaderboard';
import TradeDashboard from '@/components/TradeDashboard'; // âœ… å¼•å…¥åˆšæ‰æ–°å»ºçš„ç»„ä»¶
import ClaimButton from '@/components/ClaimButton'; 
import TokenBalance from '@/components/TokenBalance'; 
import { SpotlightCard } from '@/components/ui/spotlight-card'; 

// --- åŠ¨ç”»é…ç½® ---
const staggerContainer: Variants = {
  hidden: { opacity: 0 },
  visible: {
    opacity: 1,
    transition: { staggerChildren: 0.12, delayChildren: 0.2 },
  },
};

const textReveal: Variants = {
  hidden: { y: 20, opacity: 0 },
  visible: {
    y: 0,
    opacity: 1,
    transition: { type: "spring", damping: 12, stiffness: 100 },
  },
};

const fadeInUp = {
  initial: { opacity: 0, y: 30 },
  whileInView: { opacity: 1, y: 0 },
  viewport: { once: true },
  transition: { duration: 0.8, ease: "easeOut" as const }
};

export default function Home() {
  const titleWords = "Decentralized Asset Ecosystem.".split(" ");

  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-blue-500/30 overflow-x-hidden font-sans">
      
      {/* 1. åŠ¨æ€èƒŒæ™¯ */}
      <div className="fixed inset-0 z-0 pointer-events-none overflow-hidden">
        <div className="absolute inset-0 bg-[#0B0C10]" />
        <div 
          className="absolute top-[-50%] left-[-50%] w-[200%] h-[200%] opacity-20 animate-aurora mix-blend-screen"
          style={{
            backgroundImage: `
              radial-gradient(circle at center, rgba(59, 130, 246, 0.4) 0%, transparent 50%), 
              radial-gradient(circle at center, rgba(147, 51, 234, 0.4) 0%, transparent 50%)
            `,
            backgroundSize: '80% 80%, 60% 60%',
            backgroundRepeat: 'no-repeat',
          }}
        />
        <div className="absolute inset-0 opacity-[0.03]" 
             style={{ backgroundImage: `url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E")` }}>
        </div>
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>

      {/* 2. å¯¼èˆªæ  */}
      <nav className="relative z-50 border-b border-white/5 bg-[#0B0C10]/50 backdrop-blur-xl">
        <div className="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center shadow-lg shadow-blue-500/30">
              <Box className="w-5 h-5 text-white" />
            </div>
            <span className="text-lg font-bold tracking-tight text-white">
              Kiki<span className="text-blue-500">Protocol</span>
            </span>
          </div>
          <div className="flex items-center gap-4">
            <TokenBalance />
            <ConnectButton.Custom>
              {({ account, chain, openAccountModal, openChainModal, openConnectModal, mounted }) => {
                const ready = mounted;
                const connected = ready && account && chain;
                return (
                  <div {...(!ready && { 'aria-hidden': true, 'style': { opacity: 0, pointerEvents: 'none' } })}>
                    {(() => {
                      if (!connected) return <Button onClick={openConnectModal} size="sm" className="bg-white text-black hover:bg-slate-200 font-semibold rounded-full px-6">Connect Wallet</Button>;
                      if (chain.unsupported) return <Button variant="destructive" size="sm" onClick={openChainModal}>Wrong Network</Button>;
                      return <Button onClick={openAccountModal} size="sm" variant="outline" className="border-white/10 bg-white/5 hover:bg-white/10 text-white font-mono rounded-full">{account.displayName}</Button>;
                    })()}
                  </div>
                );
              }}
            </ConnectButton.Custom>
          </div>
        </div>
      </nav>

      {/* 3. Hero Section */}
      <main className="relative z-10 max-w-7xl mx-auto px-6 pt-32 pb-32">
        <div className="flex flex-col items-start max-w-5xl mb-32">
          <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }} transition={{ delay: 0.1 }} className="flex items-center gap-2 px-4 py-1.5 mb-8 rounded-full border border-blue-500/20 bg-blue-500/10 backdrop-blur-md">
            <span className="relative flex h-2 w-2">
              <span className="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
              <span className="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
            </span>
            <span className="text-blue-300 text-xs font-bold tracking-widest uppercase">Live on Sepolia Testnet</span>
          </motion.div>
          
          <motion.div variants={staggerContainer} initial="hidden" animate="visible" className="mb-8">
            <h1 className="text-6xl md:text-8xl font-bold tracking-tighter text-white leading-[1.1] flex flex-wrap gap-x-4">
              {titleWords.map((word, index) => (
                <motion.span key={index} variants={textReveal} className={word === "Ecosystem." ? "text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-400" : ""}>
                  {word}
                </motion.span>
              ))}
            </h1>
          </motion.div>

          <motion.p initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.6, duration: 0.8 }} className="text-xl text-slate-400 max-w-2xl mb-12 leading-relaxed font-light">
            Experience the future of Web3 asset management. A full-stack experiment integrating <span className="text-white font-medium">ERC-721 issuance</span>, <span className="text-white font-medium"> dynamic staking yields</span>, and on-chain governance.
          </motion.p>

          <div className="flex flex-col gap-8 w-full sm:w-auto">
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.7 }}>
               <ClaimButton />
            </motion.div>

            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.8 }} className="flex flex-col sm:flex-row gap-4">
              <Link href="/dashboard"><Button size="lg" className="w-full sm:w-auto bg-white text-black hover:bg-slate-200 px-8 h-14 text-base font-bold rounded-full transition-all hover:scale-105">Launch App <ArrowRight className="ml-2 w-5 h-5" /></Button></Link>
              <Link href="https://github.com/miaojiayi123/nft-web" target="_blank"><Button size="lg" variant="outline" className="w-full sm:w-auto border-white/20 bg-white/5 hover:bg-white/10 text-white px-8 h-14 text-base rounded-full backdrop-blur-sm transition-all hover:scale-105"><Github className="mr-2 w-5 h-5" /> View Source</Button></Link>
            </motion.div>
          </div>
        </div>

        {/* 4. Protocol Mechanics */}
        <motion.div {...fadeInUp} className="mb-32">
          <div className="flex items-center gap-4 mb-10 border-b border-white/5 pb-4">
            <Cpu className="w-6 h-6 text-blue-500" />
            <h2 className="text-2xl font-bold text-white">Protocol Mechanics</h2>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
            <TechCard index="01" title="Token Faucet" subtitle="Initial Distribution" desc="Receive 100 $KIKI testnet tokens instantly to jumpstart your ecosystem journey." />
            <TechCard index="02" title="Treasury Mint" subtitle="Burn Mechanism" desc="Deflationary model. Burn 20 $KIKI to mint unique generative NFT assets." />
            <TechCard index="03" title="Staking Yield" subtitle="Passive Income" desc="Stake assets to earn 0.01 $KIKI/s APY. Real-time off-chain calculation." />
            <TechCard index="04" title="Token Gated" subtitle="Access Control" desc="Exclusive verification system unlocking private community channels." />
          </div>
        </motion.div>

        {/* --- 5. Market Data (åŒ…å«äº¤æ˜“é¢æ¿ & æ’è¡Œæ¦œ) --- */}
        <motion.div {...fadeInUp} className="mb-32">
          <div className="flex items-center justify-between mb-10 border-b border-white/5 pb-4">
            <div className="flex items-center gap-4">
              <Database className="w-6 h-6 text-purple-500" />
              <h2 className="text-2xl font-bold text-white">Market Data</h2>
            </div>
            <span className="text-xs font-mono text-slate-500 uppercase flex items-center gap-2">
              <span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
              Live Sync
            </span>
          </div>
          
          {/* âœ… åµŒå…¥ï¼šç‹¬ç«‹çš„äº¤æ˜“ä»ªè¡¨ç›˜ç»„ä»¶ */}
          <div className="mb-12 border border-white/10 rounded-2xl overflow-hidden bg-[#0e1015]/50 backdrop-blur-sm">
             <TradeDashboard />
          </div>
          
          {/* æ’è¡Œæ¦œç»„ä»¶ */}
          <Leaderboard />
        </motion.div>

        {/* 6. Activity */}
        <motion.div {...fadeInUp}>
          <div className="flex items-center gap-4 mb-10 border-b border-white/5 pb-4">
            <Activity className="w-6 h-6 text-green-500" />
            <h2 className="text-2xl font-bold text-white">On-chain Activity</h2>
          </div>
          <MessageWall />
        </motion.div>
      </main>

      {/* Footer */}
      <footer className="border-t border-white/5 bg-[#050608]/80 backdrop-blur-lg py-12 relative z-10">
        <div className="max-w-7xl mx-auto px-6 flex flex-col md:flex-row justify-between items-center text-xs text-slate-600 font-mono">
          <div className="flex items-center gap-2">
             <div className="w-2 h-2 bg-slate-700 rounded-full"></div>
             <p>KIKI PROTOCOL Â© 2025</p>
          </div>
          <div className="flex gap-8 mt-4 md:mt-0">
            <Link href="/dashboard" className="hover:text-slate-400 transition-colors">DASHBOARD</Link>
            <Link href="/mint" className="hover:text-slate-400 transition-colors">MINT</Link>
            <Link href="/training" className="hover:text-slate-400 transition-colors">STAKE</Link>
          </div>
        </div>
      </footer>
    </div>
  );
}

// TechCard ç»„ä»¶ä¿æŒåœ¨æ–‡ä»¶åº•éƒ¨ï¼Œå› ä¸ºå®ƒåªåœ¨è¿™é‡Œç”¨
function TechCard({ index, title, subtitle, desc }: { index: string, title: string, subtitle: string, desc: string }) {
  return (
    <SpotlightCard className="h-full group hover:bg-[#15171f] transition-colors" spotlightColor="rgba(59, 130, 246, 0.15)">
      <CardContent className="p-6 flex flex-col h-full">
        <div className="text-xs font-mono text-slate-600 mb-4 group-hover:text-blue-500 transition-colors">
          / {index}
        </div>
        <h3 className="text-lg font-bold text-white mb-1 group-hover:text-blue-100 transition-colors">{title}</h3>
        <p className="text-xs text-blue-400 font-mono mb-4 uppercase tracking-wider">{subtitle}</p>
        <p className="text-sm text-slate-400 leading-relaxed mt-auto">
          {desc}
        </p>
      </CardContent>
    </SpotlightCard>
  )
}
]]>
  </file>
  <file path="app/secret/page.tsx">
<![CDATA[
'use client';

import { useAccount, useReadContract } from 'wagmi';
import { Card, CardContent } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { 
  Lock, 
  Unlock, 
  Gem, 
  ArrowLeft, 
  ShieldCheck, 
  AlertCircle, 
  Wallet, 
  Loader2,
  ExternalLink
} from 'lucide-react';
import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, AnimatePresence } from 'framer-motion';

// âœ… å¼•å…¥ä½™é¢ç»„ä»¶ (ä¿æŒå¤´éƒ¨ä¸€è‡´æ€§)
import TokenBalance from '@/components/TokenBalance';

// NFT åˆçº¦åœ°å€
const CONTRACT_ADDRESS = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 

// ABI: åªéœ€æŸ¥è¯¢ä½™é¢
const contractAbi = [
  {
    inputs: [{ name: "owner", type: "address" }],
    name: "balanceOf",
    outputs: [{ name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
] as const;

export default function SecretPage() {
  const { address, isConnected } = useAccount();

  // è¯»å–å½“å‰ç”¨æˆ·æŒæœ‰çš„ NFT æ•°é‡
  const { data: balance, isLoading } = useReadContract({
    address: CONTRACT_ADDRESS,
    abi: contractAbi,
    functionName: 'balanceOf',
    args: address ? [address] : undefined,
    query: {
      refetchOnWindowFocus: true,
    }
  });

  const hasNft = balance && Number(balance) > 0;

  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-purple-500/30 font-sans flex flex-col">
      
      {/* 1. èƒŒæ™¯åº•å™ª */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-20%] left-[20%] w-[600px] h-[600px] bg-purple-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute bottom-[-10%] right-[-10%] w-[600px] h-[600px] bg-blue-900/10 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>
      
      {/* 2. é¡¶éƒ¨å¯¼èˆª */}
      <nav className="relative z-10 w-full p-6 flex justify-between items-center max-w-7xl mx-auto">
        <div className="flex flex-col gap-1">
          <Link href="/dashboard" className="inline-flex items-center text-xs font-mono text-slate-500 hover:text-blue-400 transition-colors mb-1 uppercase tracking-wide">
            <ArrowLeft className="mr-2 h-3 w-3" /> RETURN TO DASHBOARD
          </Link>
        </div>
        
        <div className="flex items-center gap-4 bg-[#12141a]/50 p-2 rounded-xl border border-white/5 backdrop-blur-sm">
          <TokenBalance />
          <ConnectButton />
        </div>
      </nav>

      {/* 3. æ ¸å¿ƒå†…å®¹åŒº */}
      <main className="flex-1 flex flex-col items-center justify-center p-6 relative z-10 w-full max-w-lg mx-auto pb-20">
        
        {/* æ ‡é¢˜ */}
        <div className="text-center mb-10">
          <div className="inline-flex items-center justify-center p-3 bg-white/5 rounded-2xl mb-4 border border-white/5 shadow-xl">
             <ShieldCheck className="w-8 h-8 text-purple-500" />
          </div>
          <h1 className="text-3xl font-bold text-white tracking-tight mb-2">
            Token Gated Access
          </h1>
          <p className="text-slate-400 font-light text-sm">
            Exclusive content for <span className="text-white font-mono">Genesis Asset</span> holders only.
          </p>
        </div>

        {/* çŠ¶æ€å¡ç‰‡åˆ‡æ¢ */}
        <div className="w-full">
          <AnimatePresence mode="wait">
            
            {!isConnected ? (
              // ğŸ”´ çŠ¶æ€ 1: æœªè¿æ¥é’±åŒ…
              <motion.div 
                key="disconnected"
                initial={{ opacity: 0, y: 10 }}
                animate={{ opacity: 1, y: 0 }}
                exit={{ opacity: 0, y: -10 }}
              >
                <Card className="bg-[#12141a] border-white/5 backdrop-blur-sm shadow-2xl">
                  <CardContent className="p-8 text-center">
                    <div className="w-16 h-16 bg-white/5 rounded-full flex items-center justify-center mx-auto mb-6 border border-white/10">
                      <Wallet className="w-6 h-6 text-slate-500" />
                    </div>
                    <h2 className="text-xl font-bold text-white mb-2">Verification Required</h2>
                    <p className="text-slate-500 text-sm mb-8 leading-relaxed">
                      Please connect your wallet to verify ownership of the required NFT assets.
                    </p>
                    <div className="flex justify-center">
                       <ConnectButton />
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            ) : isLoading ? (
              // ğŸŸ¡ çŠ¶æ€ 2: è¯»å–ä¸­
              <motion.div 
                key="loading"
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                className="text-center py-10"
              >
                 <Loader2 className="w-10 h-10 text-purple-500 animate-spin mx-auto mb-4" />
                 <p className="text-slate-500 font-mono text-xs uppercase tracking-widest">Verifying On-Chain Data...</p>
              </motion.div>
            ) : hasNft ? (
              // ğŸŸ¢ çŠ¶æ€ 3: éªŒè¯é€šè¿‡
              <motion.div 
                key="success"
                initial={{ scale: 0.95, opacity: 0 }} 
                animate={{ scale: 1, opacity: 1 }}
                transition={{ type: "spring", bounce: 0.4 }}
              >
                <Card className="bg-[#12141a] border-purple-500/30 overflow-hidden relative shadow-[0_0_50px_rgba(168,85,247,0.15)]">
                  {/* é¡¶éƒ¨é«˜äº®æ¡ */}
                  <div className="h-1 w-full bg-gradient-to-r from-purple-500 to-blue-500"></div>
                  
                  <CardContent className="p-8 text-center relative z-10">
                    <div className="w-16 h-16 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/20 shadow-[0_0_20px_rgba(34,197,94,0.2)]">
                      <Unlock className="w-8 h-8 text-green-400" />
                    </div>
                    
                    <h2 className="text-2xl font-bold text-white mb-2">Access Granted</h2>
                    <p className="text-slate-400 text-sm mb-8">
                      Ownership verified. Welcome to the inner circle, Agent.
                    </p>
                    
                    <div className="space-y-4">
                      <div className="p-4 bg-white/5 rounded-xl border border-white/5 text-left flex items-start gap-4 hover:bg-white/10 transition-colors cursor-pointer group">
                        <div className="bg-purple-500/20 p-2.5 rounded-lg shrink-0">
                          <Gem className="w-5 h-5 text-purple-400 group-hover:scale-110 transition-transform" />
                        </div>
                        <div>
                          <h4 className="font-bold text-sm text-white group-hover:text-purple-300 transition-colors">Exclusive Community</h4>
                          <p className="text-xs text-slate-500 mt-1 leading-relaxed">
                            Access the private Discord channel and developer resources.
                          </p>
                        </div>
                      </div>

                      {/* ç¤¼ç‰©æŒ‰é’® */}
                      <Link href="/gift" className="block w-full">
                        <Button className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold h-12 text-sm uppercase tracking-wide shadow-lg transition-all hover:scale-[1.02]">
                          <ExternalLink className="mr-2 w-4 h-4" /> Claim Mystery Gift
                        </Button>
                      </Link>
                    </div>
                  </CardContent>
                  
                  {/* èƒŒæ™¯è£…é¥°å…‰ */}
                  <div className="absolute top-0 left-0 w-full h-full bg-purple-500/5 pointer-events-none"></div>
                </Card>
              </motion.div>
            ) : (
              // ğŸ”´ çŠ¶æ€ 4: éªŒè¯å¤±è´¥
              <motion.div 
                key="denied"
                initial={{ opacity: 0, x: 20 }} 
                animate={{ opacity: 1, x: 0 }}
              >
                <Card className="bg-[#12141a] border-red-900/30 overflow-hidden relative shadow-2xl">
                  <div className="h-1 w-full bg-red-900/50"></div>
                  <CardContent className="p-8 text-center">
                    <div className="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20">
                      <Lock className="w-8 h-8 text-red-500" />
                    </div>
                    <h2 className="text-2xl font-bold text-white mb-2">Access Denied</h2>
                    <p className="text-slate-400 text-sm mb-8 leading-relaxed max-w-xs mx-auto">
                      Required asset <span className="text-white font-bold font-mono">Genesis NFT</span> not found in connected wallet.
                    </p>
                    
                    <div className="flex flex-col gap-3">
                      <Link href="/mint" className="w-full">
                        <Button className="w-full bg-white text-black hover:bg-slate-200 font-bold h-12 text-sm uppercase tracking-wide">
                           Mint Access Pass
                        </Button>
                      </Link>
                      <a href="https://opensea.io" target="_blank" className="text-xs text-slate-600 hover:text-slate-400 font-mono transition-colors mt-2 block">
                        BUY ON SECONDARY MARKET &rarr;
                      </a>
                    </div>
                  </CardContent>
                </Card>
              </motion.div>
            )}

          </AnimatePresence>
        </div>

      </main>
    </div>
  );
}
]]>
  </file>
  <file path="app/training/page.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount } from 'wagmi';
import { supabase } from '@/lib/supabaseClient';
import { Button } from '@/components/ui/button';
import { 
  ArrowLeft, BrainCircuit, Play, Loader2, 
  Timer, Database, RefreshCw, Wallet, Coins, AlertTriangle, X,
  LayoutGrid // âœ… è¡¥ä¸Šäº†è¿™ä¸ª
} from 'lucide-react';
import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, AnimatePresence } from 'framer-motion';
import TokenBalance from '@/components/TokenBalance';
import { logActivity } from '@/lib/logger'; 

// NFT åˆçº¦
const CONTRACT_ADDRESS = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 

interface NFT {
  contract: { address: string };
  id: { tokenId: string };
  title: string;
  media: { gateway: string }[];
}

interface StakingRecord {
  token_id: string;
  staked_at: string; 
}

// è¾…åŠ©å‡½æ•°
const formatTokenId = (rawId: string) => {
  try {
    return BigInt(rawId).toString();
  } catch (e) {
    return rawId;
  }
};

// --- ç»„ä»¶ï¼šå®æ—¶æ”¶ç›Šæ•°å­— ---
const LiveYield = ({ stakedAt }: { stakedAt: string }) => {
  const [reward, setReward] = useState('0.0000');
  useEffect(() => {
    const update = () => {
      const start = new Date(stakedAt).getTime();
      const now = Date.now();
      const seconds = (now - start) / 1000;
      setReward((seconds * 0.01).toFixed(4));
    };
    update();
    const timer = setInterval(update, 100);
    return () => clearInterval(timer);
  }, [stakedAt]);
  return <span className="font-mono text-green-400 font-bold tabular-nums">{reward}</span>;
};

export default function TrainingPage() {
  const { address, isConnected, chain } = useAccount();

  // State
  const [walletNfts, setWalletNfts] = useState<NFT[]>([]); 
  const [stakedNfts, setStakedNfts] = useState<StakingRecord[]>([]); 
  
  // NFT å­—å…¸ï¼Œç”¨äºé€šè¿‡ ID å¿«é€ŸæŸ¥æ‰¾å›¾ç‰‡
  const [nftMap, setNftMap] = useState<Record<string, NFT>>({});
  
  // å¼¹çª—çŠ¶æ€
  const [unstakeModal, setUnstakeModal] = useState<{ isOpen: boolean; record: StakingRecord | null }>({
    isOpen: false,
    record: null
  });

  const [isLoading, setIsLoading] = useState(false);
  const [processingId, setProcessingId] = useState<string | null>(null);

  // åˆå§‹åŒ–æ•°æ®
  const initData = async () => {
    if (!address) return;
    setIsLoading(true);

    try {
      const apiKey = process.env.NEXT_PUBLIC_ALCHEMY_API_KEY;
      const networkPrefix = chain?.id === 1 ? 'eth-mainnet' : 'eth-sepolia';
      const url = `https://${networkPrefix}.g.alchemy.com/nft/v2/${apiKey}/getNFTs?owner=${address}&contractAddresses[]=${CONTRACT_ADDRESS}&withMetadata=true`;
      
      const resNft = await fetch(url);
      const dataNft = await resNft.json();
      const allNfts: NFT[] = dataNft.ownedNfts || [];

      // 1. æ„å»º NFT æ˜ å°„è¡¨
      const newMap: Record<string, NFT> = {};
      allNfts.forEach(nft => {
        const cleanId = formatTokenId(nft.id.tokenId);
        newMap[cleanId] = nft;
      });
      setNftMap(newMap);

      // 2. è·å–è´¨æŠ¼è®°å½•
      const { data: stakingData } = await supabase
        .from('staking')
        .select('*')
        .eq('wallet_address', address);

      // å»é‡
      const uniqueRecords = new Map();
      (stakingData || []).forEach((item: any) => {
        const cleanId = formatTokenId(item.token_id);
        if (!uniqueRecords.has(cleanId)) uniqueRecords.set(cleanId, item);
      });
      const stakedRecords = Array.from(uniqueRecords.values()) as StakingRecord[];
      setStakedNfts(stakedRecords);

      // 3. è¿‡æ»¤å‡ºæœªè´¨æŠ¼çš„
      const stakedIdSet = new Set(stakedRecords.map(r => formatTokenId(r.token_id)));
      const available = allNfts.filter(nft => !stakedIdSet.has(formatTokenId(nft.id.tokenId)));
      setWalletNfts(available);

    } catch (error) {
      console.error("Fetch error:", error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    if (isConnected) initData();
  }, [isConnected, address]);

  // --- åŠ¨ä½œï¼šè´¨æŠ¼ ---
  const handleStake = async (nft: NFT) => {
    if (!address) return;
    const tokenIdDec = BigInt(nft.id.tokenId).toString();

    const { error } = await supabase
      .from('staking')
      .insert([{ wallet_address: address, token_id: tokenIdDec, staked_at: new Date().toISOString() }]);

    if (!error) {
      await logActivity({ address, type: 'STAKE', details: `Staked Token #${tokenIdDec}` });
      initData();
    }
  };

  // --- åŠ¨ä½œï¼šå•ç‹¬é¢†å– ---
  const handleClaimReward = async (record: StakingRecord) => {
    if (!address) return;
    setProcessingId(record.token_id);

    try {
      const start = new Date(record.staked_at).getTime();
      const reward = ((Date.now() - start) / 1000 * 0.01).toFixed(4);
      
      if (parseFloat(reward) <= 0) {
        alert("Rewards are too low to claim yet.");
        return;
      }

      const res = await fetch('/api/claim-reward', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ address, amount: reward, tokenId: record.token_id })
      });
      
      const result = await res.json();
      if (!res.ok) throw new Error(result.error);

      await supabase.from('staking').update({ staked_at: new Date().toISOString() }).eq('wallet_address', address).eq('token_id', record.token_id);
      await logActivity({ address, type: 'CLAIM', details: `Yield: ${reward} KIKI`, hash: result.txHash });
      
      alert(`Success! ${reward} KIKI claimed.`);
      initData();
    } catch (e: any) {
      alert(e.message);
    } finally {
      setProcessingId(null);
    }
  };

  // --- åŠ¨ä½œï¼šè§¦å‘å¼¹çª— ---
  const openUnstakeModal = (record: StakingRecord) => {
    setUnstakeModal({ isOpen: true, record });
  };

  // --- åŠ¨ä½œï¼šç¡®è®¤è§£é™¤è´¨æŠ¼ ---
  const confirmUnstake = async () => {
    const record = unstakeModal.record;
    if (!address || !record) return;

    setProcessingId('MODAL_LOADING');

    try {
      // 1. Auto Claim
      const start = new Date(record.staked_at).getTime();
      const reward = ((Date.now() - start) / 1000 * 0.01).toFixed(4);
      
      if (parseFloat(reward) > 0) {
        const res = await fetch('/api/claim-reward', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ address, amount: reward, tokenId: record.token_id })
        });
        if (res.ok) {
           const data = await res.json();
           await logActivity({ address, type: 'CLAIM', details: `Yield: ${reward} KIKI (Auto)`, hash: data.txHash });
        }
      }

      // 2. Delete Record
      await supabase.from('staking').delete().eq('wallet_address', address).eq('token_id', record.token_id);
      await logActivity({ address, type: 'TRANSFER', details: `Unstaked Token #${formatTokenId(record.token_id)}` });

      setUnstakeModal({ isOpen: false, record: null });
      initData();

    } catch (e: any) {
      alert("Unstake failed: " + e.message);
    } finally {
      setProcessingId(null);
    }
  };

  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 font-sans">
      <div className="fixed inset-0 z-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>

      {/* --- è‡ªå®šä¹‰å¼¹çª— --- */}
      <AnimatePresence>
        {unstakeModal.isOpen && unstakeModal.record && (
          <motion.div 
            initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}
            className="fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4"
          >
            <motion.div 
              initial={{ scale: 0.95, y: 10 }} animate={{ scale: 1, y: 0 }} exit={{ scale: 0.95, y: 10 }}
              className="bg-[#12141a] border border-white/10 w-full max-w-md rounded-2xl p-6 shadow-2xl relative overflow-hidden"
            >
              <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-blue-500"></div>
              
              <div className="flex justify-between items-start mb-6">
                <div className="flex items-center gap-3 text-yellow-500">
                  <div className="p-2 bg-yellow-500/10 rounded-lg"><AlertTriangle className="w-6 h-6" /></div>
                  <h3 className="text-xl font-bold text-white">Confirm Unstake</h3>
                </div>
                <button onClick={() => setUnstakeModal({ isOpen: false, record: null })} className="text-slate-500 hover:text-white transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>

              <div className="space-y-4 mb-8">
                <p className="text-slate-400 text-sm leading-relaxed">
                  You are about to unstake <strong className="text-white">Token #{formatTokenId(unstakeModal.record.token_id)}</strong>.
                  <br/><br/>
                  We will automatically <span className="text-green-400 font-bold">claim your pending rewards</span> before returning the asset to your available balance.
                </p>
                
                <div className="flex items-center gap-4 bg-white/5 p-3 rounded-xl border border-white/5">
                   <img 
                      src={nftMap[formatTokenId(unstakeModal.record.token_id)]?.media?.[0]?.gateway || '/kiki.png'} 
                      className="w-12 h-12 rounded-lg object-cover bg-black"
                   />
                   <div>
                      <div className="text-xs text-slate-500 font-mono">PENDING REWARDS</div>
                      <div className="text-lg text-green-400 font-bold font-mono">
                         <LiveYield stakedAt={unstakeModal.record.staked_at} /> KIKI
                      </div>
                   </div>
                </div>
              </div>

              <div className="flex gap-3">
                <Button 
                  variant="outline" 
                  onClick={() => setUnstakeModal({ isOpen: false, record: null })}
                  className="flex-1 border-white/10 hover:bg-white/5 h-12 text-slate-300"
                  disabled={processingId === 'MODAL_LOADING'}
                >
                  Cancel
                </Button>
                <Button 
                  onClick={confirmUnstake}
                  className="flex-1 bg-white text-black hover:bg-slate-200 h-12 font-bold"
                  disabled={processingId === 'MODAL_LOADING'}
                >
                  {processingId === 'MODAL_LOADING' ? <><Loader2 className="w-4 h-4 animate-spin mr-2"/> Processing...</> : "Confirm & Claim"}
                </Button>
              </div>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      <div className="relative z-10 max-w-7xl mx-auto px-6 py-10">
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-16">
          <div className="flex flex-col gap-1">
            <Link href="/dashboard" className="inline-flex items-center text-xs font-mono text-slate-500 hover:text-white transition-colors mb-2 uppercase tracking-wide">
              <ArrowLeft className="mr-2 h-3 w-3" /> RETURN TO DASHBOARD
            </Link>
            <h1 className="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
              <BrainCircuit className="w-8 h-8 text-green-500" />
              Yield Farming
            </h1>
          </div>
          <div className="flex items-center gap-4 bg-[#12141a]/50 p-2 rounded-xl border border-white/5 backdrop-blur-sm">
            <TokenBalance />
            <ConnectButton />
          </div>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
          
          {/* å·¦ä¾§ï¼šAvailable */}
          <div className="space-y-6">
            <div className="flex items-center gap-2 mb-4 border-b border-white/5 pb-4">
              <Wallet className="w-5 h-5 text-blue-500" />
              <h2 className="text-lg font-bold text-white">Available to Stake</h2>
              <button onClick={initData} className="ml-auto text-slate-500 hover:text-white"><RefreshCw className="w-4 h-4"/></button>
            </div>
            <div className="max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
              <div className="grid grid-cols-2 sm:grid-cols-3 gap-4">
                {walletNfts.map(nft => {
                  const tokenId = formatTokenId(nft.id.tokenId);
                  return (
                    <motion.div 
                      key={tokenId} whileHover={{ scale: 1.02 }} 
                      className="bg-[#12141a] border border-white/5 rounded-xl overflow-hidden group cursor-pointer relative" 
                      onClick={() => handleStake(nft)}
                    >
                      <div className="aspect-square bg-slate-800 relative">
                        <img src={nft.media?.[0]?.gateway || '/kiki.png'} className="w-full h-full object-cover opacity-80 group-hover:opacity-100 transition-opacity" onError={(e) => (e.target as HTMLImageElement).src = '/kiki.png'} />
                        <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-[2px]">
                          <span className="bg-green-500 text-white text-[10px] font-bold px-3 py-1.5 rounded-full flex items-center gap-1 shadow-lg"><Play className="w-3 h-3 fill-current" /> STAKE</span>
                        </div>
                      </div>
                      <div className="p-3 bg-[#0e1016]"><div className="text-xs font-bold text-white truncate">#{tokenId}</div></div>
                    </motion.div>
                  )
                })}
              </div>
              {walletNfts.length === 0 && !isLoading && (
                 <div className="flex flex-col items-center justify-center py-16 border border-dashed border-white/10 rounded-xl bg-white/5 text-center">
                   <LayoutGrid className="w-8 h-8 text-slate-600 mb-2" />
                   <p className="text-slate-500 text-sm">No unstaked assets found.</p>
                 </div>
              )}
            </div>
          </div>

          {/* å³ä¾§ï¼šActive Staking */}
          <div className="space-y-6">
            <div className="flex items-center gap-2 mb-4 border-b border-white/5 pb-4">
              <Database className="w-5 h-5 text-green-500" />
              <h2 className="text-lg font-bold text-white">Active Staking</h2>
              <span className="bg-green-500/10 text-green-400 text-xs px-2 py-0.5 rounded ml-auto font-mono border border-green-500/20">APY: 0.01 KIKI/s</span>
            </div>
            <div className="max-h-[600px] overflow-y-auto pr-2 custom-scrollbar space-y-3">
              {isLoading ? (
                 <div className="flex flex-col items-center justify-center py-20 text-slate-500 text-sm gap-3"><Loader2 className="animate-spin w-6 h-6 text-green-500"/> Syncing...</div>
              ) : stakedNfts.length === 0 ? (
                 <div className="p-8 border border-dashed border-white/10 rounded-xl text-center text-slate-500 text-sm bg-white/5">No assets staked.</div>
              ) : (
                 stakedNfts.map(record => {
                   const cleanId = formatTokenId(record.token_id);
                   const isProcessing = processingId === record.token_id;
                   const nftData = nftMap[cleanId];
                   const imgSrc = nftData?.media?.[0]?.gateway || '/kiki.png';

                   return (
                     <div key={record.token_id} className="bg-[#12141a] border border-white/5 p-4 rounded-xl flex flex-col sm:flex-row items-center justify-between group hover:border-green-500/30 transition-all gap-4">
                       <div className="flex items-center gap-4 w-full sm:w-auto">
                          <div className="w-12 h-12 bg-black rounded-lg overflow-hidden border border-white/10 shrink-0 relative">
                            <img src={imgSrc} alt="Asset" className="w-full h-full object-cover" />
                          </div>
                          <div>
                            <div className="text-sm font-bold text-white">Token #{cleanId}</div>
                            <div className="text-xs text-slate-500 font-mono flex items-center gap-1.5 mt-1">
                               <Coins className="w-3 h-3 text-yellow-500" />
                               Pending: <LiveYield stakedAt={record.staked_at} />
                            </div>
                          </div>
                       </div>
                       <div className="flex gap-2 w-full sm:w-auto">
                          <Button 
                            size="sm" onClick={() => handleClaimReward(record)} disabled={isProcessing}
                            className="flex-1 sm:flex-none bg-white text-black hover:bg-slate-200 font-bold text-[10px] h-9 px-4"
                          >
                            {isProcessing ? <Loader2 className="w-3 h-3 animate-spin"/> : "CLAIM"}
                          </Button>
                          <Button 
                            size="sm" variant="outline"
                            onClick={() => openUnstakeModal(record)}
                            disabled={isProcessing}
                            className="flex-1 sm:flex-none border-white/10 text-slate-400 hover:text-white hover:border-white/30 text-[10px] h-9 px-3"
                          >
                            UNSTAKE
                          </Button>
                       </div>
                     </div>
                   )
                 })
              )}
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}
]]>
  </file>
  <file path="app/transfer/page.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { 
  ArrowLeft, 
  Send, 
  CheckCircle2, 
  Loader2, 
  LayoutGrid, 
  RefreshCw, 
  Wallet,
  ArrowRight,
  ShieldCheck
} from 'lucide-react';
import Link from 'next/link';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { motion, AnimatePresence } from 'framer-motion';

// âœ… å¼•å…¥ä½™é¢ç»„ä»¶
import TokenBalance from '@/components/TokenBalance';

const erc721Abi = [
  {
    inputs: [
      { name: "from", type: "address" },
      { name: "to", type: "address" },
      { name: "tokenId", type: "uint256" }
    ],
    name: "transferFrom",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  }
] as const;

interface NFT {
  contract: { address: string; name?: string };
  id: { tokenId: string };
  title: string;
  media: { gateway: string }[];
}

export default function TransferPage() {
  const { address, isConnected, chain } = useAccount();
  
  const [nfts, setNfts] = useState<NFT[]>([]);
  const [isLoading, setIsLoading] = useState(false);
  const [selectedNft, setSelectedNft] = useState<NFT | null>(null);
  const [recipient, setRecipient] = useState('');

  const { data: hash, writeContract, isPending } = useWriteContract();
  const { isLoading: isConfirming, isSuccess: isConfirmed } = 
    useWaitForTransactionReceipt({ hash });

  const fetchNFTs = async () => {
    if (!address || !chain) return;
    setIsLoading(true);
    try {
      const apiKey = process.env.NEXT_PUBLIC_ALCHEMY_API_KEY;
      let networkPrefix = 'eth-mainnet';
      if (chain.id === 11155111) networkPrefix = 'eth-sepolia';
      else if (chain.id === 1) networkPrefix = 'eth-mainnet';
      else { setIsLoading(false); return; }

      const baseURL = `https://${networkPrefix}.g.alchemy.com/nft/v2/${apiKey}/getNFTs`;
      const url = `${baseURL}?owner=${address}&withMetadata=true&pageSize=100`;

      const response = await fetch(url);
      const data = await response.json();
      setNfts(data.ownedNfts || []);
    } catch (error) {
      console.error("Failed to fetch NFTs:", error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    if (isConnected) fetchNFTs();
  }, [isConnected, address, chain]);

  useEffect(() => {
    if (isConfirmed) {
      setRecipient('');
      setSelectedNft(null);
      setTimeout(fetchNFTs, 2000); // Wait for indexer
    }
  }, [isConfirmed]);

  const handleTransfer = (e: React.FormEvent) => {
    e.preventDefault();
    if (!selectedNft || !recipient || !address) return;

    if (!recipient.startsWith('0x') || recipient.length !== 42) {
      alert("Invalid Wallet Address");
      return;
    }

    writeContract({
      address: selectedNft.contract.address as `0x${string}`,
      abi: erc721Abi,
      functionName: 'transferFrom',
      args: [address, recipient as `0x${string}`, BigInt(selectedNft.id.tokenId)],
    });
  };

  return (
    <div className="min-h-screen bg-[#0B0C10] text-slate-200 selection:bg-purple-500/30 font-sans">
      
      {/* èƒŒæ™¯åº•å™ª */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        <div className="absolute top-[-10%] right-[-10%] w-[600px] h-[600px] bg-purple-900/5 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute bottom-[-10%] left-[-10%] w-[600px] h-[600px] bg-blue-900/5 rounded-full blur-[120px] mix-blend-screen" />
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff05_1px,transparent_1px),linear-gradient(to_bottom,#ffffff05_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      </div>

      <div className="relative z-10 max-w-7xl mx-auto px-6 py-10">

        {/* é¡¶éƒ¨å¯¼èˆª */}
        <header className="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-16">
          <div className="flex flex-col gap-1">
            <Link href="/dashboard" className="inline-flex items-center text-xs font-mono text-slate-500 hover:text-blue-400 transition-colors mb-2 uppercase tracking-wide">
              <ArrowLeft className="mr-2 h-3 w-3" /> RETURN TO DASHBOARD
            </Link>
            <h1 className="text-3xl font-bold text-white tracking-tight flex items-center gap-3">
              <Send className="w-8 h-8 text-purple-500" />
              Asset Transfer
            </h1>
          </div>

          <div className="flex items-center gap-4 bg-[#12141a]/50 p-2 rounded-xl border border-white/5 backdrop-blur-sm">
            <TokenBalance />
            <ConnectButton />
          </div>
        </header>

        {/* ä¸»å†…å®¹åŒº */}
        <div className="flex flex-col lg:flex-row gap-12">
          
          {/* å·¦ä¾§ï¼šNFT é€‰æ‹©åŒº */}
          <div className="flex-1">
            <div className="flex items-center justify-between mb-6 border-b border-white/5 pb-4">
              <div className="flex items-center gap-2">
                <LayoutGrid className="w-5 h-5 text-slate-500" />
                <h2 className="text-lg font-bold text-white tracking-wide">SELECT ASSET</h2>
              </div>
              
              <button 
                onClick={fetchNFTs} 
                disabled={isLoading}
                className="flex items-center gap-2 text-xs font-mono text-slate-500 hover:text-white transition-colors group disabled:opacity-50 cursor-pointer outline-none uppercase tracking-wide"
              >
                {isLoading ? (
                  <Loader2 className="animate-spin w-3 h-3" /> 
                ) : (
                  <RefreshCw className="w-3 h-3 group-hover:rotate-180 transition-transform duration-500" /> 
                )}
                REFRESH INVENTORY
              </button>
            </div>

            {/* NFT Grid */}
            {isLoading ? (
              <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                {[...Array(6)].map((_, i) => (
                  <div key={i} className="aspect-square bg-[#12141a] rounded-xl animate-pulse border border-white/5" />
                ))}
              </div>
            ) : nfts.length === 0 ? (
              <div className="text-center py-20 bg-[#12141a]/50 rounded-2xl border border-white/5 border-dashed">
                <p className="text-slate-500 font-mono text-sm">NO ASSETS FOUND</p>
                <Link href="/mint" className="text-xs text-blue-400 hover:underline mt-2 inline-block">Mint new assets &rarr;</Link>
              </div>
            ) : (
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto pr-2 custom-scrollbar">
                {nfts.map((nft) => {
                   const isSelected = selectedNft?.id.tokenId === nft.id.tokenId && selectedNft?.contract.address === nft.contract.address;
                   const imageUrl = nft.media?.[0]?.gateway || '/kiki.png';
                   const tokenIdDec = parseInt(nft.id.tokenId, 16).toString();

                   return (
                     <motion.div
                       key={`${nft.contract.address}-${nft.id.tokenId}`}
                       whileHover={{ scale: 1.02 }}
                       whileTap={{ scale: 0.98 }}
                       onClick={() => setSelectedNft(nft)}
                       className={`cursor-pointer relative rounded-xl overflow-hidden transition-all duration-300 ${
                         isSelected 
                           ? 'border-2 border-purple-500 ring-4 ring-purple-500/20 shadow-[0_0_20px_rgba(168,85,247,0.3)]' 
                           : 'border border-white/5 hover:border-white/20'
                       }`}
                     >
                       <div className="aspect-square bg-[#12141a] relative">
                         <img 
                            src={imageUrl} 
                            alt={nft.title} 
                            className={`w-full h-full object-cover transition-all ${isSelected ? '' : 'opacity-80 hover:opacity-100'}`}
                            onError={(e) => (e.target as HTMLImageElement).src = '/kiki.png'} 
                          />
                         {isSelected && (
                           <div className="absolute inset-0 bg-purple-500/20 flex items-center justify-center backdrop-blur-[1px]">
                             <CheckCircle2 className="w-10 h-10 text-white drop-shadow-lg" />
                           </div>
                         )}
                       </div>
                       <div className={`p-3 text-xs border-t ${isSelected ? 'bg-purple-900/20 border-purple-500/30' : 'bg-[#0e1016] border-white/5'}`}>
                         <p className="font-bold truncate text-slate-200">{nft.title || 'Unknown Asset'}</p>
                         <p className="text-slate-500 font-mono mt-1">ID: {tokenIdDec}</p>
                       </div>
                     </motion.div>
                   )
                })}
              </div>
            )}
          </div>

          {/* å³ä¾§ï¼šå‘é€è¡¨å• */}
          <div className="lg:w-[420px] shrink-0">
            <div className="sticky top-24">
              <Card className="bg-[#12141a] border-white/5 shadow-2xl overflow-hidden">
                {/* è£…é¥°çº¿ */}
                <div className="h-1 w-full bg-gradient-to-r from-purple-500 to-blue-500"></div>
                
                <CardHeader>
                  <CardTitle className="flex items-center gap-2 text-white text-lg">
                    <ShieldCheck className="w-5 h-5 text-purple-500" /> 
                    Transaction Details
                  </CardTitle>
                </CardHeader>
                
                <CardContent>
                  <form onSubmit={handleTransfer} className="space-y-8">
                    
                    {/* 1. å·²é€‰èµ„äº§é¢„è§ˆ */}
                    <div className="space-y-3">
                      <Label className="text-xs font-mono text-slate-500 uppercase tracking-wider">Selected Asset</Label>
                      {selectedNft ? (
                        <div className="flex items-center gap-4 p-3 bg-black/20 rounded-lg border border-purple-500/30 relative overflow-hidden group">
                          <div className="absolute inset-0 bg-purple-500/5 group-hover:bg-purple-500/10 transition-colors"></div>
                          <img 
                            src={selectedNft.media?.[0]?.gateway || '/kiki.png'} 
                            className="w-16 h-16 rounded-md object-cover bg-slate-800 border border-white/10 z-10"
                            onError={(e) => (e.target as HTMLImageElement).src = '/kiki.png'} 
                          />
                          <div className="overflow-hidden z-10">
                            <h4 className="font-bold text-sm truncate text-white">{selectedNft.title || 'NFT Asset'}</h4>
                            <div className="flex items-center gap-2 mt-1">
                               <span className="text-[10px] bg-purple-500/20 text-purple-300 px-1.5 py-0.5 rounded font-mono border border-purple-500/20">ERC-721</span>
                               <span className="text-xs text-slate-500 font-mono">#{parseInt(selectedNft.id.tokenId, 16)}</span>
                            </div>
                          </div>
                        </div>
                      ) : (
                        <div className="p-8 border border-dashed border-white/10 rounded-lg text-center bg-black/20 flex flex-col items-center justify-center gap-2">
                          <LayoutGrid className="w-6 h-6 text-slate-600" />
                          <span className="text-slate-500 text-xs">Select an asset from the left</span>
                        </div>
                      )}
                    </div>

                    {/* 2. æ¥æ”¶åœ°å€ */}
                    <div className="space-y-3">
                      <Label htmlFor="to" className="text-xs font-mono text-slate-500 uppercase tracking-wider">Recipient Address</Label>
                      <div className="relative">
                        <Wallet className="absolute left-3 top-3.5 h-4 w-4 text-slate-500" />
                        <Input 
                          id="to"
                          placeholder="0x..." 
                          value={recipient}
                          onChange={(e) => setRecipient(e.target.value)}
                          className="pl-10 bg-black/20 border-white/10 text-white font-mono focus:border-purple-500 focus:ring-purple-500/20 h-11"
                        />
                      </div>
                    </div>

                    {/* 3. çŠ¶æ€åé¦ˆ */}
                    <AnimatePresence>
                      {isConfirmed && (
                        <motion.div 
                          initial={{ opacity: 0, height: 0 }}
                          animate={{ opacity: 1, height: 'auto' }}
                          exit={{ opacity: 0, height: 0 }}
                          className="bg-green-500/10 border border-green-500/20 text-green-400 text-sm p-3 rounded-lg flex items-center gap-2 overflow-hidden"
                        >
                          <CheckCircle2 className="w-4 h-4 shrink-0" /> 
                          <span className="font-mono text-xs">Transfer Confirmed On-chain!</span>
                        </motion.div>
                      )}
                    </AnimatePresence>

                    {/* 4. æäº¤æŒ‰é’® */}
                    <Button 
                      type="submit" 
                      className="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold h-12 text-base shadow-[0_0_20px_rgba(147,51,234,0.3)] transition-all"
                      disabled={!selectedNft || !recipient || isPending || isConfirming}
                    >
                      {isPending || isConfirming ? (
                        <><Loader2 className="mr-2 animate-spin w-4 h-4" /> PROCESSING...</>
                      ) : (
                        <div className="flex items-center gap-2">
                           CONFIRM TRANSFER <ArrowRight className="w-4 h-4" />
                        </div>
                      )}
                    </Button>
                  </form>
                </CardContent>
              </Card>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}
]]>
  </file>
  <file path="components/ActivityLog.tsx">
<![CDATA[
'use client';

import { useEffect, useState } from 'react';
import { useAccount } from 'wagmi';
import { supabase } from '@/lib/supabaseClient';
import { SpotlightCard } from '@/components/ui/spotlight-card'; // å¤ç”¨ä½ çš„èšå…‰ç¯å¡ç‰‡
import { CardContent } from '@/components/ui/card';
import { ExternalLink, Rocket, Zap, Gift, Send, History, Loader2 } from 'lucide-react';
import { formatDistanceToNow } from 'date-fns'; // å»ºè®®å®‰è£…: npm install date-fns

// å¦‚æœä¸æƒ³å®‰è£… date-fnsï¼Œå¯ä»¥ç”¨ç®€å•çš„ JS å‡½æ•°ä»£æ›¿ï¼Œä¸‹é¢æˆ‘ä¼šå†™ä¸€ä¸ªç®€å•çš„ formatDate

interface LogItem {
  id: number;
  action_type: string;
  details: string;
  tx_hash: string;
  created_at: string;
}

export default function ActivityLog() {
  const { address } = useAccount();
  const [logs, setLogs] = useState<LogItem[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchLogs = async () => {
      if (!address) return;
      
      const { data, error } = await supabase
        .from('activity_logs')
        .select('*')
        .eq('wallet_address', address)
        .order('created_at', { ascending: false }) // æœ€æ–°åœ¨å‰
        .limit(10); // åªæ˜¾ç¤ºæœ€è¿‘10æ¡

      if (!error && data) {
        setLogs(data);
      }
      setLoading(false);
    };

    fetchLogs();
    
    // ç®€å•çš„è½®è¯¢æœºåˆ¶ï¼Œä¿æŒæ•°æ®æ–°é²œ (æˆ–è€…ç”¨ Supabase å®æ—¶è®¢é˜…)
    const interval = setInterval(fetchLogs, 5000); 
    return () => clearInterval(interval);
  }, [address]);

  const getIcon = (type: string) => {
    switch (type) {
      case 'MINT': return <Rocket className="w-4 h-4 text-blue-400" />;
      case 'STAKE': return <Zap className="w-4 h-4 text-green-400" />;
      case 'CLAIM': return <Gift className="w-4 h-4 text-yellow-400" />;
      case 'TRANSFER': return <Send className="w-4 h-4 text-purple-400" />;
      default: return <History className="w-4 h-4 text-slate-400" />;
    }
  };

  // ç®€å•çš„ç›¸å¯¹æ—¶é—´æ ¼å¼åŒ–
  const timeAgo = (dateStr: string) => {
    const diff = (new Date().getTime() - new Date(dateStr).getTime()) / 1000;
    if (diff < 60) return 'Just now';
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return `${Math.floor(diff / 86400)}d ago`;
  };

  if (!address) return null;

  return (
    <SpotlightCard className="h-full" spotlightColor="rgba(255, 255, 255, 0.1)">
      <CardContent className="p-8">
        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <History className="w-5 h-5 text-slate-500" />
            <span className="text-xs font-mono font-bold text-slate-500 uppercase tracking-widest">Recent Activity</span>
          </div>
          {loading && <Loader2 className="w-3 h-3 animate-spin text-slate-600" />}
        </div>

        <div className="space-y-1">
          {logs.length === 0 && !loading ? (
            <div className="text-center py-8 text-slate-600 text-sm font-mono">NO TRANSACTIONS FOUND</div>
          ) : (
            logs.map((log) => (
              <div 
                key={log.id} 
                className="group flex items-center justify-between p-3 rounded-lg hover:bg-white/5 transition-colors border border-transparent hover:border-white/5"
              >
                <div className="flex items-center gap-4">
                  <div className={`p-2 rounded-full bg-white/5 border border-white/5 group-hover:scale-110 transition-transform duration-300`}>
                    {getIcon(log.action_type)}
                  </div>
                  <div className="flex flex-col">
                    <span className="text-sm font-bold text-white uppercase tracking-wide">
                      {log.action_type}
                    </span>
                    <span className="text-xs text-slate-500 font-mono">
                      {log.details}
                    </span>
                  </div>
                </div>

                <div className="flex flex-col items-end gap-1">
                  <span className="text-[10px] text-slate-600 font-mono">
                    {timeAgo(log.created_at)}
                  </span>
                  {log.tx_hash && (
                    <a 
                      href={`https://sepolia.etherscan.io/tx/${log.tx_hash}`} 
                      target="_blank" 
                      rel="noreferrer"
                      className="flex items-center gap-1 text-[10px] text-blue-500 hover:text-blue-400 hover:underline"
                    >
                      View on Scan <ExternalLink className="w-2 h-2" />
                    </a>
                  )}
                </div>
              </div>
            ))
          )}
        </div>
      </CardContent>
    </SpotlightCard>
  );
}
]]>
  </file>
  <file path="components/ClaimButton.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt } from 'wagmi';
import { Button } from '@/components/ui/button';
import { Loader2, Check, Gift, Timer, AlertCircle } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { ConnectButton } from '@rainbow-me/rainbowkit';
import { supabase } from '@/lib/supabaseClient';
import { logActivity } from '@/lib/logger'; 

const TOKEN_CONTRACT_ADDRESS = '0x83F7A90486697B8B881319FbADaabF337fE2c60c';
const COOLDOWN_PERIOD = 24 * 60 * 60 * 1000; 

const tokenAbi = [
  {
    inputs: [{ name: "to", type: "address" }, { name: "amount", type: "uint256" }],
    name: "mint",
    outputs: [],
    stateMutability: "nonpayable",
    type: "function",
  },
] as const;

export default function ClaimButton() {
  const { address, isConnected } = useAccount();
  
  const [status, setStatus] = useState<'idle' | 'cooldown' | 'claiming' | 'success'>('idle');
  const [timeLeft, setTimeLeft] = useState<number>(0);
  const [loadingCheck, setLoadingCheck] = useState(false);

  const { data: hash, writeContract, isPending, error: writeError } = useWriteContract();
  const { isLoading: isConfirming, isSuccess: isConfirmed } = useWaitForTransactionReceipt({ hash });

  // 1. åˆå§‹åŒ–æ£€æŸ¥
  useEffect(() => {
    const checkEligibility = async () => {
      if (!address) return;
      setLoadingCheck(true);

      const { data } = await supabase
        .from('faucet_claims')
        .select('last_claimed_at')
        .eq('wallet_address', address)
        .single();

      if (data) {
        const lastClaimed = new Date(data.last_claimed_at).getTime();
        const now = Date.now();
        const diff = now - lastClaimed;

        if (diff < COOLDOWN_PERIOD) {
          setStatus('cooldown');
          setTimeLeft(COOLDOWN_PERIOD - diff);
        } else {
          setStatus('idle');
        }
      } else {
        setStatus('idle');
      }
      setLoadingCheck(false);
    };

    if (isConnected) {
      checkEligibility();
    }
  }, [address, isConnected]);

  // 2. å€’è®¡æ—¶
  useEffect(() => {
    let timer: NodeJS.Timeout;
    if (status === 'cooldown' && timeLeft > 0) {
      timer = setInterval(() => {
        setTimeLeft((prev) => {
          if (prev <= 1000) {
            setStatus('idle');
            return 0;
          }
          return prev - 1000;
        });
      }, 1000);
    }
    return () => clearInterval(timer);
  }, [status, timeLeft]);

  // 3. ç›‘å¬æˆåŠŸ
  useEffect(() => {
    const recordClaim = async () => {
      if (isConfirmed && address) {
        setStatus('success');
        
        await supabase
          .from('faucet_claims')
          .upsert(
            { wallet_address: address, last_claimed_at: new Date().toISOString() }, 
            { onConflict: 'wallet_address' }
          );

        await logActivity({
          address,
          type: 'CLAIM',
          details: '100 KIKI Faucet',
          hash
        });

        setTimeout(() => {
           setStatus('cooldown');
           setTimeLeft(COOLDOWN_PERIOD);
        }, 3000);
      }
    };

    recordClaim();
  }, [isConfirmed, address, hash]);

  const handleClaim = () => {
    if (!address) return;
    setStatus('claiming');
    const amount = BigInt(100) * BigInt(10) ** BigInt(18);
    writeContract({
      address: TOKEN_CONTRACT_ADDRESS,
      abi: tokenAbi,
      functionName: 'mint',
      args: [address, amount],
    });
  };

  const formatTime = (ms: number) => {
    const totalSeconds = Math.floor(ms / 1000);
    const h = Math.floor(totalSeconds / 3600);
    const m = Math.floor((totalSeconds % 3600) / 60);
    const s = totalSeconds % 60;
    return `${h.toString().padStart(2, '0')}h ${m.toString().padStart(2, '0')}m ${s.toString().padStart(2, '0')}s`;
  };

  // --- çŠ¶æ€è§†å›¾ ---

  if (!isConnected) {
    return (
      <div className="relative group">
        <div className="absolute -inset-0.5 bg-gradient-to-r from-blue-500 to-purple-600 rounded-lg blur opacity-50 group-hover:opacity-100 transition duration-200"></div>
        <div className="relative bg-black rounded-lg p-1">
           <ConnectButton.Custom>
              {({ openConnectModal }) => (
                <Button onClick={openConnectModal} className="w-full bg-[#0B0C10] hover:bg-[#15171f] text-white font-bold h-12 px-8 border border-white/10">
                  Connect to Claim
                </Button>
              )}
           </ConnectButton.Custom>
        </div>
      </div>
    );
  }

  if (loadingCheck) {
     return (
       <Button disabled className="w-full sm:w-auto h-14 bg-[#0B0C10] border border-white/10 text-slate-500 min-w-[200px]">
         <Loader2 className="w-4 h-4 animate-spin mr-2" /> Checking...
       </Button>
     );
  }

  // âœ… ä¿®æ”¹é‡ç‚¹ï¼šå†·å´çŠ¶æ€ UI
  if (status === 'cooldown') {
    return (
      <motion.div 
        initial={{ opacity: 0, scale: 0.95 }}
        animate={{ opacity: 1, scale: 1 }}
        className="flex flex-col items-center justify-center gap-3 min-w-[220px]"
      >
        {/* 1. æ–‡å­—æ”¾ä¸Šé¢ */}
        <span className="text-[10px] font-bold tracking-[0.2em] text-blue-400/80 uppercase">
          Next claim available in
        </span>

        {/* 2. æ˜¾çœ¼çš„å€’è®¡æ—¶æ¡† */}
        <div className="relative w-full">
          {/* èƒŒæ™¯å…‰æ™• */}
          <div className="absolute -inset-0.5 bg-gradient-to-r from-blue-500/20 to-purple-500/20 rounded-xl blur-sm"></div>
          
          <div className="relative flex items-center justify-center gap-3 px-6 py-4 bg-[#0e1015] border border-blue-500/30 rounded-xl shadow-[inset_0_0_20px_rgba(59,130,246,0.1)]">
            <Timer className="w-5 h-5 text-blue-500 animate-pulse" />
            <span className="font-mono text-xl font-bold text-white tabular-nums tracking-wider drop-shadow-md">
              {formatTime(timeLeft)}
            </span>
          </div>
        </div>
      </motion.div>
    );
  }

  if (status === 'success') {
    return (
      <motion.div 
        initial={{ scale: 0.9, opacity: 0 }} animate={{ scale: 1, opacity: 1 }}
        className="inline-flex items-center gap-2 px-6 py-3 bg-green-500/10 border border-green-500/20 rounded-xl text-green-400 font-bold cursor-default h-14"
      >
        <Check className="w-5 h-5" /> <span>100 $KIKI Sent!</span>
        <motion.span 
          initial={{ y: 0, opacity: 1 }} animate={{ y: -20, opacity: 0 }} transition={{ duration: 1.5, ease: "easeOut" }}
          className="absolute -top-6 right-0 text-yellow-400 font-bold text-lg"
        >+100</motion.span>
      </motion.div>
    );
  }

  return (
    <div className="relative group">
      <div className="absolute -inset-1 bg-gradient-to-r from-yellow-400 via-orange-500 to-red-500 rounded-xl blur opacity-30 group-hover:opacity-75 transition duration-1000 group-hover:duration-200 animate-tilt"></div>
      <Button
        size="lg" onClick={handleClaim} disabled={isPending || isConfirming}
        className="relative w-full sm:w-auto min-w-[200px] h-14 bg-[#0B0C10] hover:bg-[#15171f] border border-white/10 text-white font-bold text-lg rounded-xl overflow-hidden transition-all"
      >
        <AnimatePresence mode="wait">
          {isPending || isConfirming ? (
            <motion.div key="loading" initial={{ y: 10, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: -10, opacity: 0 }} className="flex items-center gap-2">
              <Loader2 className="w-5 h-5 animate-spin text-yellow-500" />
              <span className="bg-clip-text text-transparent bg-gradient-to-r from-yellow-200 to-yellow-500">Minting...</span>
            </motion.div>
          ) : (
            <motion.div key="idle" initial={{ y: 10, opacity: 0 }} animate={{ y: 0, opacity: 1 }} exit={{ y: -10, opacity: 0 }} className="flex items-center gap-2">
              <Gift className="w-5 h-5 text-yellow-500 group-hover:animate-bounce" />
              <span className="bg-clip-text text-transparent bg-gradient-to-r from-yellow-200 via-orange-400 to-yellow-200">Claim 100 $KIKI</span>
              <div className="ml-2 px-2 py-0.5 bg-yellow-500/10 rounded text-[10px] text-yellow-500 border border-yellow-500/20">DAILY</div>
            </motion.div>
          )}
        </AnimatePresence>
        {!isPending && !isConfirming && <div className="absolute top-0 -inset-full h-full w-1/2 z-5 block transform -skew-x-12 bg-gradient-to-r from-transparent to-white opacity-20 group-hover:animate-shine" />}
      </Button>
      {writeError && (
        <motion.div initial={{ opacity: 0, y: 5 }} animate={{ opacity: 1, y: 0 }} className="absolute -bottom-8 left-0 right-0 text-center text-xs text-red-400 flex items-center justify-center gap-1">
          <AlertCircle className="w-3 h-3" /> <span>Transaction Failed</span>
        </motion.div>
      )}
    </div>
  );
}
]]>
  </file>
  <file path="components/Leaderboard.tsx">
<![CDATA[
'use client';

import React, { useEffect, useState } from 'react';
import { useReadContracts } from 'wagmi';
import { Trophy, Medal, Crown, Layers, Loader2, AlertCircle } from 'lucide-react';
import { formatEther } from 'viem';

// ğŸ”´ 1. NFT åˆçº¦åœ°å€ (ä½¿ç”¨ä½ æä¾›çš„æœ€æ–°åœ°å€)
const NFT_CONTRACT = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 

// ğŸ”´ 2. KIKI ä»£å¸åˆçº¦åœ°å€
const TOKEN_CONTRACT = '0x83F7A90486697B8B881319FbADaabF337fE2c60c'; 

// ERC-20 ABI
const tokenAbi = [
  {
    inputs: [{ name: "account", type: "address" }],
    name: "balanceOf",
    outputs: [{ name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
] as const;

interface LeaderboardItem {
  wallet_address: string;
  nft_balance: number;
  token_balance: number;
}

const getAvatarUrl = (seed: string) => 
  `https://api.dicebear.com/7.x/identicon/svg?seed=${seed}`;

const formatAddress = (addr: string) => 
  `${addr.slice(0, 6)}...${addr.slice(-4)}`;

export default function Leaderboard() {
  const [leaders, setLeaders] = useState<LeaderboardItem[]>([]);
  const [loading, setLoading] = useState(true);
  const [nftHolders, setNftHolders] = useState<{address: string, balance: number}[]>([]);

  // 1. è·å– NFT æŒæœ‰è€… (Alchemy)
  useEffect(() => {
    const fetchNftHolders = async () => {
      try {
        const apiKey = process.env.NEXT_PUBLIC_ALCHEMY_API_KEY;
        const network = 'eth-sepolia'; 
        const baseURL = `https://${network}.g.alchemy.com/nft/v2/${apiKey}/getOwnersForContract`;
        const url = `${baseURL}?contractAddress=${NFT_CONTRACT}&withTokenBalances=true`;

        const res = await fetch(url);
        const data = await res.json();
        const owners = data.ownerAddresses || data.owners || [];
        
        const parsedHolders = owners.map((owner: any) => {
          let address = "";
          let balance = 0;
          if (owner.ownerAddress) {
            address = owner.ownerAddress;
            balance = owner.tokenBalances?.length || 0;
          } else if (typeof owner === 'string') {
            address = owner;
            balance = 1;
          }
          return address ? { address, balance } : null;
        }).filter((item: any) => item !== null);

        setNftHolders(parsedHolders);
        // å¦‚æœæ²¡äººæŒæœ‰ï¼Œç›´æ¥ç»“æŸ loading
        if (parsedHolders.length === 0) setLoading(false);

      } catch (error) {
        console.error("Alchemy Fetch Error:", error);
        setLoading(false);
      }
    };

    fetchNftHolders();
  }, []);

  // 2. æ‰¹é‡è¯»å– KIKI ä»£å¸ä½™é¢
  const { data: tokenBalances, isLoading: isReadingChain } = useReadContracts({
    contracts: nftHolders.map(holder => ({
      address: TOKEN_CONTRACT as `0x${string}`,
      abi: tokenAbi,
      functionName: 'balanceOf',
      args: [holder.address as `0x${string}`],
    })),
    query: {
      enabled: nftHolders.length > 0, 
    }
  });

  // 3. åˆå¹¶æ•°æ® & æ’åº
  useEffect(() => {
    if (nftHolders.length > 0 && tokenBalances) {
      const mergedData = nftHolders.map((holder, index) => {
        const balanceResult = tokenBalances[index];
        const rawBalance = balanceResult?.status === 'success' ? balanceResult.result : 0n;
        // æ ¼å¼åŒ–ï¼šwei -> ether
        const tokenBalance = Math.floor(Number(formatEther(rawBalance as bigint)));

        return {
          wallet_address: holder.address,
          nft_balance: holder.balance,
          token_balance: tokenBalance
        };
      });

      // æ’åºè§„åˆ™ï¼šä»£å¸ä½™é¢ä¼˜å…ˆ
      mergedData.sort((a, b) => {
        if (b.token_balance !== a.token_balance) return b.token_balance - a.token_balance;
        return b.nft_balance - a.nft_balance;
      });

      setLeaders(mergedData.slice(0, 20));
      setLoading(false);
    }
  }, [nftHolders, tokenBalances]);

  // æ¸²æŸ“æ’åå›¾æ ‡
  const renderRankIcon = (index: number) => {
    if (index === 0) return <Crown className="w-6 h-6 text-yellow-400 fill-yellow-400 animate-pulse" />;
    if (index === 1) return <Medal className="w-6 h-6 text-slate-300 fill-slate-300" />;
    if (index === 2) return <Medal className="w-6 h-6 text-amber-600 fill-amber-600" />;
    return <span className="text-slate-500 font-bold w-6 text-center">{index + 1}</span>;
  };

  return (
    <section className="w-full max-w-5xl mx-auto px-4 py-8">
      <div className="text-center mb-10">
        <h2 className="text-3xl font-bold tracking-tight flex items-center justify-center gap-3">
          {/* Logo */}
          <img 
            src="/kiki.png" 
            alt="Kiki Logo" 
            className="w-12 h-12 object-contain drop-shadow-[0_0_15px_rgba(250,204,21,0.6)] hover:scale-110 transition-transform duration-300" 
          />
          {/* âœ… è‹±æ–‡æ ‡é¢˜ */}
          <span className="text-transparent bg-clip-text bg-gradient-to-r from-yellow-200 to-amber-500 font-mono">
            TOP TOKEN HOLDERS
          </span>
        </h2>
        <p className="text-slate-400 mt-2 font-mono text-sm">
          Ranking by <span className="text-yellow-400 font-bold">$KIKI</span> Balance â€¢ Real-time On-chain Data
        </p>
      </div>

      <div className="bg-slate-900/50 backdrop-blur-md border border-white/10 rounded-2xl overflow-hidden shadow-2xl">
        {/* è¡¨å¤´ */}
        <div className="grid grid-cols-12 gap-4 p-4 border-b border-white/5 text-xs font-bold text-slate-500 uppercase tracking-wider items-center font-mono">
          <div className="col-span-2 text-center">RANK</div>
          <div className="col-span-6 md:col-span-6">MEMBER</div>
          <div className="col-span-2 md:col-span-2 text-center flex items-center justify-center gap-1 text-blue-400">
            <Layers className="w-3 h-3" /> NFTs
          </div>
          <div className="col-span-2 md:col-span-2 text-right flex items-center justify-end gap-1 text-yellow-500">
            <img src="/kiki.png" alt="Token" className="w-4 h-4 object-contain" /> 
            $KIKI
          </div>
        </div>

        <div className="divide-y divide-white/5 max-h-[600px] overflow-y-auto custom-scrollbar">
          {loading || isReadingChain ? (
            <div className="p-12 text-center text-slate-500 flex flex-col items-center gap-3">
              <Loader2 className="w-8 h-8 animate-spin text-purple-500" />
              <span className="text-sm font-mono">SYNCING CHAIN DATA...</span>
            </div>
          ) : leaders.length === 0 ? (
            <div className="p-12 text-center text-slate-500 flex flex-col items-center gap-2">
              <AlertCircle className="w-8 h-8 text-slate-600" />
              <p className="font-mono">NO DATA FOUND</p>
              <p className="text-xs text-slate-600">Mint an NFT to appear on the leaderboard</p>
            </div>
          ) : (
            leaders.map((leader, index) => (
              <div 
                key={leader.wallet_address} 
                className={`grid grid-cols-12 gap-4 p-4 items-center transition-all duration-300 hover:bg-white/5 group
                  ${index === 0 ? 'bg-gradient-to-r from-yellow-500/10 to-transparent' : ''}
                  ${index === 1 ? 'bg-gradient-to-r from-slate-500/10 to-transparent' : ''}
                  ${index === 2 ? 'bg-gradient-to-r from-amber-500/10 to-transparent' : ''}
                `}
              >
                {/* æ’å */}
                <div className="col-span-2 flex justify-center scale-100 group-hover:scale-110 transition-transform">
                  {renderRankIcon(index)}
                </div>

                {/* æˆå‘˜åœ°å€ */}
                <div className="col-span-6 md:col-span-6 flex items-center gap-3">
                  <div className="relative">
                    <img 
                      src={getAvatarUrl(leader.wallet_address)} 
                      alt="Avatar" 
                      className="w-10 h-10 rounded-full bg-slate-800 object-cover border-2 border-transparent" 
                    />
                  </div>
                  <div className="flex flex-col min-w-0">
                    <span className="font-mono text-sm md:text-base font-medium truncate text-white">
                      {formatAddress(leader.wallet_address)}
                    </span>
                  </div>
                </div>

                {/* NFT æŒæœ‰é‡ */}
                <div className="col-span-2 md:col-span-2 text-center">
                  <span className="inline-flex items-center gap-1 bg-blue-500/10 border border-blue-500/30 px-3 py-1 rounded-full text-sm font-bold text-blue-300 font-mono">
                    {leader.nft_balance}
                  </span>
                </div>

                {/* KIKI ä½™é¢ */}
                <div className="col-span-2 md:col-span-2 text-right">
                  <span className="font-bold font-mono text-lg text-yellow-400">
                    {leader.token_balance.toLocaleString()}
                  </span>
                </div>
              </div>
            ))
          )}
        </div>
      </div>
    </section>
  );
}
]]>
  </file>
  <file path="components/MessageWall.tsx">
<![CDATA[
'use client';

import React, { useEffect, useState } from 'react';
import { supabase } from '@/lib/supabaseClient';
import { useAccount } from 'wagmi';
import { Loader2, Send, User, Trash2, MessageCircle, X, Terminal, Hash } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

// ğŸ”¥ã€é‡è¦ã€‘è¯·åœ¨è¿™é‡Œå¡«å…¥ä½ è‡ªå·±çš„é’±åŒ…åœ°å€ï¼ˆå¿…é¡»å…¨å°å†™ï¼‰
const ADMIN_WALLET = "0x0752bddacb7b73e26a45e2b16cdea53311f46f7c".toLowerCase(); 

// å®šä¹‰æ•°æ®ç±»å‹
interface Message {
  id: number;
  content: string;
  wallet_address: string;
  nickname?: string;
  created_at: string;
  tag?: string;
  reply_content?: string; 
}

// ğŸ·ï¸ æ ‡ç­¾é…ç½® (é€‚é…æ·±è‰²ç§‘æŠ€é£ï¼šé«˜äº®è§å…‰è‰² + åŠé€æ˜èƒŒæ™¯)
const TAG_OPTIONS = [
  { label: 'General', value: 'General', color: 'bg-blue-500/10 text-blue-400 border-blue-500/20' },
  { label: 'Idea', value: 'Idea', color: 'bg-green-500/10 text-green-400 border-green-500/20' },
  { label: 'Bug Report', value: 'Bug', color: 'bg-red-500/10 text-red-400 border-red-500/20' },
  { label: 'Alpha', value: 'Alpha', color: 'bg-purple-500/10 text-purple-400 border-purple-500/20' },
];

// è¾…åŠ©å‡½æ•°ï¼šè·å–æ ‡ç­¾æ ·å¼
const getTagStyle = (tagValue: string) => {
  const found = TAG_OPTIONS.find(t => t.value === tagValue);
  return found ? found.color : 'bg-slate-800 text-slate-400 border-slate-700';
};

// è¾…åŠ©å‡½æ•°ï¼šç”Ÿæˆåƒç´ å¤´åƒ
const getAvatarUrl = (seed: string) => 
  `https://api.dicebear.com/7.x/identicon/svg?seed=${seed || 'default'}&backgroundColor=12141a`;

export default function MessageWall() {
  const { address, isConnected } = useAccount();
  const [messages, setMessages] = useState<Message[]>([]);
  const [loading, setLoading] = useState(true);
  const [sending, setSending] = useState(false);

  // è¡¨å•çŠ¶æ€
  const [content, setContent] = useState('');
  const [nickname, setNickname] = useState('');
  const [selectedTag, setSelectedTag] = useState('General');

  // ç®¡ç†å‘˜çŠ¶æ€
  const [replyingId, setReplyingId] = useState<number | null>(null);
  const [replyText, setReplyText] = useState('');

  const isAdmin = address?.toLowerCase() === ADMIN_WALLET;

  const fetchMessages = async () => {
    try {
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: false });
      
      if (error) throw error;
      if (data) setMessages(data);
    } catch (error) {
      console.error('Error fetching:', error);
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchMessages();
  }, []);

  const handleSendMessage = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!content.trim() || !isConnected) return;
    setSending(true);
    try {
      const { error } = await supabase.from('messages').insert([{ 
        content, 
        wallet_address: address, 
        nickname: nickname || 'Anon User',
        tag: selectedTag 
      }]);
      if (error) throw error;
      setContent('');
      setNickname('');
      setSelectedTag('General');
      fetchMessages(); 
    } catch (error) {
      alert('Failed to send message.');
    } finally {
      setSending(false);
    }
  };

  const handleDelete = async (id: number) => {
    if (!confirm('Confirm delete?')) return;
    try {
      const { error } = await supabase.from('messages').delete().eq('id', id);
      if (error) throw error;
      setMessages(prev => prev.filter(m => m.id !== id));
    } catch (error) {
      alert('Delete failed');
    }
  };

  const handleReplySubmit = async (id: number) => {
    if (!replyText.trim()) return;
    try {
      const { error } = await supabase
        .from('messages')
        .update({ reply_content: replyText })
        .eq('id', id);

      if (error) throw error;
      setReplyingId(null);
      setReplyText('');
      fetchMessages();
    } catch (error) {
      alert('Reply failed');
    }
  };

  return (
    <section className="w-full max-w-7xl mx-auto px-4 py-8 font-sans">
      
      {/* --- 1. å‘å¸ƒåŒºåŸŸ (æ·±è‰²é¢æ¿) --- */}
      <div className="max-w-3xl mx-auto mb-20">
        <div className="bg-[#12141a]/80 backdrop-blur-xl border border-white/5 rounded-3xl p-1 shadow-2xl">
          <div className="bg-[#0B0C10]/80 rounded-[20px] p-6 border border-white/5">
            
            <div className="flex items-center gap-2 mb-6 text-slate-400 text-xs font-mono uppercase tracking-widest border-b border-white/5 pb-4">
              <Terminal className="w-4 h-4 text-blue-500" />
              <span>Broadcast Protocol</span>
            </div>

            <form onSubmit={handleSendMessage} className="space-y-5">
              <div className="flex flex-col md:flex-row gap-5">
                {/* æ˜µç§°è¾“å…¥ */}
                <div className="relative flex-1 group">
                  <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <User className="h-4 w-4 text-slate-600 group-focus-within:text-blue-500 transition-colors" />
                  </div>
                  <input
                    type="text"
                    value={nickname}
                    onChange={(e) => setNickname(e.target.value)}
                    placeholder="Nickname (Optional)"
                    disabled={!isConnected}
                    className="w-full bg-[#12141a] border border-white/10 rounded-xl pl-10 pr-4 py-3 text-sm text-white focus:border-blue-500/50 focus:ring-1 focus:ring-blue-500/50 outline-none transition-all placeholder:text-slate-600 font-mono"
                  />
                </div>
                
                {/* æ ‡ç­¾é€‰æ‹© */}
                <div className="flex gap-2 flex-wrap items-center">
                  {TAG_OPTIONS.map((option) => (
                    <button
                      key={option.value}
                      type="button"
                      onClick={() => setSelectedTag(option.value)}
                      className={`px-3 py-1.5 text-[10px] font-bold font-mono rounded-lg border transition-all duration-200 uppercase tracking-wide
                        ${selectedTag === option.value 
                          ? `${option.color} ring-1 ring-white/10` 
                          : 'bg-[#12141a] border-white/10 text-slate-500 hover:border-white/30'}`}
                    >
                      {option.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* å†…å®¹è¾“å…¥ */}
              <div className="relative group">
                <textarea
                  value={content}
                  onChange={(e) => setContent(e.target.value)}
                  placeholder={isConnected ? "Share your thoughts with the ecosystem..." : "Connect wallet to broadcast..."}
                  disabled={!isConnected || sending}
                  rows={3}
                  className="w-full bg-[#12141a] border border-white/10 rounded-xl p-4 text-slate-200 text-sm focus:border-purple-500/50 focus:ring-1 focus:ring-purple-500/50 outline-none transition-all placeholder:text-slate-700 resize-none font-sans leading-relaxed"
                />
              </div>

              {/* å‘é€æŒ‰é’® */}
              <div className="flex justify-end">
                <button
                  type="submit"
                  disabled={!isConnected || sending || !content.trim()}
                  className="group relative inline-flex items-center gap-2 px-6 py-2.5 bg-white text-black rounded-lg font-bold text-sm hover:bg-slate-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden"
                >
                  <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/50 to-transparent translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700"></div>
                  {sending ? <Loader2 className="w-4 h-4 animate-spin" /> : <Send className="w-4 h-4" />}
                  <span>TRANSMIT</span>
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      {/* --- 2. ç•™è¨€å±•ç¤ºåŒºåŸŸ (æ·±è‰²å¡ç‰‡æµ) --- */}
      {loading ? (
        <div className="flex flex-col items-center justify-center py-20 gap-4 text-slate-600">
          <Loader2 className="w-8 h-8 animate-spin text-blue-500" />
          <span className="text-xs font-mono uppercase tracking-widest">Syncing Nodes...</span>
        </div>
      ) : (
        <div className="columns-1 md:columns-2 lg:columns-3 gap-6 space-y-6">
          {messages.map((msg) => (
            <div
              key={msg.id}
              className="break-inside-avoid relative group bg-[#12141a]/40 border border-white/5 hover:border-white/10 rounded-2xl p-6 transition-all duration-300 hover:bg-[#12141a]/60 hover:-translate-y-1 backdrop-blur-sm"
            >
              {/* åˆ é™¤æŒ‰é’® (ä»…ç®¡ç†å‘˜å¯è§) */}
              {isAdmin && (
                <button 
                  onClick={() => handleDelete(msg.id)}
                  className="absolute top-4 right-4 text-slate-600 hover:text-red-400 transition-colors opacity-0 group-hover:opacity-100"
                >
                  <Trash2 className="w-4 h-4" />
                </button>
              )}

              {/* å¤´éƒ¨ä¿¡æ¯ */}
              <div className="flex items-start justify-between mb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl overflow-hidden border border-white/10 bg-black">
                    <img
                      src={getAvatarUrl(msg.wallet_address)}
                      alt="Avatar"
                      className="w-full h-full object-cover opacity-80"
                    />
                  </div>
                  <div>
                    <h4 className="font-bold text-sm text-slate-200 flex items-center gap-2">
                      {msg.nickname || 'Anon'}
                    </h4>
                    <p className="text-[10px] text-slate-500 font-mono">
                      {msg.wallet_address ? `${msg.wallet_address.slice(0, 6)}...${msg.wallet_address.slice(-4)}` : ''}
                    </p>
                  </div>
                </div>
                {msg.tag && (
                  <span className={`text-[10px] px-2 py-0.5 rounded border font-mono font-bold uppercase ${getTagStyle(msg.tag)}`}>
                    {TAG_OPTIONS.find(t => t.value === msg.tag)?.label || msg.tag}
                  </span>
                )}
              </div>

              {/* ç•™è¨€å†…å®¹ */}
              <p className="text-slate-300 text-sm leading-relaxed whitespace-pre-wrap font-light">
                {msg.content}
              </p>
              
              {/* å®˜æ–¹å›å¤ (æ·±ç´«è‰²å¡ç‰‡) */}
              {msg.reply_content && (
                <div className="mt-4 p-3 bg-purple-500/5 rounded-xl border border-purple-500/10">
                  <div className="flex items-center gap-2 mb-1">
                    <div className="px-1.5 py-0.5 bg-purple-500/20 rounded text-[9px] text-purple-400 font-bold uppercase tracking-wide border border-purple-500/20">
                      Dev Response
                    </div>
                  </div>
                  <p className="text-slate-400 text-xs leading-relaxed pl-1">
                    {msg.reply_content}
                  </p>
                </div>
              )}

              {/* åº•éƒ¨ä¿¡æ¯æ  */}
              <div className="mt-4 pt-4 border-t border-white/5 flex justify-between items-center">
                 <div className="flex items-center gap-1.5 text-[10px] text-slate-600 font-mono">
                   <Hash className="w-3 h-3" />
                   <span>ID: {msg.id}</span>
                   <span className="mx-1">|</span>
                   <span>{new Date(msg.created_at).toLocaleDateString()}</span>
                 </div>
                 
                 {/* å›å¤å…¥å£ (ç®¡ç†å‘˜) */}
                 {isAdmin && !replyingId && (
                  <button 
                    onClick={() => setReplyingId(msg.id)}
                    className="text-slate-500 hover:text-white flex items-center gap-1 text-[10px] font-mono uppercase tracking-wide opacity-0 group-hover:opacity-100 transition-all"
                  >
                    <MessageCircle className="w-3 h-3" /> Reply
                  </button>
                )}
              </div>

              {/* ç®¡ç†å‘˜å›å¤è¾“å…¥æ¡† */}
              <AnimatePresence>
                {replyingId === msg.id && (
                  <motion.div 
                    initial={{ opacity: 0, height: 0 }} 
                    animate={{ opacity: 1, height: 'auto' }} 
                    exit={{ opacity: 0, height: 0 }}
                    className="mt-3 pt-3 border-t border-white/5 overflow-hidden"
                  >
                    <textarea
                      value={replyText}
                      onChange={(e) => setReplyText(e.target.value)}
                      placeholder="Type admin response..."
                      className="w-full text-xs p-3 bg-black/40 text-slate-200 placeholder:text-slate-600 rounded-lg border border-white/10 outline-none focus:border-purple-500/50 mb-2 resize-none font-mono"
                      rows={3}
                      autoFocus
                    />
                    <div className="flex justify-end gap-2">
                      <button 
                        onClick={() => { setReplyingId(null); setReplyText(''); }}
                        className="px-3 py-1.5 text-[10px] text-slate-400 hover:text-white hover:bg-white/5 rounded transition-colors uppercase font-bold"
                      >
                        Cancel
                      </button>
                      <button 
                        onClick={() => handleReplySubmit(msg.id)}
                        className="px-3 py-1.5 bg-purple-600 hover:bg-purple-500 text-white text-[10px] rounded hover:shadow-[0_0_10px_rgba(147,51,234,0.3)] transition-all uppercase font-bold"
                      >
                        Send Reply
                      </button>
                    </div>
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          ))}
        </div>
      )}
    </section>
  );
}
]]>
  </file>
  <file path="components/NftGallery.tsx">
<![CDATA[
'use client';

import { useState, useEffect } from 'react';
import { useAccount } from 'wagmi';
import { motion } from 'framer-motion';
import { Loader2, RefreshCw, AlertCircle, Image as ImageIcon, Sparkles } from 'lucide-react';
import { Button } from '@/components/ui/button';

// NFT åˆçº¦åœ°å€
const CONTRACT_ADDRESS = '0x1Fb1BE68a40A56bac17Ebf4B28C90a5171C95390'; 

interface NFT {
  contract: { address: string };
  id: { tokenId: string };
  title: string;
  media: { gateway: string }[];
}

export function NftGallery() {
  const { address, isConnected, chain } = useAccount();
  const [nfts, setNfts] = useState<NFT[]>([]);
  const [isLoading, setIsLoading] = useState(false);

  // è·å– NFT æ•°æ®
  const fetchNFTs = async () => {
    if (!address || !chain) return;
    
    setIsLoading(true);
    try {
      const apiKey = process.env.NEXT_PUBLIC_ALCHEMY_API_KEY;
      // æ ¹æ® Chain ID åˆ¤æ–­ç½‘ç»œ (é»˜è®¤ Sepolia)
      let networkPrefix = 'eth-sepolia';
      if (chain.id === 1) networkPrefix = 'eth-mainnet';
      
      const baseURL = `https://${networkPrefix}.g.alchemy.com/nft/v2/${apiKey}/getNFTs`;
      const url = `${baseURL}?owner=${address}&withMetadata=true&contractAddresses[]=${CONTRACT_ADDRESS}`;
      
      const response = await fetch(url);
      const data = await response.json();
      
      // ç®€å•æ’åºï¼šID å°çš„åœ¨å‰
      const sorted = (data.ownedNfts || []).sort((a: NFT, b: NFT) => 
        parseInt(a.id.tokenId, 16) - parseInt(b.id.tokenId, 16)
      );
      
      setNfts(sorted);
    } catch (error) {
      console.error("Failed to fetch NFTs:", error);
    } finally {
      setIsLoading(false);
    }
  };

  useEffect(() => {
    if (isConnected) fetchNFTs();
  }, [isConnected, address, chain]);

  // æœªè¿æ¥çŠ¶æ€
  if (!isConnected) {
    return (
      <div className="flex flex-col items-center justify-center py-12 text-slate-500">
        <AlertCircle className="w-10 h-10 mb-2 opacity-50" />
        <p className="font-mono text-sm">CONNECT WALLET TO VIEW ASSETS</p>
      </div>
    );
  }

  return (
    <div className="w-full">
      {/* é¡¶éƒ¨æ§åˆ¶æ  */}
      <div className="flex items-center justify-between mb-6">
        <div className="flex items-center gap-2">
           <span className="text-xs font-mono text-slate-500 bg-white/5 px-2 py-1 rounded border border-white/5">
             TOTAL: {nfts.length}
           </span>
        </div>
        <button 
          onClick={fetchNFTs} 
          disabled={isLoading}
          className="flex items-center gap-2 text-xs font-mono text-slate-500 hover:text-white transition-colors group disabled:opacity-50 cursor-pointer"
        >
          {isLoading ? (
            <Loader2 className="animate-spin w-3 h-3" /> 
          ) : (
            <RefreshCw className="w-3 h-3 group-hover:rotate-180 transition-transform duration-500" /> 
          )}
          REFRESH
        </button>
      </div>

      {/* NFT ç½‘æ ¼ */}
      {isLoading ? (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-6">
          {[...Array(4)].map((_, i) => (
            <div key={i} className="aspect-square bg-white/5 rounded-2xl animate-pulse border border-white/5" />
          ))}
        </div>
      ) : nfts.length === 0 ? (
        <div className="flex flex-col items-center justify-center py-16 bg-white/5 rounded-2xl border border-white/5 border-dashed">
          <ImageIcon className="w-10 h-10 text-slate-600 mb-3" />
          <p className="text-slate-500 font-mono text-sm">NO ASSETS FOUND</p>
        </div>
      ) : (
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
          {nfts.map((nft, index) => {
            // âœ… æ ¸å¿ƒé­”æ³•ï¼šä¸ºæ¯ä¸ªå¡ç‰‡ç”Ÿæˆå”¯ä¸€çš„éšæœºå»¶è¿Ÿï¼Œé¿å…åŠ¨ä½œæ•´é½åˆ’ä¸€
            const randomDelay = Math.random() * 2; 
            const randomDuration = 4 + Math.random() * 2; // 4~6ç§’çš„éšæœºæµ®åŠ¨å‘¨æœŸ

            return (
              <motion.div
                key={`${nft.contract.address}-${nft.id.tokenId}`}
                // 1. æ‚¬æµ®åŠ¨ç”»
                animate={{ 
                  y: [0, -8, 0], // ä¸Šä¸‹æµ®åŠ¨èŒƒå›´ (æ¯” Mint é¡µç¨å¾®å°ä¸€ç‚¹ï¼Œé¿å…å¤ªä¹±)
                  rotate: [0, 1, -1, 0], // æå¾®å°çš„æ—‹è½¬
                }}
                transition={{ 
                  duration: randomDuration, // éšæœºå‘¨æœŸ
                  repeat: Infinity, 
                  ease: "easeInOut",
                  delay: randomDelay, // éšæœºå»¶è¿Ÿå¯åŠ¨
                }}
                className="group relative perspective-1000"
              >
                {/* 2. å‘¼å¸å…‰æ™• (Hover æ—¶å¢å¼º) */}
                <div className="absolute -inset-2 bg-purple-500/20 rounded-2xl blur-xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>

                {/* 3. å¡ç‰‡ä¸»ä½“ */}
                <div className="relative aspect-square rounded-2xl overflow-hidden border border-white/10 bg-[#0B0C10] shadow-xl group-hover:border-purple-500/50 transition-colors duration-300">
                  <img 
                    src={nft.media?.[0]?.gateway || '/kiki.png'} 
                    alt={nft.title} 
                    className="w-full h-full object-cover opacity-90 group-hover:opacity-100 group-hover:scale-110 transition-all duration-700 ease-out"
                    onError={(e) => (e.target as HTMLImageElement).src = '/kiki.png'} 
                  />
                  
                  {/* å·¦ä¸Šè§’ Series æ ‡ç­¾ */}
                  <div className="absolute top-2 left-2">
                     <div className="bg-black/60 backdrop-blur px-2 py-0.5 rounded text-[8px] font-mono text-slate-300 border border-white/10">
                       GENESIS
                     </div>
                  </div>

                  {/* åº•éƒ¨ ID æ ‡ç­¾ */}
                  <div className="absolute bottom-0 inset-x-0 p-3 bg-gradient-to-t from-black/90 to-transparent">
                    <div className="flex items-center justify-between">
                      <span className="font-bold text-white text-sm truncate">{nft.title || 'Unknown Asset'}</span>
                      <span className="text-[10px] font-mono text-purple-400 bg-purple-500/10 px-1.5 py-0.5 rounded border border-purple-500/20">
                        #{parseInt(nft.id.tokenId, 16)}
                      </span>
                    </div>
                  </div>
                </div>
              </motion.div>
            );
          })}
        </div>
      )}
    </div>
  );
}
]]>
  </file>
  <file path="components/SignMessageCard.tsx">
<![CDATA[
'use client';

import { useState } from 'react';
import { useSignMessage } from 'wagmi';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Label } from '@/components/ui/label';
import { PenTool, Loader2, CheckCircle2 } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';

export function SignMessageCard() {
  const [message, setMessage] = useState('Welcome to NFT Nexus! Verify my identity.');
  const [signature, setSignature] = useState<string>('');
  
  const { signMessage, isPending } = useSignMessage({
    mutation: {
      onSuccess(data) {
        setSignature(data);
      },
    },
  });

  const handleSign = (e: React.FormEvent) => {
    e.preventDefault();
    signMessage({ message });
  };

  return (
    <motion.div
      initial={{ opacity: 0, x: 20 }}
      animate={{ opacity: 1, x: 0 }}
      transition={{ delay: 0.3 }}
      className="h-full"
    >
      <Card className="bg-slate-900/50 border-slate-800 text-white backdrop-blur-sm h-full flex flex-col relative overflow-hidden">
        {/* èƒŒæ™¯è£…é¥°å…‰æ™• */}
        <div className="absolute top-0 right-0 -mr-16 -mt-16 w-32 h-32 bg-purple-500/10 rounded-full blur-3xl pointer-events-none"></div>

        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-purple-400">
            <PenTool className="w-5 h-5" />
            èº«ä»½éªŒè¯ (Sign)
          </CardTitle>
          <CardDescription className="text-slate-400">
            æ— éœ€ Gas è´¹ï¼Œé€šè¿‡æ•°å­—ç­¾åè¯æ˜ä½ æ‹¥æœ‰æ­¤é’±åŒ…ã€‚
          </CardDescription>
        </CardHeader>
        
        <CardContent className="flex-1 flex flex-col gap-4">
          <form onSubmit={handleSign} className="space-y-4 flex flex-col h-full">
            <div className="space-y-2 flex-1">
              <Label htmlFor="message" className="text-slate-300">ç­¾åå†…å®¹</Label>
              <Textarea 
                id="message" 
                placeholder="è¾“å…¥è¦ç­¾åçš„æ¶ˆæ¯..." 
                value={message}
                onChange={(e) => {
                  setMessage(e.target.value);
                  setSignature(''); // ä¿®æ”¹å†…å®¹æ—¶æ¸…ç©ºæ—§ç­¾å
                }}
                className="bg-black/20 border-slate-700 text-white min-h-[120px] focus:border-purple-500/50 resize-none transition-colors"
              />
            </div>

            <Button 
              type="submit" 
              disabled={isPending || !message}
              className="w-full bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white font-bold h-11"
            >
              {isPending ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" /> è¯·åœ¨é’±åŒ…ç­¾å...
                </>
              ) : (
                'ç”Ÿæˆæ•°å­—ç­¾å'
              )}
            </Button>
          </form>

          {/* ç­¾åç»“æœå±•ç¤ºåŒº */}
          <AnimatePresence>
            {signature && (
              <motion.div
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                exit={{ opacity: 0, height: 0 }}
                className="mt-2"
              >
                <div className="p-4 rounded-xl bg-purple-500/10 border border-purple-500/20 overflow-hidden">
                  <div className="flex items-center gap-2 text-green-400 mb-2 font-bold text-sm">
                    <CheckCircle2 className="w-4 h-4" /> ç­¾åç”ŸæˆæˆåŠŸ
                  </div>
                  <div 
                    onClick={() => navigator.clipboard.writeText(signature)}
                    title="ç‚¹å‡»å¤åˆ¶"
                    className="text-xs text-slate-400 break-all font-mono bg-black/30 p-2 rounded cursor-pointer hover:bg-black/50 transition-colors active:scale-95 transform"
                  >
                    {signature}
                  </div>
                  <p className="text-[10px] text-slate-500 mt-2 text-center">
                    *ä»»ä½•äººå‡å¯ä½¿ç”¨æ­¤ç­¾åéªŒè¯ä½ çš„èº«ä»½
                  </p>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </CardContent>
      </Card>
    </motion.div>
  );
}
]]>
  </file>
  <file path="components/TokenBalance.tsx">
<![CDATA[
'use client';

import { useAccount, useReadContract } from 'wagmi';
import { formatEther } from 'viem';
import { Loader2 } from 'lucide-react';

// ğŸ”´ ä½ çš„ KIKI ä»£å¸åˆçº¦åœ°å€
const TOKEN_CONTRACT = '0x83F7A90486697B8B881319FbADaabF337fE2c60c';

const tokenAbi = [
  {
    inputs: [{ name: "account", type: "address" }],
    name: "balanceOf",
    outputs: [{ name: "", type: "uint256" }],
    stateMutability: "view",
    type: "function",
  },
] as const;

export default function TokenBalance() {
  const { address, isConnected } = useAccount();

  // è¯»å–ä½™é¢
  const { data: balance, isLoading } = useReadContract({
    address: TOKEN_CONTRACT as `0x${string}`,
    abi: tokenAbi,
    functionName: 'balanceOf',
    args: address ? [address] : undefined,
    // è‡ªåŠ¨åˆ·æ–°é…ç½®ï¼šæ¯ 5 ç§’æ›´æ–°ä¸€æ¬¡ä½™é¢ï¼Œä¿è¯ Mint æˆ–é¢†å–åæ•°æ®åŠæ—¶å˜åŠ¨
    query: {
        refetchInterval: 5000 
    }
  });

  // å¦‚æœæ²¡è¿æ¥é’±åŒ…ï¼Œä¸æ˜¾ç¤ºä»»ä½•ä¸œè¥¿
  if (!isConnected) return null;

  return (
    <div className="hidden md:flex items-center gap-2 bg-slate-800/80 border border-yellow-500/20 px-4 py-2 rounded-full backdrop-blur-md shadow-lg shadow-yellow-500/5 transition-all hover:scale-105 hover:border-yellow-500/40">
      {/* Kiki å›¾æ ‡ */}
      <img 
        src="/kiki.png" 
        alt="KIKI" 
        className="w-5 h-5 object-contain drop-shadow-[0_0_8px_rgba(250,204,21,0.5)]" 
      />
      
      {/* ä½™é¢æ•°å­— */}
      <span className="font-mono font-bold text-yellow-400 text-sm">
        {isLoading ? (
          <Loader2 className="w-4 h-4 animate-spin inline" />
        ) : (
          // æ ¼å¼åŒ–æ•°å­—ï¼šä¿ç•™æ•´æ•°ï¼ŒåŠ åƒåˆ†ä½
          Math.floor(Number(formatEther(balance || 0n))).toLocaleString()
        )}
      </span>
      <span className="text-xs text-yellow-600/80 font-bold">KIKI</span>
    </div>
  );
}
]]>
  </file>
  <file path="components/TradeDashboard.tsx">
<![CDATA[
'use client';

import { useState, useEffect, useRef, useMemo } from 'react';
import { useAccount, useWriteContract, useWaitForTransactionReceipt, useReadContract } from 'wagmi';
import { parseEther, formatEther } from 'viem';
import { Button } from '@/components/ui/button';
import { Loader2, Wifi, Trash2, Zap, X, Check, ExternalLink } from 'lucide-react';
import { createChart, ColorType, ISeriesApi, Time, CandlestickData, CandlestickSeries, CrosshairMode } from 'lightweight-charts';
import { motion, AnimatePresence } from 'framer-motion';

// --- ğŸ”§ é…ç½® ---
const KIKI_ADDRESS = '0x83f7a90486697b8b881319fbadaabf337fe2c60c' as const;
const UNISWAP_ROUTER = '0xeE567Fe1712Faf6149d80dA1E6934E354124CfE3'.toLowerCase() as `0x${string}`;
const WETH_ADDRESS = '0xfff9976782d46cc05630d1f6ebab18b2324d6b14'.toLowerCase() as `0x${string}`;

// --- ABI ---
const routerAbi = [
  { inputs: [{name: "amountOutMin", type: "uint256"}, {name: "path", type: "address[]"}, {name: "to", type: "address"}, {name: "deadline", type: "uint256"}], name: "swapExactETHForTokens", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "payable", type: "function" },
  { inputs: [{name: "amountIn", type: "uint256"}, {name: "amountOutMin", type: "uint256"}, {name: "path", type: "address[]"}, {name: "to", type: "address"}, {name: "deadline", type: "uint256"}], name: "swapExactTokensForETH", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "nonpayable", type: "function" },
  { inputs: [{name: "amountIn", type: "uint256"}, {name: "path", type: "address[]"}], name: "getAmountsOut", outputs: [{name: "amounts", type: "uint256[]"}], stateMutability: "view", type: "function" },
] as const;

const tokenAbi = [
  { inputs: [{name: "spender", type: "address"}, {name: "amount", type: "uint256"}], name: "approve", outputs: [{type: "bool"}], stateMutability: "nonpayable", type: "function" },
  { inputs: [{name: "owner", type: "address"}, {name: "spender", type: "address"}], name: "allowance", outputs: [{type: "uint256"}], stateMutability: "view", type: "function" }
] as const;

export default function TradeDashboard() {
  const { address, isConnected } = useAccount();
  
  // äº¤æ˜“çŠ¶æ€
  const [tradeSide, setTradeSide] = useState<'buy' | 'sell'>('buy');
  const [inputValue, setInputValue] = useState('');
  const [buyUnit, setBuyUnit] = useState<'ETH' | 'USDT'>('ETH');
  const [sellUnit, setSellUnit] = useState<'KIKI' | 'USDT'>('KIKI');
  
  // å¼¹çª—çŠ¶æ€
  const [showSuccessModal, setShowSuccessModal] = useState(false);

  // --- 1. è·å–æ•°æ®æº ---
  const [binanceEthPrice, setBinanceEthPrice] = useState<number>(0);
  
  useEffect(() => {
    const ws = new WebSocket('wss://stream.binance.com:9443/ws/ethusdt@trade');
    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);
      if (data.p) setBinanceEthPrice(parseFloat(data.p));
    };
    return () => ws.close();
  }, []);

  const { data: swapAmounts, refetch: refetchSwapRate } = useReadContract({
    address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'getAmountsOut',
    args: [parseEther('1'), [WETH_ADDRESS, KIKI_ADDRESS]], 
    query: { refetchInterval: 5000 } 
  });
  const kikiPerEth = swapAmounts ? parseFloat(formatEther(swapAmounts[1])) : 0;
  const realKikiUsdPrice = (binanceEthPrice > 0 && kikiPerEth > 0) ? (binanceEthPrice / kikiPerEth) : 0;

  // --- 2. Kçº¿å›¾é€»è¾‘ ---
  const chartContainerRef = useRef<HTMLDivElement>(null);
  const seriesRef = useRef<ISeriesApi<"Candlestick"> | null>(null);
  const chartDataRef = useRef<CandlestickData<Time>[]>([]);

  const saveToStorage = (data: CandlestickData<Time>[]) => {
    if (typeof window !== 'undefined') {
      const dataToSave = data.length > 500 ? data.slice(-500) : data;
      localStorage.setItem('kiki_chart_v3', JSON.stringify(dataToSave));
    }
  };

  const clearHistory = () => {
    localStorage.removeItem('kiki_chart_v3');
    window.location.reload();
  };

  // è¾…åŠ©å‡½æ•°ï¼šåŒ—äº¬æ—¶é—´æ ¼å¼åŒ–
  const formatBeijingTime = (timestamp: number) => {
    return new Date(timestamp * 1000).toLocaleTimeString('zh-CN', {
      timeZone: 'Asia/Shanghai',
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
    });
  };

  useEffect(() => {
    if (!chartContainerRef.current) return;
    
    const chart = createChart(chartContainerRef.current, {
      layout: { 
        background: { type: ColorType.Solid, color: '#0B0C10' }, // çº¯é»‘èƒŒæ™¯
        textColor: '#9CA3AF' 
      },
      grid: { 
        vertLines: { color: '#1e293b' }, 
        horzLines: { color: '#1e293b' } 
      },
      width: chartContainerRef.current.clientWidth, 
      height: 400,
      
      // âœ… 1. æœ¬åœ°åŒ–è®¾ç½®ï¼šå¼ºåˆ¶åŒ—äº¬æ—¶é—´ (åå­—å‡†æ˜Ÿæ˜¾ç¤ºçš„æ—¶é—´)
      localization: { 
        locale: 'zh-CN', 
        dateFormat: 'yyyy/MM/dd',
        timeFormatter: (time: number) => formatBeijingTime(time) 
      },
      
      // âœ… 2. æ—¶é—´è½´è®¾ç½®ï¼šå¼ºåˆ¶åŒ—äº¬æ—¶é—´ (åº•éƒ¨Xè½´åˆ»åº¦)
      timeScale: { 
        borderColor: '#334155', 
        timeVisible: true, 
        secondsVisible: false, 
        rightOffset: 12,
        tickMarkFormatter: (time: number) => formatBeijingTime(time),
      },

      rightPriceScale: { visible: true, borderColor: '#334155', textColor: '#D1D5DB', scaleMargins: { top: 0.2, bottom: 0.2 } },
      crosshair: { mode: CrosshairMode.Normal },
    });

    const candlestickSeries = chart.addSeries(CandlestickSeries, {
      upColor: '#10b981', downColor: '#ef4444', borderVisible: false, wickUpColor: '#10b981', wickDownColor: '#ef4444',
      priceFormat: { type: 'price', precision: 5, minMove: 0.00001 },
    });
    seriesRef.current = candlestickSeries;

    const handleResize = () => chart.applyOptions({ width: chartContainerRef.current?.clientWidth });
    window.addEventListener('resize', handleResize);
    return () => { window.removeEventListener('resize', handleResize); chart.remove(); };
  }, []);

  useEffect(() => {
    if (!seriesRef.current || realKikiUsdPrice === 0) return;

    if (chartDataRef.current.length === 0) {
      const savedData = localStorage.getItem('kiki_chart_v3');
      if (savedData) {
        const parsedData = JSON.parse(savedData);
        seriesRef.current.setData(parsedData);
        chartDataRef.current = parsedData;
      } else {
        const initialData: CandlestickData<Time>[] = [];
        let time = Math.floor(Date.now() / 1000) - 60 * 60; 
        for (let i = 0; i < 60; i++) {
          const base = realKikiUsdPrice;
          const volatility = base * 0.002; 
          const open = base + (Math.random() - 0.5) * volatility;
          const close = base + (Math.random() - 0.5) * volatility;
          const high = Math.max(open, close) + Math.random() * volatility * 0.5;
          const low = Math.min(open, close) - Math.random() * volatility * 0.5;
          initialData.push({ time: time as Time, open, high, low, close });
          time += 60;
        }
        initialData[initialData.length - 1].close = realKikiUsdPrice;
        seriesRef.current.setData(initialData);
        chartDataRef.current = initialData;
      }
    }

    const intervalId = setInterval(() => {
        const nowTimestamp = Math.floor(Date.now() / 1000);
        const currentCandleTime = (Math.floor(nowTimestamp / 60) * 60) as Time;
        if (chartDataRef.current.length === 0) return;
        const lastCandle = chartDataRef.current[chartDataRef.current.length - 1];
        let newDataToSave = [...chartDataRef.current];

        if (currentCandleTime > lastCandle.time) {
            const newCandle = { time: currentCandleTime, open: lastCandle.close, high: realKikiUsdPrice, low: realKikiUsdPrice, close: realKikiUsdPrice };
            seriesRef.current?.update(newCandle);
            newDataToSave.push(newCandle);
        } else {
            const updatedCandle = { ...lastCandle, high: Math.max(lastCandle.high, realKikiUsdPrice), low: Math.min(lastCandle.low, realKikiUsdPrice), close: realKikiUsdPrice };
            seriesRef.current?.update(updatedCandle);
            newDataToSave[newDataToSave.length - 1] = updatedCandle;
        }
        chartDataRef.current = newDataToSave;
        saveToStorage(newDataToSave);
    }, 1000); 

    return () => clearInterval(intervalId);
  }, [realKikiUsdPrice]);

  // --- 3. ğŸ§® äº¤æ˜“è®¡ç®— ---
  const currentUnit = tradeSide === 'buy' ? buyUnit : sellUnit;

  const txValues = useMemo(() => {
    if (!inputValue || !realKikiUsdPrice || !binanceEthPrice || !kikiPerEth) 
        return { ethToSend: 0n, kikiToSell: 0n };

    const val = parseFloat(inputValue);
    
    if (tradeSide === 'buy') {
        if (buyUnit === 'ETH') {
            return { ethToSend: parseEther(val.toFixed(18)), kikiToSell: 0n };
        } else {
            return { ethToSend: parseEther((val / binanceEthPrice).toFixed(18)), kikiToSell: 0n };
        }
    } else {
        if (sellUnit === 'KIKI') {
            return { ethToSend: 0n, kikiToSell: parseEther(val.toFixed(18)) };
        } else {
            const kikiAmt = val / realKikiUsdPrice;
            return { ethToSend: 0n, kikiToSell: parseEther(kikiAmt.toFixed(18)) };
        }
    }
  }, [inputValue, tradeSide, buyUnit, sellUnit, realKikiUsdPrice, binanceEthPrice, kikiPerEth]);

  const equalsToDisplay = useMemo(() => {
    if (!inputValue || !realKikiUsdPrice || !binanceEthPrice || !kikiPerEth) return '0.00';
    const val = parseFloat(inputValue);

    if (tradeSide === 'buy') {
        if (buyUnit === 'ETH') {
            return (val * kikiPerEth).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' KIKI';
        } else {
            const ethAmt = val / binanceEthPrice;
            return (ethAmt * kikiPerEth).toLocaleString(undefined, {maximumFractionDigits: 2}) + ' KIKI';
        }
    } else {
        if (sellUnit === 'KIKI') {
            return (val / kikiPerEth).toFixed(6) + ' ETH';
        } else {
            return (val / binanceEthPrice).toFixed(6) + ' ETH';
        }
    }
  }, [inputValue, tradeSide, buyUnit, sellUnit, realKikiUsdPrice, binanceEthPrice, kikiPerEth]);

  const { data: allowance } = useReadContract({ address: KIKI_ADDRESS, abi: tokenAbi, functionName: 'allowance', args: address ? [address, UNISWAP_ROUTER] : undefined });
  const { data: hash, writeContract, isPending } = useWriteContract();
  const { isLoading: isConfirming, isSuccess } = useWaitForTransactionReceipt({ hash });

  useEffect(() => { 
    if (isSuccess) { 
        refetchSwapRate(); 
        setInputValue(''); 
        setShowSuccessModal(true);
    } 
  }, [isSuccess]);

  const handleTrade = () => {
    if (!inputValue || !address) return;
    const deadline = BigInt(Math.floor(Date.now() / 1000) + 1200);
    
    if (tradeSide === 'buy') {
      writeContract({ 
        address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'swapExactETHForTokens', 
        args: [0n, [WETH_ADDRESS, KIKI_ADDRESS], address, deadline], 
        value: txValues.ethToSend 
      });
    } else {
      writeContract({ 
        address: UNISWAP_ROUTER, abi: routerAbi, functionName: 'swapExactTokensForETH', 
        args: [txValues.kikiToSell, 0n, [KIKI_ADDRESS, WETH_ADDRESS], address, deadline] 
      });
    }
  };
  
  const handleApprove = () => writeContract({ address: KIKI_ADDRESS, abi: tokenAbi, functionName: 'approve', args: [UNISWAP_ROUTER, parseEther('999999999')] });
  
  const toggleUnit = () => {
    if (tradeSide === 'buy') {
        setBuyUnit(prev => prev === 'ETH' ? 'USDT' : 'ETH');
    } else {
        setSellUnit(prev => prev === 'KIKI' ? 'USDT' : 'KIKI');
    }
    setInputValue(''); 
  };

  const switchSide = (side: 'buy' | 'sell') => {
      setTradeSide(side);
      setInputValue('');
  };

  return (
    <div className="grid grid-cols-1 lg:grid-cols-12 min-h-[500px] relative">
      
      {/* ğŸ”´ å…¨å±€å¼¹çª—å±‚ */}
      <AnimatePresence>
        {showSuccessModal && (
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            className="absolute inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm rounded-2xl"
          >
            <motion.div
              initial={{ scale: 0.8, opacity: 0, y: 20 }}
              animate={{ scale: 1, opacity: 1, y: 0 }}
              exit={{ scale: 0.8, opacity: 0, y: 20 }}
              className="bg-[#161A1E] border border-white/10 p-8 rounded-3xl shadow-2xl text-center max-w-sm w-full mx-4 relative"
            >
              <button onClick={() => setShowSuccessModal(false)} className="absolute top-4 right-4 text-slate-500 hover:text-white transition-colors"><X className="w-5 h-5" /></button>
              <div className="w-20 h-20 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-green-500/20">
                <Check className="w-10 h-10 text-green-500 animate-pulse" strokeWidth={3} />
              </div>
              <h3 className="text-2xl font-bold text-white mb-2">Order Filled!</h3>
              <p className="text-slate-400 text-sm mb-6">Your transaction has been successfully processed on the Sepolia network.</p>
              {hash && (
                <a href={`https://sepolia.etherscan.io/tx/${hash}`} target="_blank" rel="noopener noreferrer" className="flex items-center justify-center gap-2 text-blue-400 hover:text-blue-300 text-sm mb-6 font-mono bg-blue-500/5 py-2 rounded-lg border border-blue-500/10 hover:border-blue-500/30 transition-all">
                  View on Etherscan <ExternalLink className="w-3 h-3" />
                </a>
              )}
              <Button onClick={() => setShowSuccessModal(false)} className="w-full bg-white text-black hover:bg-slate-200 font-bold h-12 rounded-xl">Done</Button>
            </motion.div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* ğŸ“‰ å·¦ä¾§ï¼šKçº¿å›¾ */}
      <div className="lg:col-span-8 p-6 flex flex-col border-r border-white/10 relative">
        <div className="absolute inset-0 bg-[linear-gradient(to_right,#ffffff02_1px,transparent_1px),linear-gradient(to_bottom,#ffffff02_1px,transparent_1px)] bg-[size:24px_24px] pointer-events-none"></div>

        <div className="flex justify-between items-center mb-6 relative z-10">
          <div className="flex items-baseline gap-3">
            <h3 className="text-2xl font-bold text-white tracking-tight">KIKI/USDT</h3>
            <span className={`text-2xl font-mono font-bold ${realKikiUsdPrice > 0 ? 'text-green-400' : 'text-slate-600'}`}>
              ${realKikiUsdPrice > 0 ? realKikiUsdPrice.toFixed(5) : 'Loading...'}
            </span>
            <div onClick={clearHistory} className="cursor-pointer hover:bg-white/10 p-1 rounded transition-colors group" title="Reset Chart">
               <Trash2 className="w-4 h-4 text-slate-700 group-hover:text-red-500" />
            </div>
          </div>
          
          <div className="flex flex-col items-end gap-1">
             <div className="flex items-center gap-2 text-xs text-yellow-400 bg-yellow-900/10 px-2 py-1 rounded border border-yellow-500/20">
                <Zap className="w-3 h-3 animate-pulse fill-yellow-400"/> 
                <span>Binance Live: ${binanceEthPrice.toLocaleString()}</span>
             </div>
          </div>
        </div>
        
        {/* âœ… èƒŒæ™¯ä¿®å¤ï¼šä½¿ç”¨ #0B0C10 */}
        <div className="flex-1 relative w-full min-h-[350px] bg-[#0B0C10] rounded-lg border border-white/5 overflow-hidden" ref={chartContainerRef}>
           {realKikiUsdPrice === 0 && (
             <div className="absolute inset-0 flex items-center justify-center text-slate-500 text-sm gap-2">
               <Loader2 className="animate-spin text-blue-500"/> Connecting to Binance...
             </div>
           )}
        </div>
      </div>

      {/* ğŸ›’ å³ä¾§ï¼šäº¤æ˜“é¢æ¿ */}
      <div className="lg:col-span-4 p-8 bg-[#0B0C10]/30 flex flex-col justify-center">
        <div className="bg-[#1a1d26] p-1 rounded-xl flex mb-8 border border-white/5">
           <button onClick={() => switchSide('buy')} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-300 ${tradeSide === 'buy' ? 'bg-green-600 text-white shadow-lg' : 'text-slate-500 hover:text-white'}`}>Buy</button>
           <button onClick={() => switchSide('sell')} className={`flex-1 py-3 text-sm font-bold rounded-lg transition-all duration-300 ${tradeSide === 'sell' ? 'bg-red-600 text-white shadow-lg' : 'text-slate-500 hover:text-white'}`}>Sell</button>
        </div>

        <div className="space-y-6">
           <div>
             <div className="flex justify-between text-xs font-bold text-slate-500 mb-2 items-center">
               <span>{tradeSide === 'buy' ? 'PAY WITH' : 'SELL AMOUNT'}</span>
               <div onClick={toggleUnit} className="cursor-pointer text-blue-400 hover:text-blue-300 transition-colors text-[10px] bg-blue-500/10 px-2 py-1 rounded border border-blue-500/20">
                 By {currentUnit}
               </div>
             </div>
             
             <div className="relative">
                <input 
                  type="number" 
                  value={inputValue} 
                  onChange={(e) => setInputValue(e.target.value)} 
                  className="w-full bg-[#1a1d26] border border-white/5 focus:border-blue-500 rounded-xl px-4 py-5 font-mono font-bold text-white outline-none text-2xl placeholder:text-slate-700 transition-all pr-20 [appearance:textfield] [&::-webkit-outer-spin-button]:appearance-none [&::-webkit-inner-spin-button]:appearance-none" 
                  placeholder="0.00"
                />
                <div className="absolute right-4 top-1/2 -translate-y-1/2 text-xs font-bold bg-slate-800 px-2 py-1 rounded text-slate-300 pointer-events-none">
                  {currentUnit}
                </div>
             </div>

             <div className="mt-3 flex justify-between items-center px-2">
                <span className="text-xs text-slate-500">equals to</span>
                <span className="text-sm font-mono text-white flex items-center gap-1 font-bold">
                  {inputValue ? equalsToDisplay : '0.00'} 
                </span>
             </div>
           </div>

           <div className="flex items-center justify-between gap-2 p-3 bg-blue-500/10 border border-blue-500/20 rounded-lg">
              <div className="flex items-center gap-2">
                 <Wifi className="w-4 h-4 text-blue-400 shrink-0"/>
                 <span className="text-xs text-blue-300">Pegged to ETH</span>
              </div>
              <div className="text-xs text-blue-200 font-mono">
                 1 ETH â‰ˆ {binanceEthPrice.toLocaleString()} U
              </div>
           </div>

           {!isConnected ? (
             <Button className="w-full h-14 bg-slate-700">Connect Wallet</Button>
           ) : (tradeSide === 'sell' && allowance !== undefined && allowance < parseEther('1000000')) ? (
             <Button onClick={handleApprove} disabled={isPending} className="w-full h-14 bg-yellow-600 text-white font-bold rounded-xl">{isPending ? <Loader2 className="animate-spin mr-2"/> : "1. Approve KIKI"}</Button>
           ) : (
             <Button onClick={handleTrade} disabled={isPending || !inputValue} className={`w-full h-14 font-bold text-lg rounded-xl shadow-lg transition-all active:scale-95 ${tradeSide === 'buy' ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'}`}>
               {isPending ? <Loader2 className="animate-spin mr-2"/> : (tradeSide === 'buy' ? 'Confirm Buy' : 'Confirm Sell')}
             </Button>
           )}
        </div>
      </div>
    </div>
  )
}
]]>
  </file>
  <file path="components/TransferCard.tsx">
<![CDATA[
'use client';

import { useState } from 'react';
import { useSendTransaction, useWaitForTransactionReceipt } from 'wagmi';
import { parseEther } from 'viem';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Send, Loader2 } from 'lucide-react';
import { motion } from 'framer-motion';

export function TransferCard() {
  const [to, setTo] = useState('');
  const [amount, setAmount] = useState('');

  // 1. å‘é€äº¤æ˜“çš„ Hook
  const { data: hash, sendTransaction, isPending } = useSendTransaction();

  // 2. ç­‰å¾…äº¤æ˜“ç¡®è®¤çš„ Hook
  const { isLoading: isConfirming, isSuccess: isConfirmed } = 
    useWaitForTransactionReceipt({ hash });

  const handleSend = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!to || !amount) return;
    
    // è°ƒç”¨é’±åŒ…å‘èµ·äº¤æ˜“
    sendTransaction({ 
      to: to as `0x${string}`, 
      value: parseEther(amount) 
    });
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: 20 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ delay: 0.2 }}
      className="h-full"
    >
      <Card className="bg-slate-900/50 border-slate-800 text-white backdrop-blur-sm relative overflow-hidden h-full flex flex-col">
        {/* èƒŒæ™¯è£…é¥° */}
        <div className="absolute top-0 right-0 -mr-16 -mt-16 w-32 h-32 bg-green-500/10 rounded-full blur-3xl pointer-events-none"></div>

        <CardHeader>
          <CardTitle className="flex items-center gap-2 text-green-400">
            <Send className="w-5 h-5" />
            å¿«é€Ÿè½¬è´¦
          </CardTitle>
          <CardDescription className="text-slate-400">
            å‘é€ ETH åˆ°ä»»æ„é’±åŒ…åœ°å€
          </CardDescription>
        </CardHeader>
        
        <CardContent className="flex-1">
          <form onSubmit={handleSend} className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="address" className="text-slate-300">æ¥æ”¶åœ°å€</Label>
              <Input 
                id="address" 
                placeholder="0x..." 
                value={to}
                onChange={(e) => setTo(e.target.value)}
                className="bg-black/20 border-slate-700 text-white placeholder:text-slate-600 focus:border-green-500/50 transition-colors"
              />
            </div>
            
            <div className="space-y-2">
              <Label htmlFor="amount" className="text-slate-300">é‡‘é¢ (ETH)</Label>
              <Input 
                id="amount" 
                type="number" 
                step="0.0001"
                placeholder="0.01" 
                value={amount}
                onChange={(e) => setAmount(e.target.value)}
                className="bg-black/20 border-slate-700 text-white placeholder:text-slate-600 focus:border-green-500/50 transition-colors"
              />
            </div>

            <Button 
              type="submit" 
              disabled={isPending || isConfirming || !to || !amount}
              className="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-bold h-11 mt-2"
            >
              {isPending ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" /> è¯·åœ¨é’±åŒ…ç¡®è®¤...
                </>
              ) : isConfirming ? (
                <>
                  <Loader2 className="mr-2 h-4 w-4 animate-spin" /> äº¤æ˜“ç¡®è®¤ä¸­...
                </>
              ) : (
                'å‘é€äº¤æ˜“'
              )}
            </Button>

            {/* æˆåŠŸæç¤º */}
            {isConfirmed && (
              <motion.div 
                initial={{ opacity: 0, height: 0 }}
                animate={{ opacity: 1, height: 'auto' }}
                className="text-center text-sm text-green-400 mt-2 bg-green-500/10 p-2 rounded-lg border border-green-500/20"
              >
                ğŸ‰ äº¤æ˜“å·²æˆåŠŸä¸Šé“¾ï¼
              </motion.div>
            )}
            
            {/* Hash æ˜¾ç¤º */}
            {hash && (
              <div className="text-center pt-2">
                 <a 
                   href={`https://etherscan.io/tx/${hash}`} 
                   target="_blank" 
                   rel="noreferrer"
                   className="text-xs text-slate-500 hover:text-green-400 underline"
                 >
                   æŸ¥çœ‹äº¤æ˜“è¯¦æƒ…
                 </a>
              </div>
            )}

          </form>
        </CardContent>
      </Card>
    </motion.div>
  );
}
]]>
  </file>
  <file path="components/ui/alert-dialog.tsx">
<![CDATA[
"use client"

import * as React from "react"
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog"

import { cn } from "@/lib/utils"
import { buttonVariants } from "@/components/ui/button"

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  )
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  )
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className
        )}
        {...props}
      />
    </AlertDialogPortal>
  )
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  )
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className
      )}
      {...props}
    />
  )
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  )
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  )
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  )
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
}

]]>
  </file>
  <file path="components/ui/button.tsx">
<![CDATA[
import * as React from "react"
import { Slot } from "@radix-ui/react-slot"
import { cva, type VariantProps } from "class-variance-authority"

import { cn } from "@/lib/utils"

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background shadow-xs hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9",
        "icon-sm": "size-8",
        "icon-lg": "size-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
)

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean
  }) {
  const Comp = asChild ? Slot : "button"

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  )
}

export { Button, buttonVariants }

]]>
  </file>
  <file path="components/ui/card.tsx">
<![CDATA[
import * as React from "react"

import { cn } from "@/lib/utils"

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm",
        className
      )}
      {...props}
    />
  )
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className
      )}
      {...props}
    />
  )
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-title"
      className={cn("leading-none font-semibold", className)}
      {...props}
    />
  )
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  )
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className
      )}
      {...props}
    />
  )
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6", className)}
      {...props}
    />
  )
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 [.border-t]:pt-6", className)}
      {...props}
    />
  )
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
}

]]>
  </file>
  <file path="components/ui/input.tsx">
<![CDATA[
import * as React from "react"

import { cn } from "@/lib/utils"

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className
      )}
      {...props}
    />
  )
}

export { Input }

]]>
  </file>
  <file path="components/ui/label.tsx">
<![CDATA[
"use client"

import * as React from "react"
import * as LabelPrimitive from "@radix-ui/react-label"

import { cn } from "@/lib/utils"

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className
      )}
      {...props}
    />
  )
}

export { Label }

]]>
  </file>
  <file path="components/ui/progress.tsx">
<![CDATA[
"use client"

import * as React from "react"
import * as ProgressPrimitive from "@radix-ui/react-progress"

import { cn } from "@/lib/utils"

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  )
}

export { Progress }

]]>
  </file>
  <file path="components/ui/skeleton.tsx">
<![CDATA[
import { cn } from "@/lib/utils"

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  )
}

export { Skeleton }

]]>
  </file>
  <file path="components/ui/spotlight-card.tsx">
<![CDATA[
'use client';

import { useRef, useState } from 'react';

export const SpotlightCard = ({ 
  children, 
  className = "", 
  spotlightColor = "rgba(59, 130, 246, 0.25)" // é»˜è®¤è“è‰²å…‰æ™•
}: { 
  children: React.ReactNode, 
  className?: string,
  spotlightColor?: string 
}) => {
  const divRef = useRef<HTMLDivElement>(null);
  const [position, setPosition] = useState({ x: 0, y: 0 });
  const [opacity, setOpacity] = useState(0);

  const handleMouseMove = (e: React.MouseEvent<HTMLDivElement>) => {
    if (!divRef.current) return;

    const rect = divRef.current.getBoundingClientRect();
    setPosition({ x: e.clientX - rect.left, y: e.clientY - rect.top });
  };

  const handleFocus = () => {
    setOpacity(1);
  };

  const handleBlur = () => {
    setOpacity(0);
  };

  return (
    <div
      ref={divRef}
      onMouseMove={handleMouseMove}
      onMouseEnter={handleFocus}
      onMouseLeave={handleBlur}
      className={`relative overflow-hidden rounded-xl border border-white/10 bg-[#12141a] ${className}`}
    >
      {/* èšå…‰ç¯èƒŒæ™¯å±‚ (å†…éƒ¨å‘å…‰) */}
      <div
        className="pointer-events-none absolute -inset-px opacity-0 transition duration-300"
        style={{
          opacity,
          background: `radial-gradient(600px circle at ${position.x}px ${position.y}px, ${spotlightColor}, transparent 40%)`,
        }}
      />
      
      {/* èšå…‰ç¯è¾¹æ¡†å±‚ (å¤–éƒ¨æè¾¹) */}
      <div
        className="pointer-events-none absolute -inset-px opacity-0 transition duration-300"
        style={{
          opacity,
          background: `radial-gradient(600px circle at ${position.x}px ${position.y}px, ${spotlightColor}, transparent 40%)`,
          maskImage: `linear-gradient(black, black) content-box, linear-gradient(black, black)`,
          WebkitMaskComposite: 'xor',
          maskComposite: 'exclude',
        }}
      />
      
      {/* å†…å®¹å±‚ */}
      <div className="relative h-full">{children}</div>
    </div>
  );
};
]]>
  </file>
  <file path="components/ui/textarea.tsx">
<![CDATA[
import * as React from "react"

import { cn } from "@/lib/utils"

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-transparent px-3 py-2 text-base shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className
      )}
      {...props}
    />
  )
}

export { Textarea }

]]>
  </file>
  <file path="components.json">
<![CDATA[
{
  "$schema": "https://ui.shadcn.com/schema.json",
  "style": "new-york",
  "rsc": true,
  "tsx": true,
  "tailwind": {
    "config": "",
    "css": "app/globals.css",
    "baseColor": "slate",
    "cssVariables": true,
    "prefix": ""
  },
  "iconLibrary": "lucide",
  "aliases": {
    "components": "@/components",
    "utils": "@/lib/utils",
    "ui": "@/components/ui",
    "lib": "@/lib",
    "hooks": "@/hooks"
  },
  "registries": {}
}

]]>
  </file>
  <file path="lib/logger.ts">
<![CDATA[
import { supabase } from '@/lib/supabaseClient';

export type ActionType = 'MINT' | 'STAKE' | 'CLAIM' | 'TRANSFER';

interface LogParams {
  address: string;
  type: ActionType;
  details: string;
  hash?: string;
}

export const logActivity = async ({ address, type, details, hash }: LogParams) => {
  try {
    const { error } = await supabase
      .from('activity_logs')
      .insert([
        {
          wallet_address: address,
          action_type: type,
          details: details,
          tx_hash: hash,
        },
      ]);
    
    if (error) throw error;
    console.log(`[Activity Logged] ${type}: ${details}`);
  } catch (err) {
    console.error("Failed to log activity:", err);
  }
};
]]>
  </file>
  <file path="lib/supabaseClient.ts">
<![CDATA[
import { createClient } from '@supabase/supabase-js';

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;

export const supabase = createClient(supabaseUrl, supabaseKey);
]]>
  </file>
  <file path="lib/utils.ts">
<![CDATA[
import { clsx, type ClassValue } from "clsx"
import { twMerge } from "tailwind-merge"

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs))
}

]]>
  </file>
  <file path="next-env.d.ts">
<![CDATA[
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

]]>
  </file>
  <file path="next.config.ts">
<![CDATA[
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
  serverExternalPackages: ['pino', 'thread-stream'],
};

export default nextConfig;

]]>
  </file>
  <file path="package.json">
<![CDATA[
{
  "name": "nft-web",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@radix-ui/react-alert-dialog": "^1.1.15",
    "@radix-ui/react-label": "^2.1.8",
    "@radix-ui/react-progress": "^1.1.8",
    "@radix-ui/react-slot": "^1.2.4",
    "@rainbow-me/rainbowkit": "^2.2.10",
    "@supabase/supabase-js": "^2.87.1",
    "@tanstack/react-query": "^5.90.12",
    "class-variance-authority": "^0.7.1",
    "clsx": "^2.1.1",
    "ethers": "^6.16.0",
    "framer-motion": "^12.23.26",
    "lightweight-charts": "^5.0.9",
    "lucide-react": "^0.560.0",
    "next": "16.0.8",
    "react": "^18.3.1",
    "react-dom": "^18.3.1",
    "tailwind-merge": "^3.4.0",
    "viem": "^2.41.2",
    "wagmi": "^2.19.5"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.8",
    "tailwindcss": "^4",
    "tw-animate-css": "^1.4.0",
    "typescript": "^5"
  }
}

]]>
  </file>
  <file path="tsconfig.json">
<![CDATA[
{
  "compilerOptions": {
    "target": "ES2020",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

]]>
  </file>
</project_root>